# README - Migrations e Seeders

Sistema de gerenciamento de banco de dados seguindo o padr√£o Laravel.

## üìã √çndice

- [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
- [Migrations](#migrations)
- [Seeders](#seeders)
- [Como Executar](#como-executar)
- [Comandos √öteis](#comandos-√∫teis)

---

## üóÑÔ∏è Estrutura do Banco de Dados

### Sistema de Usu√°rios e Grupos (N:N)

#### `groups` (Tabela de Grupos)
- **id** - ID do grupo (PK)
- **name** - Nome do grupo
- **slug** - Slug √∫nico para URLs
- **description** - Descri√ß√£o do grupo
- **color** - Cor de identifica√ß√£o (hex)
- **icon** - √çcone Font Awesome
- **permissions** - JSON com permiss√µes
- **hierarchy_level** - N√≠vel hier√°rquico (1=maior, 99=menor)
- **is_active** - Status ativo/inativo
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

**Grupos Padr√£o:**
1. Administradores (n√≠vel 1) - Acesso total
2. Gestores (n√≠vel 2) - Aprova√ß√£o de viagens
3. Colaboradores (n√≠vel 3) - Usu√°rios padr√£o
4. Visitantes (n√≠vel 4) - Somente leitura

#### `users` (Tabela de Usu√°rios)
- **id** - ID do usu√°rio (PK)
- **name** - Nome completo
- **email** - Email √∫nico
- **cpf** - CPF √∫nico
- **phone** - Telefone
- **avatar** - URL do avatar
- **is_active** - Status ativo/inativo
- **email_verified_at** - Data de verifica√ß√£o do email
- **last_login_at** - Data do √∫ltimo login
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

#### `user_groups` (Tabela Pivot - N:N)
Relaciona usu√°rios com grupos (um usu√°rio pode ter m√∫ltiplos grupos).

- **id** - ID do v√≠nculo (PK)
- **user_id** - ID do usu√°rio (FK ‚Üí users.id)
- **group_id** - ID do grupo (FK ‚Üí groups.id)
- **created_at** - Data do v√≠nculo

**Constraints:**
- UNIQUE(user_id, group_id) - Um usu√°rio n√£o pode estar no mesmo grupo duas vezes
- CASCADE DELETE - Remove v√≠nculo ao deletar usu√°rio ou grupo

---

### Sistema de Viagens

#### `states` (Estados Brasileiros)
- **id** - ID do estado (PK)
- **name** - Nome do estado
- **uf** - Sigla (ex: RO, SP)
- **ibge_code** - C√≥digo IBGE
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

#### `cities` (Cidades)
- **id** - ID da cidade (PK)
- **name** - Nome da cidade
- **ibge_code** - C√≥digo IBGE (√∫nico)
- **state_id** - ID do estado (FK ‚Üí states.id)
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

**Dados Iniciais:**
- Estado: Rond√¥nia (RO)
- 52 cidades de Rond√¥nia com c√≥digos IBGE

#### `travels` (Viagens)
- **id** - ID da viagem (PK)
- **user_id** - ID do usu√°rio (FK ‚Üí users.id)
- **city_id** - ID da cidade destino (FK ‚Üí cities.id)
- **purpose** - Motivo da viagem
- **description** - Descri√ß√£o detalhada
- **departure_date** - Data/hora de sa√≠da
- **return_date** - Data/hora de retorno
- **status** - Status (ENUM)
- **approved_by** - ID do aprovador (FK ‚Üí users.id)
- **approved_at** - Data de aprova√ß√£o
- **notes** - Observa√ß√µes
- **admin_notes** - Notas administrativas
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

**Status Dispon√≠veis:**
- `PENDING` - Pendente de aprova√ß√£o
- `APPROVED` - Aprovada
- `IN_PROGRESS` - Em andamento
- `COMPLETED` - Conclu√≠da
- `CANCELLED` - Cancelada

---

### Sistema de Clientes e Tickets

#### `organizations` (Organiza√ß√µes do Movidesk)
- **id** - ID da organiza√ß√£o (PK, String)
- **business_name** - Nome da empresa
- **person_type** - Tipo de pessoa
- **is_active** - Status ativo/inativo
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

#### `clients` (Clientes)
- **id** - ID do cliente (PK)
- **name** - Nome do cliente
- **email** - Email
- **phone** - Telefone
- **document** - CNPJ/CPF (√∫nico)
- **organization_id** - ID da organiza√ß√£o (FK ‚Üí organizations.id)
- **address** - Endere√ßo
- **city** - Cidade
- **state** - Estado (UF)
- **zipcode** - CEP
- **billing_cycle** - Ciclo de cobran√ßa
- **billing_day** - Dia de cobran√ßa
- **created_at** - Data de cria√ß√£o
- **updated_at** - Data de atualiza√ß√£o

#### `client_organizations` (Pivot - N:N)
Relaciona clientes com organiza√ß√µes.

- **id** - ID do v√≠nculo (PK)
- **client_id** - ID do cliente (FK ‚Üí clients.id)
- **organization_id** - ID da organiza√ß√£o (FK ‚Üí organizations.id)
- **created_at** - Data do v√≠nculo

#### `tickets` (Tickets de Atendimento)
- **id** - ID do ticket (PK)
- **subject** - Assunto
- **status** - Status do ticket
- **category** - Categoria (Incidente, D√∫vida, etc)
- **service_full** - Servi√ßo completo
- **organization_name** - Nome da organiza√ß√£o
- **client_name** - Nome do cliente
- **owner_name** - Respons√°vel
- **created_by_name** - Criado por (nome)
- **created_by_email** - Criado por (email)
- **created_date** - Data de cria√ß√£o
- **resolved_in** - Data de resolu√ß√£o (encerramento do chat)
- **closed_in** - Data de fechamento oficial
- **custom_field_module** - M√≥dulo customizado
- **synced_at** - Data de sincroniza√ß√£o

#### `sync_logs` (Logs de Sincroniza√ß√£o)
- **id** - ID do log (PK)
- **sync_type** - Tipo de sincroniza√ß√£o
- **total** - Total de registros
- **synced** - Registros sincronizados
- **updated** - Registros atualizados
- **errors** - Quantidade de erros
- **synced_at** - Data da sincroniza√ß√£o

---

## üì¶ Migrations

Todas as migrations seguem o padr√£o Laravel: **uma tabela por arquivo**.

### Ordem de Execu√ß√£o:

```
001_create_groups_table.py              ‚Üí Grupos de usu√°rios
002_create_users_table.py               ‚Üí Usu√°rios
003_create_user_groups_table.py         ‚Üí Pivot users ‚Üî groups
004_create_states_table.py              ‚Üí Estados
005_create_cities_table.py              ‚Üí Cidades
006_create_travels_table.py             ‚Üí Viagens
007_create_organizations_table.py       ‚Üí Organiza√ß√µes
008_create_clients_table.py             ‚Üí Clientes
009_create_client_organizations_table.py ‚Üí Pivot clients ‚Üî organizations
010_create_sync_logs_table.py           ‚Üí Logs de sincroniza√ß√£o
011_create_tickets_table.py             ‚Üí Tickets
```

### Caracter√≠sticas:

- ‚úÖ Nomenclatura descritiva: `XXX_create_TABELA_table.py`
- ‚úÖ Prefixos num√©ricos (001-011) para ordem de execu√ß√£o
- ‚úÖ M√©todos `upgrade()` e `downgrade()` completos
- ‚úÖ Timestamps timezone-aware em todas as tabelas
- ‚úÖ √çndices criados e removidos corretamente
- ‚úÖ Foreign keys com constraints adequadas
- ‚úÖ Cascade delete nas tabelas pivot

---

## üå± Seeders

### Seeders Dispon√≠veis:

#### 1. `groups_seeder.py`
Cria 4 grupos de usu√°rios:
- Administradores (hierarquia 1)
- Gestores (hierarquia 2)
- Colaboradores (hierarquia 3)
- Visitantes (hierarquia 4)

Cada grupo possui:
- Permiss√µes JSON detalhadas
- Cor e √≠cone personalizados
- N√≠vel hier√°rquico

#### 2. `users_seeder.py`
Cria 5 usu√°rios de teste:
- 1 Administrador
- 1 Gestor
- 3 Colaboradores

**Usu√°rios criados:**
- admin@bettertech.com.br
- gestor@bettertech.com.br
- maria.silva@bettertech.com.br
- joao.santos@bettertech.com.br
- ana.costa@bettertech.com.br

**Importante:** Este seeder tamb√©m cria os v√≠nculos na tabela pivot `user_groups`.

#### 3. `cities_seeder.py`
Popula o banco com:
- Estado de Rond√¥nia (RO)
- 52 cidades de Rond√¥nia com c√≥digos IBGE

#### 4. `database_seeder.py` (Master)
Executa todos os seeders na ordem correta:
1. Groups
2. Users (+ v√≠nculos user_groups)
3. Cities

---

## üöÄ Como Executar

### 1. Resetar Banco de Dados (Opcional)

```bash
# Via SQL (pgAdmin ou psql)
DELETE FROM alembic_version;
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
```

### 2. Executar Migrations

```bash
cd C:\Python\bettertech\app-financeiro

# Verificar status atual
alembic current

# Executar todas as migrations
alembic upgrade head

# Verificar se aplicou corretamente
alembic current
# Deve mostrar: 011
```

### 3. Executar Seeders

**Op√ß√£o 1: Executar todos de uma vez (Recomendado)**
```bash
python database/seeders/database_seeder.py
```

**Op√ß√£o 2: Executar individualmente**
```bash
# Ordem obrigat√≥ria:
python database/seeders/groups_seeder.py
python database/seeders/users_seeder.py
python database/seeders/cities_seeder.py
```

### 4. Iniciar Servidor

```bash
python server.py
```

Acesse: http://127.0.0.1:5000

---

## üõ†Ô∏è Comandos √öteis

### Alembic (Migrations)

```bash
# Ver status atual
alembic current

# Ver hist√≥rico de migrations
alembic history

# Upgrade para vers√£o espec√≠fica
alembic upgrade 005

# Downgrade para vers√£o anterior
alembic downgrade -1

# Downgrade para vers√£o espec√≠fica
alembic downgrade 003

# Downgrade completo
alembic downgrade base

# Criar nova migration (apenas se necess√°rio)
alembic revision -m "descricao_da_mudanca"
```

### Verificar Banco de Dados

```sql
-- Ver todas as tabelas criadas
SELECT tablename FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;

-- Ver quantidade de registros por tabela
SELECT 'groups' as tabela, COUNT(*) FROM groups
UNION ALL
SELECT 'users', COUNT(*) FROM users
UNION ALL
SELECT 'user_groups', COUNT(*) FROM user_groups
UNION ALL
SELECT 'states', COUNT(*) FROM states
UNION ALL
SELECT 'cities', COUNT(*) FROM cities
UNION ALL
SELECT 'travels', COUNT(*) FROM travels;

-- Ver usu√°rios e seus grupos
SELECT
    u.id,
    u.name,
    u.email,
    g.name as grupo
FROM users u
JOIN user_groups ug ON u.id = ug.user_id
JOIN groups g ON ug.group_id = g.id
ORDER BY u.id;
```

---

## üìä Diagrama de Relacionamentos

```
groups ‚Üê‚Üí user_groups ‚Üê‚Üí users
                          ‚Üì
                        travels
                          ‚Üì
                        cities ‚Üí states

organizations ‚Üê‚Üí client_organizations ‚Üê‚Üí clients

tickets (independente)
sync_logs (independente)
```

---

## ‚ö†Ô∏è Observa√ß√µes Importantes

1. **Ordem de Execu√ß√£o:** Sempre execute as migrations na ordem num√©rica (001 ‚Üí 011)
2. **Seeders:** Execute os seeders AP√ìS as migrations
3. **Depend√™ncias:**
   - `users_seeder` depende de `groups_seeder`
   - `cities_seeder` cria automaticamente o estado de Rond√¥nia
4. **Tabelas Pivot:**
   - `user_groups` - Relacionamento N:N entre users e groups
   - `client_organizations` - Relacionamento N:N entre clients e organizations
5. **Timezone:** Todos os timestamps usam timezone-aware (PostgreSQL)
6. **√çndices:** Criados automaticamente em colunas √∫nicas e foreign keys
7. **Cascade Delete:** Tabelas pivot usam CASCADE ao deletar registros relacionados

---

## üìù Estrutura de Pastas

```
app-financeiro/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ versions/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001_create_groups_table.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 002_create_users_table.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 003_create_user_groups_table.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ... (at√© 011)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.py
‚îÇ   ‚îî‚îÄ‚îÄ seeders/
‚îÇ       ‚îú‚îÄ‚îÄ groups_seeder.py
‚îÇ       ‚îú‚îÄ‚îÄ users_seeder.py
‚îÇ       ‚îú‚îÄ‚îÄ cities_seeder.py
‚îÇ       ‚îî‚îÄ‚îÄ database_seeder.py
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îú‚îÄ‚îÄ group.py
‚îÇ       ‚îú‚îÄ‚îÄ user.py
‚îÇ       ‚îú‚îÄ‚îÄ user_group.py (Table pivot)
‚îÇ       ‚îú‚îÄ‚îÄ state.py
‚îÇ       ‚îú‚îÄ‚îÄ city.py
‚îÇ       ‚îú‚îÄ‚îÄ travel.py
‚îÇ       ‚îú‚îÄ‚îÄ organization.py
‚îÇ       ‚îú‚îÄ‚îÄ client.py
‚îÇ       ‚îú‚îÄ‚îÄ ticket.py
‚îÇ       ‚îî‚îÄ‚îÄ sync_log.py
‚îî‚îÄ‚îÄ README_MIGRATIONS.md (este arquivo)
```

---

## üéØ Resultado Final

Ap√≥s executar migrations e seeders:

- ‚úÖ **11 Tabelas** criadas
- ‚úÖ **4 Grupos** cadastrados
- ‚úÖ **5 Usu√°rios** cadastrados
- ‚úÖ **5 V√≠nculos** user-group criados
- ‚úÖ **1 Estado** (Rond√¥nia)
- ‚úÖ **52 Cidades** de Rond√¥nia
- ‚úÖ Sistema pronto para uso!

---

**Desenvolvido seguindo o padr√£o Laravel de migrations e seeders.**

Data: 2025-10-11
