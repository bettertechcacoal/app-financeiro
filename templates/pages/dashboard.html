{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 py-8">

    <!-- Sidebar -->
    <aside class="w-full lg:w-80 flex-shrink-0 lg:sticky lg:top-24 lg:self-start">
        <div class="space-y-6">
            
            <!-- User Profile Card -->
            <div class="relative overflow-hidden rounded-2xl shadow-lg animate-fade-in">
                <!-- Background Base -->
                <div class="absolute inset-0 bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-700"></div>

                <!-- Wavy Splash SVG Background -->
                <svg class="absolute bottom-0 left-0 w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 120" preserveAspectRatio="none">
                    <!-- Large organic wave 1 -->
                    <path d="M0,60 C80,30 120,80 200,70 C280,60 320,90 400,60 L400,120 L0,120 Z" fill="rgba(99, 102, 241, 0.4)" opacity="0.8"/>

                    <!-- Medium wave 2 -->
                    <path d="M0,75 C100,50 150,95 250,80 C320,70 360,100 400,75 L400,120 L0,120 Z" fill="rgba(139, 92, 246, 0.5)" opacity="0.7"/>

                    <!-- Small wave 3 -->
                    <path d="M0,85 C70,70 140,100 220,90 C300,80 350,105 400,90 L400,120 L0,120 Z" fill="rgba(168, 85, 247, 0.4)" opacity="0.6"/>
                </svg>

                <!-- Content -->
                <div class="relative px-5 py-5 z-10">
                    <div class="text-center">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-cloud-sun text-white text-4xl drop-shadow-lg"></i>
                        </div>
                        <div id="currentTime" class="text-3xl font-bold text-white drop-shadow-md mb-1">--:--</div>
                        <div id="currentDate" class="text-sm text-white text-opacity-90 drop-shadow"></div>
                        <div class="mt-3 flex items-center justify-center gap-2">
                            <i class="fas fa-temperature-high text-white text-opacity-80"></i>
                            <span class="text-sm text-white text-opacity-90">25°C</span>
                            <span class="mx-2 text-white text-opacity-50">•</span>
                            <i class="fas fa-tint text-white text-opacity-80"></i>
                            <span class="text-sm text-white text-opacity-90">60%</span>
                        </div>
                    </div>
                </div>

                <script>
                function updateTime() {
                    const now = new Date();
                    const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const date = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                    document.getElementById('currentTime').textContent = time;
                    document.getElementById('currentDate').textContent = date.charAt(0).toUpperCase() + date.slice(1);
                }
                updateTime();
                setInterval(updateTime, 1000);
                </script>
            </div>

            <!-- Minhas Notas (Sticky Notes) -->
            {% if 'notes_view' in user_permissions %}
            <div class="card p-6 animate-fade-in">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Minhas Notas</h3>
                    {% if 'notes_create' in user_permissions %}
                    <button onclick="openNoteModal()" class="text-blue-600 hover:text-blue-700 flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i>
                        <span class="text-sm font-semibold">Adicionar</span>
                    </button>
                    {% endif %}
                </div>

                <div class="space-y-3" id="notes-container">
                    {% if notes %}
                        {% for note in notes %}
                        {% set color_classes = {
                            'yellow': 'from-yellow-100 to-yellow-200 border-yellow-400',
                            'pink': 'from-pink-100 to-pink-200 border-pink-400',
                            'green': 'from-green-100 to-green-200 border-green-400',
                            'blue': 'from-blue-100 to-blue-200 border-blue-400',
                            'purple': 'from-purple-100 to-purple-200 border-purple-400'
                        } %}
                        {% set color_accent = {
                            'yellow': 'bg-yellow-300 text-yellow-600',
                            'pink': 'bg-pink-300 text-pink-600',
                            'green': 'bg-green-300 text-green-600',
                            'blue': 'bg-blue-300 text-blue-600',
                            'purple': 'bg-purple-300 text-purple-600'
                        } %}
                        <div class="relative p-4 bg-gradient-to-br {{ color_classes[note.color.value] }} border-l-4 rounded-sm shadow-md hover:shadow-lg transition-shadow cursor-pointer" onclick="openEditModal({{ note.id }})">
                            <div class="absolute top-0 right-4 w-16 h-6 {{ color_accent[note.color.value].split()[0] }} opacity-50 rounded-b-lg"></div>
                            <p class="text-sm font-bold text-gray-800 mb-2">{{ note.title }}</p>
                            <p class="text-xs text-gray-600">{{ note.content }}</p>
                            <div class="mt-3 flex items-center justify-between">
                                {% if note.label %}
                                <span class="text-xs text-gray-500">
                                    <i class="{{ note.icon }} mr-1"></i>{{ note.label }}
                                </span>
                                {% else %}
                                <span></span>
                                {% endif %}
                                <i class="fas fa-thumbtack {{ color_accent[note.color.value].split()[1] }}"></i>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-sticky-note text-4xl mb-3"></i>
                            <p class="text-sm">Nenhuma nota criada</p>
                        </div>
                    {% endif %}
                </div>

                {% if total_notes > 5 %}
                <a href="{{ url_for('admin.notes_list') }}" class="block w-full mt-2 text-gray-600 text-sm font-semibold py-3 hover:bg-gray-50 rounded-xl text-center transition-all border border-gray-300">
                    <i class="fas fa-list mr-2"></i>
                    Ver Todas ({{ total_notes }})
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </aside>

    <!-- Main Area -->
    <main class="flex-1">
        <div class="space-y-6">
            
            <!-- System Modules Grid -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-900">Módulos do Sistema</h2>
                    <span class="text-sm text-gray-500">Clique em um módulo para acessar</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">

                    <!-- Tickets -->
                    {% if 'tickets_view' in user_permissions %}
                    <a href="{{ url_for('admin.tickets_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-green-500 to-green-600">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Tickets</h3>
                            <p class="text-sm text-gray-600">Gestão de tickets de atendimento</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Viagens -->
                    {% if 'travels_view' in user_permissions or 'travels_view_all' in user_permissions %}
                    <a href="{{ url_for('admin.travels_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-blue-500 to-blue-600">
                                <i class="fas fa-plane-departure"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Viagens</h3>
                            <p class="text-sm text-gray-600">Agendamento e histórico de viagens</p>
                            {% if pending_travels_count > 0 and 'travels_approve' in user_permissions %}
                            <div class="module-badge">{{ pending_travels_count }}</div>
                            {% endif %}
                        </div>
                    </a>
                    {% endif %}

                    <!-- Financeiro -->
                    {% if 'financial_view' in user_permissions %}
                    <a href="{{ url_for('admin.financial_payouts_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-purple-500 to-purple-600">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Financeiro</h3>
                            <p class="text-sm text-gray-600">Prestação de Contas</p>
                            {% if pending_payouts_count > 0 %}
                            <div class="module-badge">{{ pending_payouts_count }}</div>
                            {% endif %}
                        </div>
                    </a>
                    {% endif %}

                    <!-- Clientes -->
                    {% if 'clients_view' in user_permissions %}
                    <a href="{{ url_for('admin.clients_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-orange-500 to-orange-600">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Clientes</h3>
                            <p class="text-sm text-gray-600">Cadastro e gestão de organizações</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Licenças -->
                    {% if 'licenses_view' in user_permissions %}
                    <a href="{{ url_for('admin.licenses_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-pink-500 to-pink-600">
                                <i class="fas fa-key"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Licenças</h3>
                            <p class="text-sm text-gray-600">Gerenciamento de licenças e senhas</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Veículos -->
                    {% if 'vehicles_view' in user_permissions %}
                    <a href="{{ url_for('admin.vehicles_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-cyan-500 to-cyan-600">
                                <i class="fas fa-car"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Veículos</h3>
                            <p class="text-sm text-gray-600">Gestão de frota e manutenções</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Configurações -->
                    {% if 'settings_view' in user_permissions %}
                    <a href="{{ url_for('admin.settings_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-gray-600 to-gray-700">
                                <i class="fas fa-cog"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Configurações</h3>
                            <p class="text-sm text-gray-600">Preferências e ajustes do sistema</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Permissões -->
                    {% if 'permissions_manage' in user_permissions %}
                    <a href="{{ url_for('admin.groups_permissions') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-amber-500 to-amber-600">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Permissões</h3>
                            <p class="text-sm text-gray-600">Gerenciar acessos e permissões</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Usuários -->
                    {% if 'users_view' in user_permissions %}
                    <a href="{{ url_for('admin.users_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-teal-500 to-teal-600">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Usuários</h3>
                            <p class="text-sm text-gray-600">Gestão de permissões e acessos</p>
                        </div>
                    </a>
                    {% endif %}

                    <!-- Integrations -->
                    {% if 'integrations_view' in user_permissions %}
                    <a href="{{ url_for('admin.integrations_list') }}" class="block">
                        <div class="module-card">
                            <div class="module-icon bg-gradient-to-br from-violet-500 to-violet-600">
                                <i class="fas fa-plug"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Integrações</h3>
                            <p class="text-sm text-gray-600">Conecte com outras plataformas</p>
                        </div>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal para Criar/Editar Nota -->
<div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-900">Nova Nota</h3>
            <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="noteForm" onsubmit="saveNote(event)">
            <input type="hidden" id="noteId" value="">

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Título</label>
                <input type="text" id="noteTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Conteúdo</label>
                <textarea id="noteContent" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Cor</label>
                <div class="flex gap-2">
                    <button type="button" onclick="selectColor('yellow')" class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-100 to-yellow-200 border-2 border-transparent hover:border-yellow-500" data-color="yellow"></button>
                    <button type="button" onclick="selectColor('pink')" class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-100 to-pink-200 border-2 border-transparent hover:border-pink-500" data-color="pink"></button>
                    <button type="button" onclick="selectColor('green')" class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-100 to-green-200 border-2 border-transparent hover:border-green-500" data-color="green"></button>
                    <button type="button" onclick="selectColor('blue')" class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-100 to-blue-200 border-2 border-transparent hover:border-blue-500" data-color="blue"></button>
                    <button type="button" onclick="selectColor('purple')" class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-100 to-purple-200 border-2 border-transparent hover:border-purple-500" data-color="purple"></button>
                </div>
                <input type="hidden" id="noteColor" value="yellow">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Etiqueta (opcional)</label>
                <input type="text" id="noteLabel" placeholder="Ex: Hoje, Urgente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="flex gap-3">
                <button type="button" onclick="closeNoteModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Salvar
                </button>
                <div class="relative" id="deleteContainer">
                    <button type="button" id="deleteBtn" onclick="toggleDeleteConfirm()" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                    <!-- Dropdown de confirmação -->
                    <div id="deleteConfirm" class="hidden absolute bottom-full right-0 mb-2 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-64 z-50">
                        <!-- Seta do balão -->
                        <div class="absolute top-full right-4 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-white" style="margin-top: -1px;"></div>
                        <div class="absolute top-full right-4 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-gray-200"></div>

                        <p class="text-sm font-semibold text-gray-900 mb-3">Deseja realmente excluir esta nota?</p>
                        <div class="flex gap-2">
                            <button type="button" onclick="toggleDeleteConfirm()" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="button" onclick="confirmDeleteNote()" class="flex-1 px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let selectedColor = 'yellow';

function openNoteModal() {
    document.getElementById('noteModal').classList.remove('hidden');
    document.getElementById('noteModal').classList.add('flex');
    document.getElementById('modalTitle').textContent = 'Nova Nota';
    document.getElementById('noteForm').reset();
    document.getElementById('noteId').value = '';
    document.getElementById('deleteBtn').classList.add('hidden');
    selectColor('yellow');
}

function closeNoteModal() {
    document.getElementById('noteModal').classList.add('hidden');
    document.getElementById('noteModal').classList.remove('flex');
}

function selectColor(color) {
    selectedColor = color;
    document.getElementById('noteColor').value = color;

    // Remove border de todos
    document.querySelectorAll('[data-color]').forEach(btn => {
        btn.classList.remove('border-yellow-500', 'border-pink-500', 'border-green-500', 'border-blue-500', 'border-purple-500');
        btn.classList.add('border-transparent');
    });

    // Adiciona border no selecionado
    const selectedBtn = document.querySelector(`[data-color="${color}"]`);
    selectedBtn.classList.remove('border-transparent');
    selectedBtn.classList.add(`border-${color}-500`);
}

function saveNote(event) {
    event.preventDefault();

    const noteId = document.getElementById('noteId').value;
    const data = {
        title: document.getElementById('noteTitle').value,
        content: document.getElementById('noteContent').value,
        color: document.getElementById('noteColor').value,
        label: document.getElementById('noteLabel').value,
        icon: 'fa-sticky-note'
    };

    const url = noteId ? `/admin/api/notes/${noteId}/update` : '/admin/api/notes/create';
    const method = noteId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeNoteModal();
            location.reload();
        } else {
            showToast('Erro: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar nota', 'error');
    });
}

function openEditModal(noteId) {
    fetch(`/admin/api/notes`)
        .then(response => response.json())
        .then(result => {
            const note = result.notes.find(n => n.id === noteId);
            if (note) {
                document.getElementById('noteModal').classList.remove('hidden');
                document.getElementById('noteModal').classList.add('flex');
                document.getElementById('modalTitle').textContent = 'Editar Nota';
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteContent').value = note.content;
                document.getElementById('noteLabel').value = note.label || '';
                selectColor(note.color);
                document.getElementById('deleteBtn').classList.remove('hidden');
            }
        });
}

function toggleDeleteConfirm() {
    const confirmDiv = document.getElementById('deleteConfirm');
    confirmDiv.classList.toggle('hidden');
}

function confirmDeleteNote() {
    const noteId = document.getElementById('noteId').value;

    fetch(`/admin/api/notes/${noteId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeNoteModal();
            location.reload();
        } else {
            showToast('Erro: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao excluir nota', 'error');
    });
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(event) {
    const deleteContainer = document.getElementById('deleteContainer');
    const confirmDiv = document.getElementById('deleteConfirm');

    if (deleteContainer && confirmDiv && !deleteContainer.contains(event.target)) {
        confirmDiv.classList.add('hidden');
    }
});
</script>

{% endblock %}