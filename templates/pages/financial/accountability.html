{% extends "base.html" %}
{% from "components/breadcrumbs.html" import render as breadcrumbs %}

{% block title %}Prestação de Contas{% endblock %}

{% block breadcrumbs %}
{{ breadcrumbs([
    {'name': 'Financeiro', 'url': url_for('admin.financial_payouts_list')},
    {'name': 'Prestação de Contas'}
]) }}
{% endblock %}

{% block content %}
<div class="py-8">
    <!-- Header -->
    <div class="mb-8 animate-fade-in">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
            <div class="flex items-center">
                <div class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-purple-900 to-purple-900 rounded-2xl flex items-center justify-center shadow-lg mr-4 flex-shrink-0">
                    <i class="fas fa-file-invoice-dollar text-white text-2xl sm:text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-1">Prestação de Contas</h1>
                    <p class="text-sm sm:text-base text-gray-600">Repasse #{{ payout.id }} - R$ {{ "%.2f"|format(payout.amount)|replace('.', ',') }}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="{{ url_for('admin.financial_payouts_list') }}" class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 font-semibold hover:bg-gray-50 transition-all inline-flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar
                </a>

                <!-- Dropdown Salvar - Desabilitado se já foi enviado ou aprovado -->
                <div class="relative" id="saveDropdown">
                    <button id="saveButton" type="button" class="px-6 py-3 {% if payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved'] %}bg-gray-400 cursor-not-allowed{% else %}bg-purple-900 hover:bg-purple-800{% endif %} text-white font-semibold rounded-xl transition-all inline-flex items-center shadow-md {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}hover:shadow-lg{% endif %}" {% if payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved'] %}disabled{% endif %}>
                        <i class="fas fa-save mr-2"></i>
                        Salvar
                        {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}
                        <i class="fas fa-chevron-down ml-2 text-sm"></i>
                        {% endif %}
                    </button>

                    <!-- Menu Dropdown -->
                    {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}
                    <div id="saveMenu" class="hidden absolute right-0 w-64 bg-white rounded-lg shadow-lg border border-gray-200">
                        <div class="py-2">
                            <button type="button" onclick="saveAccountability('draft'); $('#saveMenu').addClass('hidden');" class="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 transition-all flex items-center">
                                <i class="fas fa-clock text-yellow-600 mr-3"></i>
                                <span class="font-medium">Terminar depois</span>
                            </button>
                            <button type="button" onclick="saveAccountability('submitted'); $('#saveMenu').addClass('hidden');" class="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 transition-all flex items-center border-t border-gray-100">
                                <i class="fas fa-paper-plane text-purple-900 mr-3"></i>
                                <span class="font-medium">Enviar</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="animate-fade-in">
        <!-- Passo 1: Alimentação -->
        <div id="wizard-step-1" class="wizard-step-content">
            <div class="card">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-utensils text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Alimentação</h2>
                            <p class="text-sm text-gray-500">Informe as despesas com alimentação</p>
                        </div>
                    </div>
                </div>

                <!-- Wizard Steps Indicator -->
                <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center justify-center overflow-x-auto">
                        <div class="flex items-center space-x-2">
                            <!-- Step 1: Alimentação -->
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(1)"{% endif %}>
                                <div id="step-indicator-1" class="wizard-step-active flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-900">Alimentação</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <!-- Step 2: Veículo -->
                            {% if payout.travel_info and payout.travel_info.driver_user and payout.travel_info.driver_user.id == session.get('user_id') %}
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(2)"{% endif %}>
                                <div id="step-indicator-2" class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Veículo</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>
                            {% endif %}

                            <!-- Step 3: Hospedagem -->
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(3)"{% endif %}>
                                <div id="step-indicator-3" class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Hospedagem</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <!-- Step 4: Outras Despesas -->
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(4)"{% endif %}>
                                <div id="step-indicator-4" class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Outras</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <!-- Step 5: Finalizar -->
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(5)"{% endif %}>
                                <div id="step-indicator-5" class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Finalizar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Valores de Referência -->
                <div class="bg-purple-50 px-6 py-3">
                    <div class="flex gap-4 items-center">
                        <h4 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle text-purple-900 mr-1"></i>
                            Valores de Referência:
                        </h4>
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-coffee text-purple-900"></i>
                                <span class="text-gray-600">Café:</span>
                                <span class="font-bold text-purple-900">R$ 15,00</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-utensils text-purple-900"></i>
                                <span class="text-gray-600">Almoço:</span>
                                <span class="font-bold text-purple-900">R$ 50,00</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-moon text-purple-900"></i>
                                <span class="text-gray-600">Janta:</span>
                                <span class="font-bold text-purple-900">R$ 45,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="space-y-3">
                        <!-- Botão Adicionar -->
                        <div class="flex justify-end">
                            <button type="button" id="add-food-day-btn" onclick="addFoodDay()" class="px-3 py-1.5 bg-purple-900 hover:bg-purple-800 text-white text-sm font-semibold rounded transition-all inline-flex items-center">
                                <i class="fas fa-plus mr-1.5 text-xs"></i>
                                Adicionar
                            </button>
                        </div>

                        <!-- Container de Dias (linhas) -->
                        <div id="food-days-list" class="space-y-2">
                            <!-- Linhas serão adicionadas aqui -->
                        </div>

                        <!-- Total calculado -->
                        <div class="flex justify-between items-center bg-gray-50 border border-gray-300 rounded px-3 py-2">
                            <span class="text-sm font-bold text-gray-700">Total de Alimentação:</span>
                            <span id="food-total" class="text-base font-bold text-purple-900">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
                    <button type="button" onclick="nextStep()" class="px-8 py-3 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all inline-flex items-center">
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Passo 2: Veículo -->
        {% if payout.travel_info and payout.travel_info.driver_user and payout.travel_info.driver_user.id == session.get('user_id') %}
        <div id="wizard-step-2" class="wizard-step-content hidden">
            <div class="card">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-car text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Veículo</h2>
                            <p class="text-sm text-gray-500">Informe as despesas com veículo</p>
                        </div>
                    </div>
                </div>

                <!-- Wizard Steps Indicator -->
                <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center justify-center overflow-x-auto">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(1)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-900">Alimentação</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(2)"{% endif %}>
                                <div class="wizard-step-active flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Veículo</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(3)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Hospedagem</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(4)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Outras</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(5)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Finalizar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instruções para o Usuário -->
                <div class="bg-purple-50 px-6 py-3">
                    <div class="flex gap-4 items-center">
                        <h4 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle text-purple-900 mr-1"></i>
                            Instruções:
                        </h4>
                        <div class="text-sm text-gray-600">
                            <span>Clique em <strong>Adicionar</strong> para registrar cada despesa de veículo da viagem (combustível, pedágio, estacionamento, lavagem ou outras). Informe a data, tipo e valor de cada despesa.</span>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="space-y-3">
                        <!-- Km e Botão Adicionar -->
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Km (Saída):</label>
                                    <input type="text" id="km-departure" class="w-32 px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" placeholder="0">
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Km (Chegada):</label>
                                    <input type="text" id="km-arrival" class="w-32 px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" placeholder="0">
                                </div>
                            </div>
                            <button type="button" onclick="openVehicleModal()" class="px-3 py-1.5 bg-purple-900 hover:bg-purple-800 text-white text-sm font-semibold rounded transition-all inline-flex items-center">
                                <i class="fas fa-plus mr-1.5 text-xs"></i>
                                Adicionar
                            </button>
                        </div>

                        <!-- Container de Despesas (linhas) -->
                        <div id="vehicle-expenses-list" class="space-y-2">
                            <!-- Linhas serão adicionadas aqui -->
                        </div>

                        <!-- Total calculado -->
                        <div class="flex justify-between items-center bg-gray-50 border border-gray-300 rounded px-3 py-2">
                            <span class="text-sm font-bold text-gray-700">Total de Veículo:</span>
                            <span id="vehicle-total" class="text-base font-bold text-purple-900">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                    <button type="button" onclick="previousStep()" class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </button>
                    <button type="button" onclick="nextStep()" class="px-8 py-3 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all inline-flex items-center">
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Passo 3: Hospedagem -->
        <div id="wizard-step-3" class="wizard-step-content hidden">
            <div class="card">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-bed text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Hospedagem</h2>
                            <p class="text-sm text-gray-500">Informe as despesas com hospedagem</p>
                        </div>
                    </div>
                </div>

                <!-- Wizard Steps Indicator -->
                <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center justify-center overflow-x-auto">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(1)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-900">Alimentação</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(2)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Veículo</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(3)"{% endif %}>
                                <div class="wizard-step-active flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Hospedagem</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(4)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Outras</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(5)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Finalizar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instruções para o Usuário -->
                <div class="bg-purple-50 px-6 py-3">
                    <div class="flex gap-4 items-center">
                        <h4 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle text-purple-900 mr-1"></i>
                            Instruções:
                        </h4>
                        <div class="text-sm text-gray-600">
                            <span>Clique em <strong>Adicionar</strong> para registrar cada despesa de hospedagem da viagem. Informe a data e o valor de cada estadia.</span>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="space-y-3">
                        <!-- Botão Adicionar -->
                        <div class="flex justify-end">
                            <button type="button" onclick="openLodgingModal()" class="px-3 py-1.5 bg-purple-900 hover:bg-purple-800 text-white text-sm font-semibold rounded transition-all inline-flex items-center">
                                <i class="fas fa-plus mr-1.5 text-xs"></i>
                                Adicionar
                            </button>
                        </div>

                        <!-- Container de Despesas (linhas) -->
                        <div id="lodging-expenses-list" class="space-y-2">
                            <!-- Linhas serão adicionadas aqui -->
                        </div>

                        <!-- Total calculado -->
                        <div class="flex justify-between items-center bg-gray-50 border border-gray-300 rounded px-3 py-2">
                            <span class="text-sm font-bold text-gray-700">Total de Hospedagem:</span>
                            <span id="lodging-total" class="text-base font-bold text-purple-900">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                    <button type="button" onclick="previousStep()" class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </button>
                    <button type="button" onclick="nextStep()" class="px-8 py-3 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all inline-flex items-center">
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Passo 4: Outras Despesas -->
        <div id="wizard-step-4" class="wizard-step-content hidden">
            <div class="card">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-receipt text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Outras Despesas</h2>
                            <p class="text-sm text-gray-500">Informe outras despesas da viagem</p>
                        </div>
                    </div>
                </div>

                <!-- Wizard Steps Indicator -->
                <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center justify-center overflow-x-auto">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(1)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-900">Alimentação</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(2)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Veículo</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(3)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Hospedagem</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(4)"{% endif %}>
                                <div class="wizard-step-active flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Outras</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-gray-300"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(5)"{% endif %}>
                                <div class="wizard-step-inactive flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-500">Finalizar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instruções para o Usuário -->
                <div class="bg-purple-50 px-6 py-3">
                    <div class="flex gap-4 items-center">
                        <h4 class="text-sm font-bold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle text-purple-900 mr-1"></i>
                            Instruções:
                        </h4>
                        <div class="text-sm text-gray-600">
                            <span>Clique em <strong>Adicionar</strong> para registrar outras despesas da viagem que não se enquadram nas categorias anteriores. Informe a descrição, data e valor.</span>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div class="space-y-3">
                        <!-- Botão Adicionar -->
                        <div class="flex justify-end">
                            <button type="button" onclick="openOtherModal()" class="px-3 py-1.5 bg-purple-900 hover:bg-purple-800 text-white text-sm font-semibold rounded transition-all inline-flex items-center">
                                <i class="fas fa-plus mr-1.5 text-xs"></i>
                                Adicionar
                            </button>
                        </div>

                        <!-- Container de Despesas (linhas) -->
                        <div id="other-expenses-list" class="space-y-2">
                            <!-- Linhas serão adicionadas aqui -->
                        </div>

                        <!-- Total calculado -->
                        <div class="flex justify-between items-center bg-gray-50 border border-gray-300 rounded px-3 py-2">
                            <span class="text-sm font-bold text-gray-700">Total de Outras Despesas:</span>
                            <span id="other-total" class="text-base font-bold text-purple-900">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                    <button type="button" onclick="previousStep()" class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </button>
                    <button type="button" onclick="nextStep()" class="px-8 py-3 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all inline-flex items-center">
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Passo 5: Finalizar -->
        <div id="wizard-step-5" class="wizard-step-content hidden">
            <div class="card">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Finalizar Prestação de Contas</h2>
                            <p class="text-sm text-gray-500">Revise as informações e finalize</p>
                        </div>
                    </div>
                </div>

                <!-- Wizard Steps Indicator -->
                <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center justify-center overflow-x-auto">
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(1)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-sm font-semibold text-gray-900">Alimentação</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(2)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Veículo</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(3)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Hospedagem</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}cursor-pointer hover:opacity-80 transition-opacity{% else %}cursor-not-allowed opacity-50{% endif %}" {% if not (payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved']) %}onclick="goToStep(4)"{% endif %}>
                                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Outras</p>
                                </div>
                            </div>
                            <div class="w-6 h-0.5 bg-purple-900"></div>

                            <div class="flex items-center">
                                <div class="wizard-step-active flex items-center justify-center w-10 h-10 rounded-full bg-purple-900 text-white font-bold">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-2 hidden sm:block">
                                    <p class="text-xs font-semibold text-gray-900">Finalizar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Header do Resumo -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Resumo</h2>
                            <p class="text-sm text-gray-500">Confira todas as informações antes de enviar</p>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div id="summary-content" class="space-y-3 text-sm">
                        <!-- Será preenchido via JavaScript -->
                    </div>
                </div>

                <!-- Rodapé com Totais -->
                <div class="px-6 py-6 bg-gray-50 border-t border-gray-200">
                    <div class="space-y-1">
                        <div class="flex justify-between py-1">
                            <span class="font-semibold text-sm text-gray-600 uppercase">Repasse:</span>
                            <span class="font-bold text-lg text-purple-900">R$ {{ "%.2f"|format(payout.amount)|replace('.', ',') }}</span>
                        </div>
                        <div class="flex justify-between py-1" id="summary-total-despesa">
                            <span class="font-semibold text-sm text-gray-600 uppercase">Despesa:</span>
                            <span class="font-bold text-lg text-purple-900">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between py-3 border-t border-gray-300 mt-2 pt-3" id="summary-saldo-final">
                            <span class="font-bold text-base text-gray-800 uppercase">Saldo Final:</span>
                            <span class="font-bold text-xl text-purple-900">R$ {{ "%.2f"|format(payout.amount)|replace('.', ',') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Despesa de Hospedagem -->
    <div id="lodging-expense-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 animate-fade-in">
            <!-- Header do Modal -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-bed text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Adicionar Despesa de Hospedagem</h3>
                    </div>
                    <button type="button" onclick="closeLodgingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Corpo do Modal -->
            <div class="p-6 space-y-4">
                <!-- Data -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data</label>
                    <input type="date" id="modal-lodging-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <p id="lodging-date-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe a data
                    </p>
                </div>

                <!-- Valor -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Valor (R$)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">R$</span>
                        <input type="text" id="modal-lodging-amount" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" value="0,00">
                    </div>
                    <p id="lodging-amount-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe um valor maior que zero
                    </p>
                </div>

                <!-- Descrição -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Descrição (Opcional)</label>
                    <textarea id="modal-lodging-description" maxlength="100" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none" placeholder="Ex: Hotel, Pousada, Airbnb, etc."></textarea>
                    <div class="flex justify-end items-center mt-1">
                        <span id="lodging-char-counter" class="text-xs text-gray-500">0/100</span>
                    </div>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                <button type="button" onclick="closeLodgingModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                    Cancelar
                </button>
                <button type="button" onclick="confirmAddLodgingExpense()" class="px-4 py-2 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all">
                    Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Outras Despesas -->
    <div id="other-expense-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 animate-fade-in">
            <!-- Header do Modal -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-receipt text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Outras Despesas</h3>
                    </div>
                    <button type="button" onclick="closeOtherModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Corpo do Modal -->
            <div class="p-6 space-y-4">
                <!-- Data -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data</label>
                    <input type="date" id="modal-other-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <p id="other-date-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe a data
                    </p>
                </div>

                <!-- Descrição -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Descrição</label>
                    <textarea id="modal-other-description" maxlength="50" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none" placeholder="Ex: Táxi, Uber, Material de escritório, etc."></textarea>
                    <div class="flex justify-between items-center mt-1">
                        <p id="other-description-error" class="hidden text-sm text-red-600 flex items-center">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Por favor, informe a descrição
                        </p>
                        <span id="char-counter" class="text-xs text-gray-500">0/50</span>
                    </div>
                </div>

                <!-- Valor -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Valor (R$)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">R$</span>
                        <input type="text" id="modal-other-amount" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" value="0,00">
                    </div>
                    <p id="other-amount-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe um valor maior que zero
                    </p>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                <button type="button" onclick="closeOtherModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                    Cancelar
                </button>
                <button type="button" onclick="confirmAddOtherExpense()" class="px-4 py-2 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all">
                    Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Despesa de Veículo -->
    <div id="vehicle-expense-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 animate-fade-in">
            <!-- Header do Modal -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-car text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Adicionar Despesa de Veículo</h3>
                    </div>
                    <button type="button" onclick="closeVehicleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Corpo do Modal -->
            <div class="p-6 space-y-4">
                <!-- Tipo de Despesa -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Despesa</label>
                    <div class="grid grid-cols-5 gap-2">
                        <!-- Combustível -->
                        <button type="button" onclick="selectVehicleType('fuel')" id="type-btn-fuel" class="vehicle-type-btn flex flex-col items-center justify-center p-2 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all">
                            <i class="fas fa-gas-pump text-lg text-gray-600 mb-1"></i>
                            <span class="text-xs font-semibold text-gray-700">Combustível</span>
                        </button>

                        <!-- Pedágio -->
                        <button type="button" onclick="selectVehicleType('toll')" id="type-btn-toll" class="vehicle-type-btn flex flex-col items-center justify-center p-2 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all">
                            <i class="fas fa-road text-lg text-gray-600 mb-1"></i>
                            <span class="text-xs font-semibold text-gray-700">Pedágio</span>
                        </button>

                        <!-- Estacionamento -->
                        <button type="button" onclick="selectVehicleType('parking')" id="type-btn-parking" class="vehicle-type-btn flex flex-col items-center justify-center p-2 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all">
                            <i class="fas fa-parking text-lg text-gray-600 mb-1"></i>
                            <span class="text-xs font-semibold text-gray-700">Estacionar</span>
                        </button>

                        <!-- Lavagem -->
                        <button type="button" onclick="selectVehicleType('wash')" id="type-btn-wash" class="vehicle-type-btn flex flex-col items-center justify-center p-2 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all">
                            <i class="fas fa-shower text-lg text-gray-600 mb-1"></i>
                            <span class="text-xs font-semibold text-gray-700">Lavagem</span>
                        </button>

                        <!-- Outro -->
                        <button type="button" onclick="selectVehicleType('other')" id="type-btn-other" class="vehicle-type-btn flex flex-col items-center justify-center p-2 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all">
                            <i class="fas fa-receipt text-lg text-gray-600 mb-1"></i>
                            <span class="text-xs font-semibold text-gray-700">Outro</span>
                        </button>
                    </div>
                    <input type="hidden" id="modal-vehicle-type" value="">
                    <p id="type-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, selecione o tipo de despesa
                    </p>
                </div>

                <!-- Descrição (apenas quando "Outro" for selecionado) -->
                <div id="other-description-container" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Descrição da Despesa</label>
                    <input type="text" id="modal-vehicle-other-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Ex: Manutenção, Seguro, etc.">
                    <p id="description-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe a descrição da despesa
                    </p>
                </div>

                <!-- Data -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data</label>
                    <input type="date" id="modal-vehicle-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <p id="date-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe a data
                    </p>
                </div>

                <!-- Valor -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Valor (R$)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">R$</span>
                        <input type="text" id="modal-vehicle-amount" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" value="0,00">
                    </div>
                    <p id="amount-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        Por favor, informe um valor maior que zero
                    </p>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                <button type="button" onclick="closeVehicleModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                    Cancelar
                </button>
                <button type="button" onclick="confirmAddVehicleExpense()" class="px-4 py-2 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all">
                    Adicionar
                </button>
            </div>
        </div>
    </div>

    <!-- Card com JSON (visível em todas as etapas) -->
    <div class="mt-6 animate-fade-in">
        <div class="card">
            <button type="button" id="json-debug-button" onclick="toggleJsonDebug()" class="w-full p-6 border-b border-gray-200 hover:bg-gray-50 transition-colors text-left rounded-t-xl rounded-b-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-600 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-code text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Dados em JSON (Debug)</h3>
                            <p class="text-sm text-gray-500">Visualização dos dados preenchidos</p>
                        </div>
                    </div>
                    <i id="json-debug-icon" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                </div>
            </button>
            <div id="json-debug-content" class="p-6 bg-gray-900 hidden">
                <pre id="json-output" class="text-green-400 text-xs overflow-x-auto"><code>{
  "payout_id": {{ payout.id }},
  "amount": {{ payout.amount }},
  "food": {
    "amount": 0.00,
    "notes": ""
  },
  "fuel": {
    "amount": 0.00,
    "notes": ""
  },
  "lodging": {
    "amount": 0.00,
    "notes": ""
  },
  "other": {
    "amount": 0.00,
    "notes": ""
  }
}</code></pre>
            </div>
        </div>
    </div>

    <!-- Modal de Anexos -->
    <div id="attachment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 animate-fade-in">
            <!-- Header do Modal -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-paperclip text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Gerenciar Anexos</h3>
                    </div>
                    <button type="button" onclick="closeAttachmentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Corpo do Modal -->
            <div class="p-6 space-y-4">
                <!-- Upload de arquivo e separador -->
                <div id="attachment-upload-area">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition-colors cursor-pointer" onclick="document.getElementById('attachment-file-input').click()">
                        <input type="file" id="attachment-file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                        <div class="space-y-2">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                            <div>
                                <span class="text-purple-600 hover:text-purple-800 font-semibold">Clique para selecionar um arquivo</span>
                            </div>
                            <p class="text-xs text-gray-400">PDF, JPG, PNG, DOC, XLS (máx. 5MB)</p>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 mt-4"></div>
                </div>

                <!-- Lista de anexos -->
                <div id="attachment-list-section">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Anexos Adicionados</h4>
                    <div id="attachment-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Anexos serão renderizados aqui -->
                    </div>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end">
                <button type="button" onclick="closeAttachmentModal()" class="px-6 py-2 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all">
                    Concluir
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Customizar cor dos checkboxes para roxo */
    input[type="checkbox"].food-meal-checkbox {
        accent-color: #581c87; /* purple-900 */
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function() {
    let currentStep = 1;
    const totalSteps = 5;

    // Verificar se a prestação de contas já foi enviada ou aprovada (bloqueio de edição)
    {% if payout.existing_statement and payout.existing_statement.status in ['submitted', 'approved'] %}
        const IS_LOCKED = true;
    {% else %}
        const IS_LOCKED = false;
    {% endif %}

    // Verificar se o usuário logado é o solicitante (motorista)
    {% if payout.travel_info and payout.travel_info.driver_user and payout.travel_info.driver_user.id == session.get('user_id') %}
        const IS_DRIVER = true;
    {% else %}
        const IS_DRIVER = false;
    {% endif %}

    // Datas da viagem (vêm do backend via travel_info)
    {% if payout.travel_info and payout.travel_info.departure_date and payout.travel_info.return_date %}
        const TRIP_START_DATE = '{{ payout.travel_info.departure_date[:10] }}'; // Formato: YYYY-MM-DD
        const TRIP_END_DATE = '{{ payout.travel_info.return_date[:10] }}'; // Formato: YYYY-MM-DD
    {% else %}
        // Fallback para data atual se não houver informações da viagem
        const TRIP_START_DATE = new Date().toISOString().split('T')[0];
        const TRIP_END_DATE = new Date().toISOString().split('T')[0];
    {% endif %}

    // Informações da viagem
    {% if payout.travel_info %}
        const TRIP_DESTINATION = '{{ payout.travel_info.city.name if payout.travel_info.city else "Não informado" }}{% if payout.travel_info.city and payout.travel_info.city.state %} - {{ payout.travel_info.city.state.uf }}{% endif %}';
        const TRIP_PURPOSE = '{{ payout.travel_info.purpose if payout.travel_info.purpose else "Não informado" }}';
        {% if payout.travel_info.vehicle %}
            const TRIP_VEHICLE = '{{ payout.travel_info.vehicle.brand }} {{ payout.travel_info.vehicle.model }} - {{ payout.travel_info.vehicle.plate }}';
        {% else %}
            const TRIP_VEHICLE = 'Próprio';
        {% endif %}
    {% else %}
        const TRIP_DESTINATION = 'Não informado';
        const TRIP_PURPOSE = 'Não informado';
        const TRIP_VEHICLE = 'Próprio';
    {% endif %}

    // Calcular número de dias da viagem
    let TRIP_DAYS = 999; // Valor padrão alto caso as datas não estejam disponíveis
    if (TRIP_START_DATE && TRIP_END_DATE && TRIP_START_DATE !== '' && TRIP_END_DATE !== '') {
        const tripStartDate = new Date(TRIP_START_DATE + 'T00:00:00');
        const tripEndDate = new Date(TRIP_END_DATE + 'T00:00:00');
        TRIP_DAYS = Math.ceil((tripEndDate - tripStartDate) / (1000 * 60 * 60 * 24)) + 1;
    }

    // Valores parametrizados das refeições (futuramente virá do backend)
    const MEAL_PRICES = {
        breakfast: 15.00,
        lunch: 50.00,
        dinner: 45.00
    };

    // Configuração do Storage Service (será carregado dinamicamente)
    let STORAGE_BUCKET = '';
    let STORAGE_USER_ID = {{ session.get('user_id') }};
    let STORAGE_MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB padrão
    let STORAGE_CONFIGURED = false;

    // Carregar configurações do storage service
    async function loadStorageConfig() {
        try {
            const response = await fetch('/admin/api/storage/config');
            const result = await response.json();

            if (result.success) {
                STORAGE_BUCKET = result.data.bucket;
                STORAGE_USER_ID = result.data.user_id;
                STORAGE_MAX_FILE_SIZE = result.data.max_file_size;
                STORAGE_CONFIGURED = true;
            } else {
                console.error('Erro ao carregar configurações do storage:', result.message);
                showToast('Erro ao configurar storage service', 'error');
            }
        } catch (error) {
            console.error('Erro ao buscar configurações do storage:', error);
            showToast('Erro ao conectar com servidor', 'error');
        }
    }

    // Carregar configurações ao iniciar a página
    loadStorageConfig();

    // Dados da prestação de contas
    {% if payout.existing_statement and payout.existing_statement.statement_content %}
    // Carregar dados existentes
    let accountabilityData = {{ payout.existing_statement.statement_content | tojson | safe }};
    // Garantir que os valores de referência estejam atualizados
    if (!accountabilityData.food.reference_values) {
        accountabilityData.food.reference_values = {
            breakfast: MEAL_PRICES.breakfast,
            lunch: MEAL_PRICES.lunch,
            dinner: MEAL_PRICES.dinner
        };
    }
    {% else %}
    // Inicializar dados vazios
    let accountabilityData = {
        payout_id: {{ payout.id }},
        amount: {{ payout.amount }},
        food: {
            amount: 0.00,
            days_count: 0,
            days: [],
            reference_values: {
                breakfast: MEAL_PRICES.breakfast,
                lunch: MEAL_PRICES.lunch,
                dinner: MEAL_PRICES.dinner
            }
        },
        vehicle: {
            amount: 0.00,
            expenses_count: 0,
            expenses: [],
            km_start: 0,
            km_end: 0,
            km_traveled: 0
        },
        lodging: {
            amount: 0.00,
            expenses_count: 0,
            expenses: []
        },
        other: {
            amount: 0.00,
            expenses_count: 0,
            expenses: []
        }
    };
    {% endif %}

    let foodDayCounter = 0;
    let vehicleExpenseCounter = 0;
    let lodgingExpenseCounter = 0;
    let otherExpenseCounter = 0;

    // Inicializar máscara monetária
    $('.money-input').mask('#.##0,00', {
        reverse: true,
        placeholder: '0,00'
    });

    // Se já foi enviada ou aprovada, forçar ir para o step 5 (Finalizar) e bloquear navegação
    if (IS_LOCKED) {
        // Esconder todos os steps
        for (let i = 1; i <= totalSteps; i++) {
            $(`#wizard-step-${i}`).addClass('hidden');
        }
        // Mostrar apenas o step 5 (Finalizar)
        $('#wizard-step-5').removeClass('hidden');
        currentStep = 5;
        // Renderizar o resumo
        setTimeout(function() {
            renderSummary();
        }, 100);
    }

    // Função para converter valor monetário para número
    function parseMoneyValue(value) {
        return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    // ========================================
    // ARQUITETURA DE DADOS (Single Source of Truth)
    // ========================================

    /**
     * Atualiza a visualização do JSON debug
     */
    function updateJSON() {
        $('#json-output code').text(JSON.stringify(accountabilityData, null, 2));
    }

    /**
     * Renderiza toda a interface a partir do accountabilityData
     * Esta é a função principal que sincroniza o modelo com a view
     */
    function renderFromData() {

        // Limpar interface atual
        $('#food-days-list').empty();
        $('#vehicle-expenses-list').empty();
        $('#lodging-expenses-list').empty();
        $('#other-expenses-list').empty();

        // Resetar contadores
        foodDayCounter = 0;
        vehicleExpenseCounter = 0;
        lodgingExpenseCounter = 0;
        otherExpenseCounter = 0;

        // Renderizar cada seção
        renderFoodDays();
        renderVehicleExpenses();
        renderLodgingExpenses();
        renderOtherExpenses();

        // Atualizar totais e resumo
        updateTotalsDisplay();
        updateJSON();
        renderSummary();

    }

    /**
     * Renderiza os dias de alimentação a partir do accountabilityData
     */
    function renderFoodDays() {
        if (!accountabilityData.food.days || accountabilityData.food.days.length === 0) {
            return;
        }

        accountabilityData.food.days.forEach((day) => {
            foodDayCounter++;

            // Criar HTML do dia
            const rowHtml = `
                <div class="food-day-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors" data-day-id="${foodDayCounter}">
                    <!-- Data -->
                    <div class="w-36">
                        <input type="date" id="food-day-date-${foodDayCounter}" value="${day.date}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                               min="${TRIP_START_DATE}" max="${TRIP_END_DATE}">
                    </div>

                    <!-- Refeições -->
                    <div class="flex gap-4 flex-1">
                        <!-- Café -->
                        <label class="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer"
                                   data-day-id="${foodDayCounter}" data-meal="breakfast" ${day.meals.find(m => m.type === 'breakfast') ? 'checked' : ''}>
                            <span class="text-sm text-gray-700">
                                <i class="fas fa-coffee text-purple-900 text-xs"></i> Café
                            </span>
                        </label>

                        <!-- Almoço -->
                        <label class="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer"
                                   data-day-id="${foodDayCounter}" data-meal="lunch" ${day.meals.find(m => m.type === 'lunch') ? 'checked' : ''}>
                            <span class="text-sm text-gray-700">
                                <i class="fas fa-utensils text-purple-900 text-xs"></i> Almoço
                            </span>
                        </label>

                        <!-- Janta -->
                        <label class="flex items-center gap-1.5 cursor-pointer">
                            <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer"
                                   data-day-id="${foodDayCounter}" data-meal="dinner" ${day.meals.find(m => m.type === 'dinner') ? 'checked' : ''}>
                            <span class="text-sm text-gray-700">
                                <i class="fas fa-moon text-purple-900 text-xs"></i> Janta
                            </span>
                        </label>
                    </div>

                    <!-- Total do Dia -->
                    <div class="w-32 text-right">
                        <span id="day-total-${foodDayCounter}" class="font-bold text-purple-900">R$ ${day.amount.toFixed(2).replace('.', ',')}</span>
                    </div>

                    <!-- Botão Remover -->
                    <button type="button" onclick="removeFoodDayByIndex(${foodDayCounter - 1})"
                            class="text-red-600 hover:text-red-800 transition-colors" title="Remover">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `;

            $('#food-days-list').append(rowHtml);
        });

        updateAddFoodDayButton();
    }

    /**
     * Renderiza as despesas de veículo a partir do accountabilityData
     */
    function renderVehicleExpenses() {
        if (!IS_DRIVER || !accountabilityData.vehicle.expenses || accountabilityData.vehicle.expenses.length === 0) {
            return;
        }

        // Atualizar quilometragem
        if (accountabilityData.vehicle.km_start) {
            $('#km-departure').val(accountabilityData.vehicle.km_start);
        }
        if (accountabilityData.vehicle.km_end) {
            $('#km-arrival').val(accountabilityData.vehicle.km_end);
        }

        accountabilityData.vehicle.expenses.forEach((expense, index) => {
            vehicleExpenseCounter++;

            const expenseInfo = getExpenseIconAndName(expense.type, expense.name);

            const rowHtml = `
                <div class="vehicle-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                     data-expense-id="${vehicleExpenseCounter}"
                     data-type="${expense.type}"
                     data-amount="${expense.amount}"
                     data-description="${expense.name || ''}">

                    <div class="w-36">
                        <input type="date" id="vehicle-expense-date-${vehicleExpenseCounter}" value="${expense.date}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div class="flex items-center gap-2 flex-1">
                        <i class="fas ${expenseInfo.icon} text-purple-900"></i>
                        <span class="text-gray-700">${expenseInfo.name}</span>
                        ${expense.attachments && expense.attachments.length > 0 ? `
                        <button type="button" onclick="openAttachmentModal(${vehicleExpenseCounter}, 'vehicle')"
                                class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${expense.attachments.length} anexo(s)">
                            <div class="relative">
                                <i class="fas fa-paperclip text-purple-900"></i>
                                <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${expense.attachments.length}</span>
                            </div>
                            <span class="text-gray-700 text-sm">Anexos</span>
                        </button>
                        ` : `
                        <button type="button" onclick="openAttachmentModal(${vehicleExpenseCounter}, 'vehicle')"
                                class="text-purple-600 hover:text-purple-800 transition-colors ml-2" title="Adicionar anexo">
                            <i class="fas fa-paperclip"></i>
                            <span class="attachment-count-${vehicleExpenseCounter} hidden ml-1 px-2 py-0.5 bg-purple-600 text-white rounded-full text-xs">0</span>
                        </button>
                        `}
                    </div>

                    <div class="w-32 text-right">
                        <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                    </div>

                    <button type="button" onclick="removeVehicleExpenseByIndex(${index})"
                            class="text-red-600 hover:text-red-800 transition-colors" title="Remover">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `;

            $('#vehicle-expenses-list').append(rowHtml);

            // Restaurar anexos
            if (expense.attachments && expense.attachments.length > 0) {
                const attachmentKey = `vehicle-${vehicleExpenseCounter}`;
                window.expenseAttachments[attachmentKey] = expense.attachments;
            }
        });
    }

    /**
     * Renderiza as despesas de hospedagem a partir do accountabilityData
     */
    function renderLodgingExpenses() {
        if (!accountabilityData.lodging.expenses || accountabilityData.lodging.expenses.length === 0) {
            return;
        }

        accountabilityData.lodging.expenses.forEach((expense, index) => {
            lodgingExpenseCounter++;

            const rowHtml = `
                <div class="lodging-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                     data-expense-id="${lodgingExpenseCounter}"
                     data-description="${expense.description || ''}">

                    <div class="w-36">
                        <input type="date" id="lodging-expense-date-${lodgingExpenseCounter}" value="${expense.date}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div class="flex items-center gap-2 flex-1">
                        <i class="fas fa-bed text-purple-900"></i>
                        <span class="text-sm text-gray-700">Hospedagem</span>
                        ${expense.description ? `<span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-sm">${expense.description}</span>` : ''}
                        <button type="button" onclick="openAttachmentModal(${lodgingExpenseCounter}, 'lodging')"
                                class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${expense.attachments && expense.attachments.length > 0 ? expense.attachments.length + ' anexo(s)' : 'Adicionar anexo'}">
                            <div class="relative">
                                <i class="fas fa-paperclip text-purple-900"></i>
                                ${expense.attachments && expense.attachments.length > 0 ? `
                                <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${expense.attachments.length}</span>
                                ` : ''}
                            </div>
                            <span class="text-gray-700 text-sm">Anexos</span>
                        </button>
                    </div>

                    <div class="w-32 text-right">
                        <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                    </div>

                    <button type="button" onclick="removeLodgingExpenseByIndex(${index})"
                            class="text-red-600 hover:text-red-800 transition-colors" title="Remover">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `;

            $('#lodging-expenses-list').append(rowHtml);

            // Restaurar anexos
            if (expense.attachments && expense.attachments.length > 0) {
                const attachmentKey = `lodging-${lodgingExpenseCounter}`;
                window.expenseAttachments[attachmentKey] = expense.attachments;
            }
        });
    }

    /**
     * Renderiza outras despesas a partir do accountabilityData
     */
    function renderOtherExpenses() {
        if (!accountabilityData.other.expenses || accountabilityData.other.expenses.length === 0) {
            return;
        }

        accountabilityData.other.expenses.forEach((expense, index) => {
            otherExpenseCounter++;

            const rowHtml = `
                <div class="other-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                     data-expense-id="${otherExpenseCounter}">

                    <div class="w-36">
                        <input type="date" id="other-expense-date-${otherExpenseCounter}" value="${expense.date}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div class="flex items-center gap-2 flex-1">
                        <i class="fas fa-receipt text-purple-900"></i>
                        <span class="text-gray-700">${expense.name || expense.description}</span>
                        <button type="button" onclick="openAttachmentModal(${otherExpenseCounter}, 'other')"
                                class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${expense.attachments && expense.attachments.length > 0 ? expense.attachments.length + ' anexo(s)' : 'Adicionar anexo'}">
                            <div class="relative">
                                <i class="fas fa-paperclip text-purple-900"></i>
                                ${expense.attachments && expense.attachments.length > 0 ? `
                                <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${expense.attachments.length}</span>
                                ` : ''}
                            </div>
                            <span class="text-gray-700 text-sm">Anexos</span>
                        </button>
                    </div>

                    <div class="w-32 text-right">
                        <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                    </div>

                    <button type="button" onclick="removeOtherExpenseByIndex(${index})"
                            class="text-red-600 hover:text-red-800 transition-colors" title="Remover">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `;

            $('#other-expenses-list').append(rowHtml);

            // Restaurar anexos
            if (expense.attachments && expense.attachments.length > 0) {
                const attachmentKey = `other-${otherExpenseCounter}`;
                window.expenseAttachments[attachmentKey] = expense.attachments;
            }
        });
    }

    /**
     * Atualiza apenas a exibição dos totais (não recalcula)
     */
    function updateTotalsDisplay() {
        // Alimentação
        $('#food-total').text('R$ ' + accountabilityData.food.amount.toFixed(2).replace('.', ','));

        // Veículo
        if (IS_DRIVER) {
            $('#vehicle-total').text('R$ ' + accountabilityData.vehicle.amount.toFixed(2).replace('.', ','));
            if (accountabilityData.vehicle.km_traveled) {
                $('#km-traveled-display').text(accountabilityData.vehicle.km_traveled + ' km');
            }
        }

        // Hospedagem
        $('#lodging-total').text('R$ ' + accountabilityData.lodging.amount.toFixed(2).replace('.', ','));

        // Outras despesas
        $('#other-total').text('R$ ' + accountabilityData.other.amount.toFixed(2).replace('.', ','));
    }

    // ========================================
    // FUNÇÕES DE ATUALIZAÇÃO DE DADOS (Update Functions)
    // ========================================

    /**
     * Sincroniza dados do DOM para o accountabilityData
     * Esta função lê os valores da interface e atualiza o modelo
     */
    function syncDataFromDOM() {

        // Sincronizar alimentação
        syncFoodDataFromDOM();

        // Sincronizar veículo
        if (IS_DRIVER) {
            syncVehicleDataFromDOM();
        }

        // Sincronizar hospedagem
        syncLodgingDataFromDOM();

        // Sincronizar outras despesas
        syncOtherDataFromDOM();

        // Atualizar JSON e resumo
        updateJSON();
        renderSummary();

    }

    /**
     * Sincroniza dados de alimentação do DOM
     */
    function syncFoodDataFromDOM() {
        let total = 0;
        accountabilityData.food.days = [];

        $('.food-day-item').each(function() {
            const dayId = $(this).data('day-id');
            const date = $(`#food-day-date-${dayId}`).val();

            const mealsDetail = [];
            let dayTotal = 0;

            $(this).find('.food-meal-checkbox').each(function() {
                if ($(this).is(':checked')) {
                    const meal = $(this).data('meal');
                    const mealValue = MEAL_PRICES[meal];
                    dayTotal += mealValue;

                    let mealName = '';
                    if (meal === 'breakfast') mealName = 'Café';
                    else if (meal === 'lunch') mealName = 'Almoço';
                    else if (meal === 'dinner') mealName = 'Janta';

                    mealsDetail.push({
                        type: meal,
                        name: mealName,
                        value: mealValue
                    });
                }
            });

            // Atualizar total do dia no card
            $(`#day-total-${dayId}`).text('R$ ' + dayTotal.toFixed(2).replace('.', ','));

            if (date) {
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('pt-BR');

                accountabilityData.food.days.push({
                    day_number: accountabilityData.food.days.length + 1,
                    date: date,
                    date_formatted: formattedDate,
                    meals: mealsDetail,
                    meals_count: mealsDetail.length,
                    amount: dayTotal
                });
                total += dayTotal;
            }
        });

        accountabilityData.food.amount = total;
        accountabilityData.food.days_count = accountabilityData.food.days.length;
        $('#food-total').text('R$ ' + total.toFixed(2).replace('.', ','));
    }

    /**
     * Sincroniza dados de veículo do DOM
     */
    function syncVehicleDataFromDOM() {
        let total = 0;
        accountabilityData.vehicle.expenses = [];

        // Sincronizar quilometragem
        const kmStart = parseInt($('#km-departure').val()) || 0;
        const kmEnd = parseInt($('#km-arrival').val()) || 0;
        const kmTraveled = Math.max(0, kmEnd - kmStart);

        accountabilityData.vehicle.km_start = kmStart;
        accountabilityData.vehicle.km_end = kmEnd;
        accountabilityData.vehicle.km_traveled = kmTraveled;

        if (kmTraveled > 0) {
            $('#km-traveled-display').text(kmTraveled + ' km');
        }

        $('.vehicle-expense-item').each(function() {
            const expenseId = $(this).data('expense-id');
            const type = $(this).data('type');
            const date = $(`#vehicle-expense-date-${expenseId}`).val();
            const amount = parseFloat($(this).data('amount')) || 0;
            const description = $(this).data('description') || '';

            const dateObj = new Date(date + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('pt-BR');

            const expenseInfo = getExpenseIconAndName(type, description);

            // Pegar anexos desta despesa
            const attachmentKey = `vehicle-${expenseId}`;
            const attachments = window.expenseAttachments[attachmentKey] || [];

            accountabilityData.vehicle.expenses.push({
                type: type,
                name: expenseInfo.name,
                date: date,
                date_formatted: formattedDate,
                amount: amount,
                attachments: attachments,
                attachments_count: attachments.length
            });

            total += amount;
        });

        accountabilityData.vehicle.amount = total;
        accountabilityData.vehicle.expenses_count = accountabilityData.vehicle.expenses.length;
        $('#vehicle-total').text('R$ ' + total.toFixed(2).replace('.', ','));
    }

    /**
     * Sincroniza dados de hospedagem do DOM
     */
    function syncLodgingDataFromDOM() {
        let total = 0;
        accountabilityData.lodging.expenses = [];

        $('.lodging-expense-item').each(function() {
            const expenseId = $(this).data('expense-id');
            const date = $(`#lodging-expense-date-${expenseId}`).val();
            const amount = parseFloat($(this).closest('.lodging-expense-item').find('.font-bold').text().replace('R$ ', '').replace(',', '.')) || 0;
            const description = $(this).data('description') || '';

            const dateObj = new Date(date + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('pt-BR');

            // Pegar anexos desta despesa
            const attachmentKey = `lodging-${expenseId}`;
            const attachments = window.expenseAttachments[attachmentKey] || [];

            accountabilityData.lodging.expenses.push({
                name: 'Hospedagem',
                description: description,
                date: date,
                date_formatted: formattedDate,
                amount: amount,
                attachments: attachments,
                attachments_count: attachments.length
            });

            total += amount;
        });

        accountabilityData.lodging.amount = total;
        accountabilityData.lodging.expenses_count = accountabilityData.lodging.expenses.length;
        $('#lodging-total').text('R$ ' + total.toFixed(2).replace('.', ','));
    }

    /**
     * Sincroniza dados de outras despesas do DOM
     */
    function syncOtherDataFromDOM() {
        let total = 0;
        accountabilityData.other.expenses = [];

        $('.other-expense-item').each(function() {
            const expenseId = $(this).data('expense-id');
            const date = $(`#other-expense-date-${expenseId}`).val();
            const name = $(this).find('.text-gray-700').text().trim();
            const amount = parseFloat($(this).find('.font-bold').text().replace('R$ ', '').replace(',', '.')) || 0;

            const dateObj = new Date(date + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('pt-BR');

            // Pegar anexos desta despesa
            const attachmentKey = `other-${expenseId}`;
            const attachments = window.expenseAttachments[attachmentKey] || [];

            accountabilityData.other.expenses.push({
                name: name,
                description: name,
                date: date,
                date_formatted: formattedDate,
                amount: amount,
                attachments: attachments,
                attachments_count: attachments.length
            });

            total += amount;
        });

        accountabilityData.other.amount = total;
        accountabilityData.other.expenses_count = accountabilityData.other.expenses.length;
        $('#other-total').text('R$ ' + total.toFixed(2).replace('.', ','));
    }

    /**
     * Adiciona novo dia de alimentação
     */
    function addNewFoodDay() {
        const currentDaysCount = accountabilityData.food.days.length;
        if (currentDaysCount >= TRIP_DAYS) {
            return;
        }

        // Calcular próxima data
        let nextDate;
        if (currentDaysCount === 0) {
            nextDate = TRIP_START_DATE;
        } else {
            const lastDay = accountabilityData.food.days[currentDaysCount - 1];
            const date = new Date(lastDay.date + 'T00:00:00');
            date.setDate(date.getDate() + 1);
            nextDate = date.toISOString().split('T')[0];
        }

        // Adicionar ao modelo
        const dateObj = new Date(nextDate + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('pt-BR');

        accountabilityData.food.days.push({
            day_number: currentDaysCount + 1,
            date: nextDate,
            date_formatted: formattedDate,
            meals: [
                { type: 'breakfast', name: 'Café', value: MEAL_PRICES.breakfast },
                { type: 'lunch', name: 'Almoço', value: MEAL_PRICES.lunch },
                { type: 'dinner', name: 'Janta', value: MEAL_PRICES.dinner }
            ],
            meals_count: 3,
            amount: MEAL_PRICES.breakfast + MEAL_PRICES.lunch + MEAL_PRICES.dinner
        });

        // Recalcular total
        accountabilityData.food.amount = accountabilityData.food.days.reduce((sum, day) => sum + day.amount, 0);
        accountabilityData.food.days_count = accountabilityData.food.days.length;

        // Re-renderizar
        renderFromData();
    }

    /**
     * Remove dia de alimentação por índice
     */
    function removeFoodDayByIndex(index) {
        accountabilityData.food.days.splice(index, 1);

        // Recalcular total
        accountabilityData.food.amount = accountabilityData.food.days.reduce((sum, day) => sum + day.amount, 0);
        accountabilityData.food.days_count = accountabilityData.food.days.length;

        // Re-renderizar
        renderFromData();
    }

    /**
     * Remove despesa de veículo por índice
     */
    function removeVehicleExpenseByIndex(index) {
        // Remover anexos associados
        const expense = accountabilityData.vehicle.expenses[index];
        const expenseId = vehicleExpenseCounter - (accountabilityData.vehicle.expenses.length - 1 - index);
        const attachmentKey = `vehicle-${expenseId}`;
        delete window.expenseAttachments[attachmentKey];

        accountabilityData.vehicle.expenses.splice(index, 1);

        // Recalcular total
        accountabilityData.vehicle.amount = accountabilityData.vehicle.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.vehicle.expenses_count = accountabilityData.vehicle.expenses.length;

        // Re-renderizar
        renderFromData();
    }

    /**
     * Remove despesa de hospedagem por índice
     */
    function removeLodgingExpenseByIndex(index) {
        // Remover anexos associados
        const expenseId = lodgingExpenseCounter - (accountabilityData.lodging.expenses.length - 1 - index);
        const attachmentKey = `lodging-${expenseId}`;
        delete window.expenseAttachments[attachmentKey];

        accountabilityData.lodging.expenses.splice(index, 1);

        // Recalcular total
        accountabilityData.lodging.amount = accountabilityData.lodging.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.lodging.expenses_count = accountabilityData.lodging.expenses.length;

        // Re-renderizar
        renderFromData();
    }

    /**
     * Remove outras despesas por índice
     */
    function removeOtherExpenseByIndex(index) {
        // Remover anexos associados
        const expenseId = otherExpenseCounter - (accountabilityData.other.expenses.length - 1 - index);
        const attachmentKey = `other-${expenseId}`;
        delete window.expenseAttachments[attachmentKey];

        accountabilityData.other.expenses.splice(index, 1);

        // Recalcular total
        accountabilityData.other.amount = accountabilityData.other.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.other.expenses_count = accountabilityData.other.expenses.length;

        // Re-renderizar
        renderFromData();
    }

    // ========================================
    // ALIASES PARA COMPATIBILIDADE COM CÓDIGO LEGADO
    // ========================================

    // Redirecionar funções antigas para as novas
    window.calculateFoodTotal = function() {
        syncFoodDataFromDOM();
        updateJSON();
        renderSummary();
    };

    window.calculateVehicleTotal = function() {
        syncVehicleDataFromDOM();
        updateJSON();
        renderSummary();
    };

    window.calculateLodgingTotal = function() {
        syncLodgingDataFromDOM();
        updateJSON();
        renderSummary();
    };

    window.calculateOtherTotal = function() {
        syncOtherDataFromDOM();
        updateJSON();
        renderSummary();
    };

    // Expor funções globalmente
    window.addFoodDay = addNewFoodDay;
    window.removeFoodDayByIndex = removeFoodDayByIndex;
    window.removeVehicleExpenseByIndex = removeVehicleExpenseByIndex;
    window.removeLodgingExpenseByIndex = removeLodgingExpenseByIndex;
    window.removeOtherExpenseByIndex = removeOtherExpenseByIndex;

    // Função para expandir/colapsar seção JSON Debug
    window.toggleJsonDebug = function() {
        const content = $('#json-debug-content');
        const icon = $('#json-debug-icon');
        const button = $('#json-debug-button');

        if (content.hasClass('hidden')) {
            // Expandir
            content.removeClass('hidden');
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            button.removeClass('rounded-b-xl');
        } else {
            // Colapsar
            content.addClass('hidden');
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            button.addClass('rounded-b-xl');
        }
    };

    // Função para verificar e atualizar estado do botão Adicionar
    function updateAddFoodDayButton() {
        const currentDaysCount = $('.food-day-item').length;
        if (currentDaysCount >= TRIP_DAYS) {
            $('#add-food-day-btn').prop('disabled', true).addClass('opacity-50 cursor-not-allowed').removeClass('hover:bg-purple-800');
        } else {
            $('#add-food-day-btn').prop('disabled', false).removeClass('opacity-50 cursor-not-allowed').addClass('hover:bg-purple-800');
        }
    }

    // Função para adicionar dia de alimentação
    window.addFoodDay = function() {
        // Verificar se já atingiu o número máximo de dias
        const currentDaysCount = $('.food-day-item').length;
        if (currentDaysCount >= TRIP_DAYS) {
            return; // Não adicionar mais dias
        }

        foodDayCounter++;

        // Pegar a próxima data sequencial da viagem
        let nextDate;
        if (foodDayCounter === 1) {
            // Primeira vez, usar data de saída da viagem
            nextDate = TRIP_START_DATE;
        } else {
            // Pegar a data do último dia adicionado e incrementar
            const lastDayId = foodDayCounter - 1;
            const lastDate = $(`#food-day-date-${lastDayId}`).val();

            if (lastDate) {
                // Adicionar 1 dia à última data
                const date = new Date(lastDate + 'T00:00:00');
                date.setDate(date.getDate() + 1);
                nextDate = date.toISOString().split('T')[0];
            } else {
                // Fallback para data de início da viagem
                nextDate = TRIP_START_DATE;
            }
        }

        const rowHtml = `
            <div class="food-day-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors" data-day-id="${foodDayCounter}">
                <!-- Data -->
                <div class="w-36">
                    <input type="date" id="food-day-date-${foodDayCounter}" class="food-day-date w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" value="${nextDate}">
                </div>

                <!-- Café -->
                <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer" data-day-id="${foodDayCounter}" data-meal="breakfast" onchange="calculateFoodTotal()" checked>
                    <span class="text-sm text-gray-700">
                        <i class="fas fa-coffee text-purple-900 text-xs"></i> Café
                    </span>
                </label>

                <!-- Almoço -->
                <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer" data-day-id="${foodDayCounter}" data-meal="lunch" onchange="calculateFoodTotal()" checked>
                    <span class="text-sm text-gray-700">
                        <i class="fas fa-utensils text-purple-900 text-xs"></i> Almoço
                    </span>
                </label>

                <!-- Janta -->
                <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" class="food-meal-checkbox w-4 h-4 text-purple-900 border-gray-300 rounded focus:ring-purple-500 cursor-pointer" data-day-id="${foodDayCounter}" data-meal="dinner" onchange="calculateFoodTotal()" checked>
                    <span class="text-sm text-gray-700">
                        <i class="fas fa-moon text-purple-900 text-xs"></i> Janta
                    </span>
                </label>

                <!-- Total do Dia -->
                <div class="flex-1 text-right">
                    <span class="text-xs text-gray-600">Total:</span>
                    <span id="day-total-${foodDayCounter}" class="ml-2 text-sm font-bold text-purple-900">R$ 0,00</span>
                </div>

                <!-- Botão Excluir -->
                <button type="button" onclick="removeFoodDay(${foodDayCounter})" class="text-red-600 hover:text-red-800 transition-colors">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
        `;

        $('#food-days-list').append(rowHtml);

        // Adicionar listener para a mudança de data
        $(`#food-day-date-${foodDayCounter}`).on('change', function() {
            calculateFoodTotal();
        });

        calculateFoodTotal();
        updateAddFoodDayButton();
    };

    // Função para remover dia de alimentação
    window.removeFoodDay = function(dayId) {
        $(`.food-day-item[data-day-id="${dayId}"]`).remove();
        calculateFoodTotal();
        updateAddFoodDayButton();
    };


    // Função para obter ícone e nome da despesa
    function getExpenseIconAndName(type, customDescription) {
        const types = {
            fuel: { icon: 'fa-gas-pump', name: 'Combustível' },
            toll: { icon: 'fa-road', name: 'Pedágio' },
            parking: { icon: 'fa-parking', name: 'Estacionamento' },
            wash: { icon: 'fa-shower', name: 'Lavagem' },
            other: { icon: 'fa-receipt', name: customDescription || 'Outro' }
        };
        return types[type] || types.other;
    }

    // Função para selecionar tipo de despesa de veículo
    window.selectVehicleType = function(type) {
        // Remover seleção de todos os botões
        $('.vehicle-type-btn').removeClass('border-purple-900 bg-purple-100').addClass('border-gray-300');
        $('.vehicle-type-btn i').removeClass('text-purple-900').addClass('text-gray-600');
        $('.vehicle-type-btn span').removeClass('text-purple-900').addClass('text-gray-700');

        // Adicionar seleção ao botão clicado
        $(`#type-btn-${type}`).removeClass('border-gray-300').addClass('border-purple-900 bg-purple-100');
        $(`#type-btn-${type} i`).removeClass('text-gray-600').addClass('text-purple-900');
        $(`#type-btn-${type} span`).removeClass('text-gray-700').addClass('text-purple-900');

        // Definir valor no input hidden
        $('#modal-vehicle-type').val(type);

        // Limpar erro de tipo se houver
        $('#type-error').addClass('hidden');

        // Mostrar/esconder campo de descrição
        if (type === 'other') {
            $('#other-description-container').removeClass('hidden');
            $('#modal-vehicle-other-description').focus();
        } else {
            $('#other-description-container').addClass('hidden');
        }
    };

    // Limpar erro de descrição quando o usuário digitar
    $(document).on('input', '#modal-vehicle-other-description', function() {
        if ($(this).val().trim()) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#description-error').addClass('hidden');
        }
    });

    // Limpar erro de data quando o usuário selecionar
    $(document).on('change', '#modal-vehicle-date', function() {
        if ($(this).val()) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#date-error').addClass('hidden');
        }
    });

    // Limpar erro de valor quando o usuário digitar
    $(document).on('input', '#modal-vehicle-amount', function() {
        const amount = parseMoneyValue($(this).val());
        if (amount > 0) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#amount-error').addClass('hidden');
        }
    });

    // Função para limpar todos os erros de validação
    function clearValidationErrors() {
        // Esconder todas as mensagens de erro
        $('#type-error, #description-error, #date-error, #amount-error').addClass('hidden');

        // Remover bordas vermelhas dos inputs
        $('#modal-vehicle-date').removeClass('border-red-500').addClass('border-gray-300');
        $('#modal-vehicle-other-description').removeClass('border-red-500').addClass('border-gray-300');
        $('#modal-vehicle-amount').removeClass('border-red-500').addClass('border-gray-300');
    }

    // Função para abrir modal de despesa de veículo
    window.openVehicleModal = function() {
        // Definir data padrão (hoje)
        const today = new Date().toISOString().split('T')[0];
        $('#modal-vehicle-date').val(today);

        // Resetar campos
        $('#modal-vehicle-type').val('');
        $('#modal-vehicle-amount').val('0,00');
        $('#modal-vehicle-other-description').val('');
        $('#other-description-container').addClass('hidden');

        // Limpar erros de validação
        clearValidationErrors();

        // Resetar seleção de botões
        $('.vehicle-type-btn').removeClass('border-purple-900 bg-purple-100').addClass('border-gray-300');
        $('.vehicle-type-btn i').removeClass('text-purple-900').addClass('text-gray-600');
        $('.vehicle-type-btn span').removeClass('text-purple-900').addClass('text-gray-700');

        // Aplicar máscara monetária no campo de valor
        $('#modal-vehicle-amount').mask('#.##0,00', {
            reverse: true,
            placeholder: '0,00'
        });

        // Mostrar modal
        $('#vehicle-expense-modal').removeClass('hidden');
    };

    // Função para fechar modal
    window.closeVehicleModal = function() {
        $('#vehicle-expense-modal').addClass('hidden');
    };

    // Variável para controlar se o mousedown aconteceu no overlay
    let mouseDownOnOverlay = false;

    // Detectar mousedown no overlay
    $('#vehicle-expense-modal').on('mousedown', function(e) {
        if (e.target.id === 'vehicle-expense-modal') {
            mouseDownOnOverlay = true;
        } else {
            mouseDownOnOverlay = false;
        }
    });

    // Fechar modal ao clicar fora dele (apenas se mousedown também foi no overlay)
    $('#vehicle-expense-modal').on('click', function(e) {
        if (e.target.id === 'vehicle-expense-modal' && mouseDownOnOverlay) {
            closeVehicleModal();
        }
    });

    // Fechar modal com ESC
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && !$('#vehicle-expense-modal').hasClass('hidden')) {
            closeVehicleModal();
        }
    });

    // Função para confirmar adição de despesa
    window.confirmAddVehicleExpense = function() {
        // Limpar erros anteriores
        clearValidationErrors();

        const date = $('#modal-vehicle-date').val();
        const type = $('#modal-vehicle-type').val();
        const amount = parseMoneyValue($('#modal-vehicle-amount').val());
        const customDescription = $('#modal-vehicle-other-description').val().trim();

        let hasError = false;

        // Validar data
        if (!date) {
            $('#modal-vehicle-date').removeClass('border-gray-300').addClass('border-red-500');
            $('#date-error').removeClass('hidden');
            hasError = true;
        }

        // Validar tipo
        if (!type) {
            $('#type-error').removeClass('hidden');
            hasError = true;
        }

        // Validar descrição se tipo for "outro"
        if (type === 'other' && !customDescription) {
            $('#modal-vehicle-other-description').removeClass('border-gray-300').addClass('border-red-500');
            $('#description-error').removeClass('hidden');
            hasError = true;
        }

        // Validar valor
        if (amount <= 0) {
            $('#modal-vehicle-amount').removeClass('border-gray-300').addClass('border-red-500');
            $('#amount-error').removeClass('hidden');
            hasError = true;
        }

        // Se houver erros, interromper
        if (hasError) {
            return;
        }

        // Adicionar despesa diretamente ao modelo
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('pt-BR');
        const expenseInfo = getExpenseIconAndName(type, customDescription);

        accountabilityData.vehicle.expenses.push({
            type: type,
            name: expenseInfo.name,
            date: date,
            date_formatted: formattedDate,
            amount: amount,
            attachments: [],
            attachments_count: 0
        });

        // Recalcular total
        accountabilityData.vehicle.amount = accountabilityData.vehicle.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.vehicle.expenses_count = accountabilityData.vehicle.expenses.length;

        // Re-renderizar interface
        renderFromData();

        // Fechar modal
        closeVehicleModal();
    };

    // Função para adicionar linha de despesa de veículo
    function addVehicleExpenseRow(date, type, amount, customDescription, skipCalculate = false) {
        vehicleExpenseCounter++;

        const expenseInfo = getExpenseIconAndName(type, customDescription);

        const rowHtml = `
            <div class="vehicle-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                 data-expense-id="${vehicleExpenseCounter}"
                 data-type="${type}"
                 data-amount="${amount}"
                 data-custom-description="${customDescription || ''}">
                <!-- Data -->
                <div class="w-36">
                    <input type="date" id="vehicle-expense-date-${vehicleExpenseCounter}" class="vehicle-expense-date w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" value="${date}">
                </div>

                <!-- Tipo de Despesa -->
                <div class="flex items-center gap-2 flex-1">
                    <i class="fas ${expenseInfo.icon} text-purple-900 text-xs"></i>
                    <span class="text-sm text-gray-700">${expenseInfo.name}</span>
                </div>

                <!-- Valor -->
                <div class="text-right">
                    <span class="text-sm font-bold text-purple-900">R$ ${amount.toFixed(2).replace('.', ',')}</span>
                </div>

                <!-- Botão Anexos -->
                <button type="button" onclick="openAttachmentModal(${vehicleExpenseCounter}, 'vehicle')" class="text-purple-600 hover:text-purple-800 transition-colors relative" title="Anexos">
                    <i class="fas fa-paperclip text-xs"></i>
                    <span class="attachment-count-${vehicleExpenseCounter} hidden absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">0</span>
                </button>

                <!-- Botão Excluir -->
                <button type="button" onclick="removeVehicleExpense(${vehicleExpenseCounter})" class="text-red-600 hover:text-red-800 transition-colors" title="Excluir">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
        `;

        $('#vehicle-expenses-list').append(rowHtml);

        // Adicionar listener para mudança de data
        $(`#vehicle-expense-date-${vehicleExpenseCounter}`).on('change', function() {
            calculateVehicleTotal();
        });

        if (!skipCalculate) {
            calculateVehicleTotal();
        }

        return vehicleExpenseCounter;
    }

    // Função para remover despesa de veículo
    window.removeVehicleExpense = function(expenseId) {
        $(`.vehicle-expense-item[data-expense-id="${expenseId}"]`).remove();
        calculateVehicleTotal();
    };

    // ==================== FUNÇÕES DE ANEXOS ====================

    // Armazenar anexos de cada despesa
    window.expenseAttachments = {};

    // Abrir modal de anexos
    window.openAttachmentModal = function(expenseId, expenseType, viewOnly = false) {
        window.currentAttachmentExpense = { id: expenseId, type: expenseType };

        // Inicializar array de anexos se não existir
        const key = `${expenseType}-${expenseId}`;
        if (!window.expenseAttachments[key]) {
            window.expenseAttachments[key] = [];
        }

        // Renderizar lista de anexos
        renderAttachmentList(key, viewOnly);

        // Mostrar/ocultar área de upload baseado no modo
        if (viewOnly) {
            $('#attachment-upload-area').addClass('hidden');
            $('#attachment-modal h3').text('Visualizar Anexos');
        } else {
            $('#attachment-upload-area').removeClass('hidden');
            $('#attachment-modal h3').text('Gerenciar Anexos');

            // Adicionar listener para upload automático
            const fileInput = document.getElementById('attachment-file-input');
            fileInput.value = ''; // Limpar input anterior

            // Remover listeners anteriores
            $('#attachment-file-input').off('change');

            // Adicionar novo listener
            $('#attachment-file-input').on('change', function() {
                if (this.files.length > 0) {
                    addAttachment();
                }
            });
        }

        // Mostrar modal
        $('#attachment-modal').removeClass('hidden');
    };

    // Abrir modal de anexos a partir do resumo (somente visualização)
    window.openAttachmentModalFromSummary = function(expenseType, expenseIndex) {
        // Encontrar o expense ID correto baseado no índice
        let expenseId = null;

        // Procurar na lista renderizada para encontrar o expense-id correto
        if (expenseType === 'vehicle') {
            const items = $('.vehicle-expense-item');
            items.each(function(idx) {
                const expense = accountabilityData.vehicle.expenses[idx];
                if (accountabilityData.vehicle.expenses.indexOf(expense) === expenseIndex) {
                    expenseId = $(this).data('expense-id');
                    return false; // break
                }
            });
        } else if (expenseType === 'lodging') {
            const items = $('.lodging-expense-item');
            items.each(function(idx) {
                const expense = accountabilityData.lodging.expenses[idx];
                if (accountabilityData.lodging.expenses.indexOf(expense) === expenseIndex) {
                    expenseId = $(this).data('expense-id');
                    return false; // break
                }
            });
        } else if (expenseType === 'other') {
            const items = $('.other-expense-item');
            items.each(function(idx) {
                const expense = accountabilityData.other.expenses[idx];
                if (accountabilityData.other.expenses.indexOf(expense) === expenseIndex) {
                    expenseId = $(this).data('expense-id');
                    return false; // break
                }
            });
        }

        if (expenseId) {
            // Abrir modal em modo somente visualização
            openAttachmentModal(expenseId, expenseType, true);
        }
    };

    // Fechar modal de anexos
    window.closeAttachmentModal = function() {
        $('#attachment-modal').addClass('hidden');
        window.currentAttachmentExpense = null;
    };

    // Adicionar anexo
    window.addAttachment = async function() {
        const fileInput = document.getElementById('attachment-file-input');
        const file = fileInput.files[0];

        if (!file) {
            showToast('Selecione um arquivo', 'error');
            return;
        }

        // Validar se storage service está configurado
        if (!STORAGE_CONFIGURED) {
            showToast('Storage service não configurado. Aguarde...', 'warning');
            fileInput.value = '';
            return;
        }

        // Validar tamanho do arquivo
        if (file.size > STORAGE_MAX_FILE_SIZE) {
            const sizeMB = (STORAGE_MAX_FILE_SIZE / (1024 * 1024)).toFixed(0);
            showToast(`Arquivo muito grande. Máximo: ${sizeMB}MB`, 'error');
            fileInput.value = '';
            return;
        }

        const key = `${window.currentAttachmentExpense.type}-${window.currentAttachmentExpense.id}`;

        // Mostrar loading
        showToast('Enviando arquivo...', 'info');

        // Adicionar placeholder enquanto faz upload
        const tempId = Date.now();
        const tempAttachment = {
            id: tempId,
            name: file.name,
            size: file.size,
            type: file.type,
            uploading: true
        };

        window.expenseAttachments[key].push(tempAttachment);
        renderAttachmentList(key);

        try {
            // Fazer upload via rota intermediária do app-financeiro
            const formData = new FormData();
            formData.append('file', file);
            formData.append('expense_type', window.currentAttachmentExpense.type);
            formData.append('expense_id', window.currentAttachmentExpense.id);
            formData.append('payout_id', {{ payout.id }});

            const response = await fetch('/admin/api/storage/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Remover placeholder
                const index = window.expenseAttachments[key].findIndex(a => a.id === tempId);
                if (index !== -1) {
                    window.expenseAttachments[key].splice(index, 1);
                }

                // Adicionar com dados reais do storage-service
                const attachment = {
                    id: result.data.id,
                    uuid: result.data.uuid,
                    name: result.data.filename,
                    size: result.data.size,
                    type: result.data.mime_type,
                    hash_md5: result.data.hash_md5,
                    hash_sha256: result.data.hash_sha256,
                    path: result.data.path,
                    created_at: result.data.created_at,
                    download_url: `/admin/api/storage/${result.data.uuid}`
                };

                window.expenseAttachments[key].push(attachment);
                renderAttachmentList(key);
                updateAttachmentCount(window.currentAttachmentExpense.id);

                // Limpar input
                fileInput.value = '';

                // Atualizar JSON recalculando os totais
                // Isso garante que os anexos sejam incluídos no JSON
                if (window.currentAttachmentExpense.type === 'vehicle') {
                    calculateVehicleTotal();
                } else if (window.currentAttachmentExpense.type === 'lodging') {
                    calculateLodgingTotal();
                } else if (window.currentAttachmentExpense.type === 'other') {
                    calculateOtherTotal();
                }

                // Atualizar resumo para mostrar badge de anexos
                renderSummary();

                showToast('Anexo enviado com sucesso!', 'success');
            } else {
                throw new Error(result.message || 'Erro ao enviar arquivo');
            }
        } catch (error) {
            console.error('Erro ao fazer upload:', error);

            // Remover placeholder em caso de erro
            const index = window.expenseAttachments[key].findIndex(a => a.id === tempId);
            if (index !== -1) {
                window.expenseAttachments[key].splice(index, 1);
            }
            renderAttachmentList(key);

            showToast('Erro ao enviar arquivo: ' + error.message, 'error');

            // Limpar input
            fileInput.value = '';
        }
    };

    // Remover anexo
    window.removeAttachment = async function(attachmentIdentifier) {
        const key = `${window.currentAttachmentExpense.type}-${window.currentAttachmentExpense.id}`;

        // Encontrar o anexo pelo UUID ou ID
        const attachment = window.expenseAttachments[key].find(a =>
            a.uuid === attachmentIdentifier || a.id == attachmentIdentifier
        );

        if (!attachment) {
            showToast('Anexo não encontrado', 'error');
            return;
        }

        // Confirmar remoção
        if (!confirm('Deseja realmente remover este anexo?')) {
            return;
        }

        // Se tiver UUID, deletar do storage-service
        if (attachment.uuid) {
            try {
                const response = await fetch(`/admin/api/storage/${attachment.uuid}/delete`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    console.error('Erro ao deletar do storage:', result.message);
                    showToast('Erro ao remover anexo do servidor', 'error');
                    return;
                }
            } catch (error) {
                console.error('Erro ao deletar anexo:', error);
                showToast('Erro ao remover anexo', 'error');
                return;
            }
        }

        // Remover da lista local
        window.expenseAttachments[key] = window.expenseAttachments[key].filter(a =>
            a.uuid !== attachmentIdentifier && a.id != attachmentIdentifier
        );

        renderAttachmentList(key);
        updateAttachmentCount(window.currentAttachmentExpense.id);

        // Atualizar JSON recalculando os totais
        if (window.currentAttachmentExpense.type === 'vehicle') {
            calculateVehicleTotal();
        } else if (window.currentAttachmentExpense.type === 'lodging') {
            calculateLodgingTotal();
        } else if (window.currentAttachmentExpense.type === 'other') {
            calculateOtherTotal();
        }

        // Atualizar resumo para mostrar badge de anexos
        renderSummary();

        showToast('Anexo removido com sucesso', 'success');
    };

    // Visualizar anexo em nova aba
    window.viewAttachment = async function(uuid) {
        try {
            showToast('Carregando arquivo...', 'info');

            // Fazer requisição para baixar o arquivo como blob
            const response = await fetch(`/admin/api/storage/${uuid}/view`);

            if (!response.ok) {
                throw new Error('Erro ao carregar arquivo');
            }

            // Obter o blob
            const blob = await response.blob();

            // Obter o tipo MIME do header ou do blob
            const contentType = response.headers.get('Content-Type') || blob.type;

            // Obter o nome do arquivo do header Content-Disposition
            let filename = 'arquivo';
            const contentDisposition = response.headers.get('Content-Disposition');
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }

            // Criar URL do blob
            const blobUrl = URL.createObjectURL(blob);

            // Abrir em nova aba
            const newWindow = window.open(blobUrl, '_blank');

            if (!newWindow) {
                showToast('Popup bloqueado! Permita popups para visualizar o arquivo', 'warning');
                // Fallback: fazer download
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                // Definir título da janela com o nome do arquivo
                newWindow.document.title = filename;
            }

            // Limpar a URL do blob após 1 minuto (para liberar memória)
            setTimeout(() => {
                URL.revokeObjectURL(blobUrl);
            }, 60000);

            showToast('Arquivo carregado com sucesso', 'success');
        } catch (error) {
            console.error('Erro ao visualizar anexo:', error);
            showToast('Erro ao carregar arquivo: ' + error.message, 'error');
        }
    };

    // Baixar anexo
    window.downloadAttachment = async function(uuid, filename) {
        try {
            showToast('Baixando arquivo...', 'info');

            // Fazer requisição para baixar o arquivo como blob
            const response = await fetch(`/admin/api/storage/${uuid}/view`);

            if (!response.ok) {
                throw new Error('Erro ao baixar arquivo');
            }

            // Obter o blob
            const blob = await response.blob();

            // Obter o nome do arquivo do header Content-Disposition se não foi passado
            if (!filename || filename === 'undefined') {
                filename = 'arquivo';
                const contentDisposition = response.headers.get('Content-Disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
            }

            // Criar URL do blob
            const blobUrl = URL.createObjectURL(blob);

            // Criar elemento <a> temporário e simular clique para download
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Limpar a URL do blob após download
            setTimeout(() => {
                URL.revokeObjectURL(blobUrl);
            }, 1000);

            showToast('Download iniciado com sucesso', 'success');
        } catch (error) {
            console.error('Erro ao baixar anexo:', error);
            showToast('Erro ao baixar arquivo: ' + error.message, 'error');
        }
    };

    // Renderizar lista de anexos
    function renderAttachmentList(key, viewOnly = false) {
        const attachments = window.expenseAttachments[key] || [];
        const container = $('#attachment-list');

        if (attachments.length === 0) {
            container.html(`
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-paperclip text-4xl mb-2"></i>
                    <p class="text-sm">Nenhum anexo adicionado</p>
                </div>
            `);
            return;
        }

        let html = '';
        attachments.forEach(att => {
            const sizeKB = (att.size / 1024).toFixed(1);
            const fileType = att.type || att.mime_type;
            const fileName = att.name || att.filename || 'Arquivo sem nome';
            const icon = getFileIcon(fileType);

            if (att.uploading) {
                // Mostrar estado de upload
                html += `
                    <div class="flex items-center gap-3 p-3 bg-blue-50 rounded border border-blue-200 animate-pulse">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                            <p class="text-xs text-blue-600">Enviando... ${sizeKB} KB</p>
                        </div>
                    </div>
                `;
            } else {
                // Mostrar arquivo enviado com sucesso
                html += `
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded border border-gray-200">
                        <i class="fas ${icon} text-purple-600 text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                            <p class="text-xs text-gray-500">${sizeKB} KB</p>
                            ${att.uuid ? `<p class="text-xs text-gray-400 font-mono">UUID: ${att.uuid.substring(0, 8)}...</p>` : ''}
                        </div>
                        ${att.uuid ? `
                            <button type="button" onclick="viewAttachment('${att.uuid}')" class="text-blue-600 hover:text-blue-800 transition-colors" title="Visualizar">
                                <i class="fas fa-eye text-sm"></i>
                            </button>
                        ` : ''}
                        ${att.uuid ? `
                            <button type="button" onclick="downloadAttachment('${att.uuid}', '${fileName}')" class="text-purple-600 hover:text-purple-800 transition-colors" title="Baixar">
                                <i class="fas fa-download text-sm"></i>
                            </button>
                        ` : ''}
                        ${!viewOnly ? `
                        <button type="button" onclick="removeAttachment('${att.uuid || att.id}')" class="text-red-600 hover:text-red-800 transition-colors" title="Excluir">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
            }
        });

        container.html(html);
    }

    // Atualizar contador de anexos
    function updateAttachmentCount(expenseId, expenseType) {
        // Se expenseType não foi fornecido, tentar obter de window.currentAttachmentExpense
        if (!expenseType && window.currentAttachmentExpense) {
            expenseType = window.currentAttachmentExpense.type;
        }

        // Se ainda não temos o tipo, tentar descobrir verificando todas as chaves
        if (!expenseType) {
            const types = ['vehicle', 'lodging', 'other'];
            for (const type of types) {
                const key = `${type}-${expenseId}`;
                if (window.expenseAttachments[key]) {
                    expenseType = type;
                    break;
                }
            }
        }

        if (!expenseType) {
            return;
        }

        const key = `${expenseType}-${expenseId}`;
        const count = (window.expenseAttachments[key] || []).length;
        const badge = $(`.attachment-count-${expenseId}`);


        if (count > 0) {
            badge.text(count).removeClass('hidden');
        } else {
            badge.addClass('hidden');
        }
    }

    // Obter ícone do arquivo
    function getFileIcon(fileType) {
        if (!fileType) return 'fa-file';
        if (fileType.includes('pdf')) return 'fa-file-pdf';
        if (fileType.includes('image')) return 'fa-file-image';
        if (fileType.includes('word') || fileType.includes('document')) return 'fa-file-word';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fa-file-excel';
        return 'fa-file';
    }

    // ==================== FUNÇÕES DE HOSPEDAGEM ====================

    // Função para limpar erros de validação de hospedagem
    function clearLodgingValidationErrors() {
        $('#lodging-date-error, #lodging-amount-error').addClass('hidden');
        $('#modal-lodging-date').removeClass('border-red-500').addClass('border-gray-300');
        $('#modal-lodging-amount').removeClass('border-red-500').addClass('border-gray-300');
    }

    // Função para abrir modal de hospedagem
    window.openLodgingModal = function() {
        // Definir data padrão (hoje)
        const today = new Date().toISOString().split('T')[0];
        $('#modal-lodging-date').val(today);

        // Resetar campos
        $('#modal-lodging-amount').val('0,00');
        $('#modal-lodging-description').val('');
        $('#lodging-char-counter').text('0/100');

        // Limpar erros de validação
        clearLodgingValidationErrors();

        // Aplicar máscara monetária no campo de valor
        $('#modal-lodging-amount').mask('#.##0,00', {
            reverse: true,
            placeholder: '0,00'
        });

        // Mostrar modal
        $('#lodging-expense-modal').removeClass('hidden');
    };

    // Função para fechar modal de hospedagem
    window.closeLodgingModal = function() {
        $('#lodging-expense-modal').addClass('hidden');
    };

    // Variável para controlar se o mousedown aconteceu no overlay de hospedagem
    let mouseDownOnLodgingOverlay = false;

    // Detectar mousedown no overlay de hospedagem
    $('#lodging-expense-modal').on('mousedown', function(e) {
        if (e.target.id === 'lodging-expense-modal') {
            mouseDownOnLodgingOverlay = true;
        } else {
            mouseDownOnLodgingOverlay = false;
        }
    });

    // Fechar modal de hospedagem ao clicar fora dele
    $('#lodging-expense-modal').on('click', function(e) {
        if (e.target.id === 'lodging-expense-modal' && mouseDownOnLodgingOverlay) {
            closeLodgingModal();
        }
    });

    // Fechar modal de hospedagem com ESC
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && !$('#lodging-expense-modal').hasClass('hidden')) {
            closeLodgingModal();
        }
    });

    // Limpar erro de data de hospedagem quando o usuário selecionar
    $(document).on('change', '#modal-lodging-date', function() {
        if ($(this).val()) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#lodging-date-error').addClass('hidden');
        }
    });

    // Limpar erro de valor de hospedagem quando o usuário digitar
    $(document).on('input', '#modal-lodging-amount', function() {
        const amount = parseMoneyValue($(this).val());
        if (amount > 0) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#lodging-amount-error').addClass('hidden');
        }
    });

    // Função para confirmar adição de despesa de hospedagem
    window.confirmAddLodgingExpense = function() {
        // Limpar erros anteriores
        clearLodgingValidationErrors();

        const date = $('#modal-lodging-date').val();
        const amount = parseMoneyValue($('#modal-lodging-amount').val());
        const description = $('#modal-lodging-description').val().trim();

        let hasError = false;

        // Validar data
        if (!date) {
            $('#modal-lodging-date').removeClass('border-gray-300').addClass('border-red-500');
            $('#lodging-date-error').removeClass('hidden');
            hasError = true;
        }

        // Validar valor
        if (amount <= 0) {
            $('#modal-lodging-amount').removeClass('border-gray-300').addClass('border-red-500');
            $('#lodging-amount-error').removeClass('hidden');
            hasError = true;
        }

        // Se houver erros, interromper
        if (hasError) {
            return;
        }

        // Adicionar despesa diretamente ao modelo
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('pt-BR');

        accountabilityData.lodging.expenses.push({
            name: 'Hospedagem',
            description: description,
            date: date,
            date_formatted: formattedDate,
            amount: amount,
            attachments: [],
            attachments_count: 0
        });

        // Recalcular total
        accountabilityData.lodging.amount = accountabilityData.lodging.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.lodging.expenses_count = accountabilityData.lodging.expenses.length;

        // Re-renderizar interface
        renderFromData();

        // Fechar modal
        closeLodgingModal();
    };

    // Função para adicionar linha de despesa de hospedagem
    function addLodgingExpenseRow(date, amount, description = '', skipCalculate = false) {
        lodgingExpenseCounter++;

        const rowHtml = `
            <div class="lodging-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                 data-expense-id="${lodgingExpenseCounter}"
                 data-amount="${amount}"
                 data-description="${description}">
                <!-- Data -->
                <div class="w-36">
                    <input type="date" id="lodging-expense-date-${lodgingExpenseCounter}" class="lodging-expense-date w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" value="${date}">
                </div>

                <!-- Tipo de Despesa -->
                <div class="flex items-center gap-2 flex-1">
                    <i class="fas fa-bed text-purple-900 text-xs"></i>
                    <span class="text-sm text-gray-700">Hospedagem</span>
                    ${description ? `<span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-sm">${description}</span>` : ''}
                </div>

                <!-- Valor -->
                <div class="text-right">
                    <span class="text-sm font-bold text-purple-900">R$ ${amount.toFixed(2).replace('.', ',')}</span>
                </div>

                <!-- Botão Anexos -->
                <button type="button" onclick="openAttachmentModal(${lodgingExpenseCounter}, 'lodging')" class="text-purple-600 hover:text-purple-800 transition-colors relative" title="Anexos">
                    <i class="fas fa-paperclip text-xs"></i>
                    <span class="attachment-count-${lodgingExpenseCounter} hidden absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">0</span>
                </button>

                <!-- Botão Excluir -->
                <button type="button" onclick="removeLodgingExpense(${lodgingExpenseCounter})" class="text-red-600 hover:text-red-800 transition-colors" title="Excluir">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
        `;

        $('#lodging-expenses-list').append(rowHtml);

        // Adicionar listener para mudança de data
        $(`#lodging-expense-date-${lodgingExpenseCounter}`).on('change', function() {
            calculateLodgingTotal();
        });

        if (!skipCalculate) {
            calculateLodgingTotal();
        }

        return lodgingExpenseCounter;
    }

    // Função para remover despesa de hospedagem
    window.removeLodgingExpense = function(expenseId) {
        $(`.lodging-expense-item[data-expense-id="${expenseId}"]`).remove();
        calculateLodgingTotal();
    };

    // ==================== FUNÇÕES DE OUTRAS DESPESAS ====================

    // Função para limpar erros de validação de outras despesas
    function clearOtherValidationErrors() {
        $('#other-description-error, #other-date-error, #other-amount-error').addClass('hidden');
        $('#modal-other-description').removeClass('border-red-500').addClass('border-gray-300');
        $('#modal-other-date').removeClass('border-red-500').addClass('border-gray-300');
        $('#modal-other-amount').removeClass('border-red-500').addClass('border-gray-300');
    }

    // Função para abrir modal de outras despesas
    window.openOtherModal = function() {
        // Definir data padrão (hoje)
        const today = new Date().toISOString().split('T')[0];
        $('#modal-other-date').val(today);

        // Resetar campos
        $('#modal-other-description').val('');
        $('#modal-other-amount').val('0,00');
        $('#char-counter').text('0/50');

        // Limpar erros de validação
        clearOtherValidationErrors();

        // Aplicar máscara monetária no campo de valor
        $('#modal-other-amount').mask('#.##0,00', {
            reverse: true,
            placeholder: '0,00'
        });

        // Mostrar modal
        $('#other-expense-modal').removeClass('hidden');
    };

    // Função para fechar modal de outras despesas
    window.closeOtherModal = function() {
        $('#other-expense-modal').addClass('hidden');
    };

    // Variável para controlar se o mousedown aconteceu no overlay de outras despesas
    let mouseDownOnOtherOverlay = false;

    // Detectar mousedown no overlay de outras despesas
    $('#other-expense-modal').on('mousedown', function(e) {
        if (e.target.id === 'other-expense-modal') {
            mouseDownOnOtherOverlay = true;
        } else {
            mouseDownOnOtherOverlay = false;
        }
    });

    // Fechar modal de outras despesas ao clicar fora dele
    $('#other-expense-modal').on('click', function(e) {
        if (e.target.id === 'other-expense-modal' && mouseDownOnOtherOverlay) {
            closeOtherModal();
        }
    });

    // Fechar modal de outras despesas com ESC
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && !$('#other-expense-modal').hasClass('hidden')) {
            closeOtherModal();
        }
    });

    // Atualizar contador de caracteres do textarea
    $(document).on('input', '#modal-other-description', function() {
        const length = $(this).val().length;
        $('#char-counter').text(`${length}/50`);

        // Limpar erro se o usuário digitar
        if ($(this).val().trim()) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#other-description-error').addClass('hidden');
        }
    });

    // Contador de caracteres para descrição de hospedagem
    $(document).on('input', '#modal-lodging-description', function() {
        const length = $(this).val().length;
        $('#lodging-char-counter').text(`${length}/100`);
    });

    // Limpar erro de data de outras despesas quando o usuário selecionar
    $(document).on('change', '#modal-other-date', function() {
        if ($(this).val()) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#other-date-error').addClass('hidden');
        }
    });

    // Limpar erro de valor de outras despesas quando o usuário digitar
    $(document).on('input', '#modal-other-amount', function() {
        const amount = parseMoneyValue($(this).val());
        if (amount > 0) {
            $(this).removeClass('border-red-500').addClass('border-gray-300');
            $('#other-amount-error').addClass('hidden');
        }
    });

    // Função para confirmar adição de outras despesas
    window.confirmAddOtherExpense = function() {
        // Limpar erros anteriores
        clearOtherValidationErrors();

        const description = $('#modal-other-description').val().trim();
        const date = $('#modal-other-date').val();
        const amount = parseMoneyValue($('#modal-other-amount').val());

        let hasError = false;

        // Validar descrição
        if (!description) {
            $('#modal-other-description').removeClass('border-gray-300').addClass('border-red-500');
            $('#other-description-error').removeClass('hidden');
            hasError = true;
        }

        // Validar data
        if (!date) {
            $('#modal-other-date').removeClass('border-gray-300').addClass('border-red-500');
            $('#other-date-error').removeClass('hidden');
            hasError = true;
        }

        // Validar valor
        if (amount <= 0) {
            $('#modal-other-amount').removeClass('border-gray-300').addClass('border-red-500');
            $('#other-amount-error').removeClass('hidden');
            hasError = true;
        }

        // Se houver erros, interromper
        if (hasError) {
            return;
        }

        // Adicionar despesa diretamente ao modelo
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('pt-BR');

        accountabilityData.other.expenses.push({
            name: description,
            description: description,
            date: date,
            date_formatted: formattedDate,
            amount: amount,
            attachments: [],
            attachments_count: 0
        });

        // Recalcular total
        accountabilityData.other.amount = accountabilityData.other.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        accountabilityData.other.expenses_count = accountabilityData.other.expenses.length;

        // Re-renderizar interface
        renderFromData();

        // Fechar modal
        closeOtherModal();
    };

    // Função para adicionar linha de outras despesas
    function addOtherExpenseRow(description, date, amount, skipCalculate = false) {
        otherExpenseCounter++;

        const rowHtml = `
            <div class="other-expense-item flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors"
                 data-expense-id="${otherExpenseCounter}"
                 data-amount="${amount}"
                 data-description="${description}">
                <!-- Data -->
                <div class="w-36">
                    <input type="date" id="other-expense-date-${otherExpenseCounter}" class="other-expense-date w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500" value="${date}">
                </div>

                <!-- Descrição -->
                <div class="flex items-center gap-2 flex-1">
                    <i class="fas fa-receipt text-purple-900 text-xs"></i>
                    <span class="text-sm text-gray-700">${description}</span>
                </div>

                <!-- Valor -->
                <div class="text-right">
                    <span class="text-sm font-bold text-purple-900">R$ ${amount.toFixed(2).replace('.', ',')}</span>
                </div>

                <!-- Botão Anexos -->
                <button type="button" onclick="openAttachmentModal(${otherExpenseCounter}, 'other')" class="text-purple-600 hover:text-purple-800 transition-colors relative" title="Anexos">
                    <i class="fas fa-paperclip text-xs"></i>
                    <span class="attachment-count-${otherExpenseCounter} hidden absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">0</span>
                </button>

                <!-- Botão Excluir -->
                <button type="button" onclick="removeOtherExpense(${otherExpenseCounter})" class="text-red-600 hover:text-red-800 transition-colors" title="Excluir">
                    <i class="fas fa-trash text-xs"></i>
                </button>
            </div>
        `;

        $('#other-expenses-list').append(rowHtml);

        // Adicionar listener para mudança de data
        $(`#other-expense-date-${otherExpenseCounter}`).on('change', function() {
            calculateOtherTotal();
        });

        if (!skipCalculate) {
            calculateOtherTotal();
        }

        return otherExpenseCounter;
    }

    // Função para remover outras despesas
    window.removeOtherExpense = function(expenseId) {
        $(`.other-expense-item[data-expense-id="${expenseId}"]`).remove();
        calculateOtherTotal();
    };

    // Função para coletar dados do passo atual
    /**
     * Coleta dados do step atual antes de navegar
     * Sincroniza apenas a seção relevante para evitar re-renderizações desnecessárias
     */
    function collectCurrentStepData() {
        if (currentStep === 1) {
            syncFoodDataFromDOM();
        } else if (currentStep === 2 && IS_DRIVER) {
            syncVehicleDataFromDOM();
        } else if (currentStep === 3) {
            syncLodgingDataFromDOM();
        } else if (currentStep === 4) {
            syncOtherDataFromDOM();
        }
        updateJSON();
        renderSummary();
    }

    // Função para renderizar resumo
    function renderSummary() {
        const total = accountabilityData.food.amount +
                     accountabilityData.vehicle.amount +
                     accountabilityData.lodging.amount +
                     accountabilityData.other.amount;

        // Formatar datas para exibição
        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        };

        let html = `
            <!-- Informações da Viagem -->
            <div class="pt-6 pb-12 border-b border-gray-200">
                <div class="mb-4">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Colaborador</span>
                    <p class="text-sm font-medium text-gray-700 mt-1 ml-4">
                        <i class="fas fa-user text-purple-900 mr-2"></i>
                        {% if session.get('user_name') %}{{ session.get('user_name') }}{% else %}Nome não informado{% endif %}
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Destino</span>
                        <p class="text-sm font-medium text-gray-900 mt-1 ml-4">
                            <i class="fas fa-map-marker-alt text-purple-900 mr-1"></i>
                            ${TRIP_DESTINATION}
                        </p>
                    </div>
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Veículo</span>
                        <p class="text-sm font-medium text-gray-900 mt-1 ml-4">
                            <i class="fas fa-car text-purple-900 mr-1"></i>
                            ${TRIP_VEHICLE}
                        </p>
                    </div>
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Data de Saída</span>
                        <p class="text-sm font-medium text-gray-900 mt-1 ml-4">
                            <i class="fas fa-calendar-day text-purple-900 mr-1"></i>
                            ${formatDate(TRIP_START_DATE)}
                        </p>
                    </div>
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Data de Chegada</span>
                        <p class="text-sm font-medium text-gray-900 mt-1 ml-4">
                            <i class="fas fa-calendar-check text-purple-900 mr-1"></i>
                            ${formatDate(TRIP_END_DATE)}
                        </p>
                    </div>
                </div>
            </div>

            <div class="py-2">
                <div class="mb-4">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Alimentação:</span>
                </div>
        `;

        // Adicionar detalhes dos dias de alimentação
        if (accountabilityData.food.days && accountabilityData.food.days.length > 0) {
            html += '<div class="ml-4 space-y-2 mb-4">';
            accountabilityData.food.days.forEach(day => {
                // Criar objeto com todas as refeições (valor 0 se não existir)
                const mealsMap = {
                    breakfast: { name: 'Café', value: 0, icon: 'fa-coffee' },
                    lunch: { name: 'Almoço', value: 0, icon: 'fa-utensils' },
                    dinner: { name: 'Janta', value: 0, icon: 'fa-moon' }
                };

                // Atualizar com os valores das refeições marcadas
                day.meals.forEach(meal => {
                    if (mealsMap[meal.type]) {
                        mealsMap[meal.type].value = meal.value;
                    }
                });

                html += `
                    <div class="flex flex-col md:flex-row md:items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <!-- Data -->
                        <div class="md:w-24 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-purple-900 text-sm"></i>
                            <span class="font-medium text-gray-700">${day.date_formatted}</span>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 flex-1">
                            <!-- Café -->
                            <div class="flex items-center gap-1.5">
                                <i class="fas ${mealsMap.breakfast.icon} text-purple-900 text-sm"></i>
                                <span class="text-gray-700">${mealsMap.breakfast.name}</span>
                                <span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-sm">R$ ${mealsMap.breakfast.value.toFixed(2).replace('.', ',')}</span>
                            </div>

                            <!-- Almoço -->
                            <div class="flex items-center gap-1.5">
                                <i class="fas ${mealsMap.lunch.icon} text-purple-900 text-sm"></i>
                                <span class="text-gray-700">${mealsMap.lunch.name}</span>
                                <span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-sm">R$ ${mealsMap.lunch.value.toFixed(2).replace('.', ',')}</span>
                            </div>

                            <!-- Janta -->
                            <div class="flex items-center gap-1.5">
                                <i class="fas ${mealsMap.dinner.icon} text-purple-900 text-sm"></i>
                                <span class="text-gray-700">${mealsMap.dinner.name}</span>
                                <span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-sm">R$ ${mealsMap.dinner.value.toFixed(2).replace('.', ',')}</span>
                            </div>
                        </div>

                        <!-- Total do Dia -->
                        <div class="text-right md:text-right">
                            <span class="font-bold text-purple-900">R$ ${day.amount.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += `
                <div class="ml-4 mb-4">
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="text-gray-500">Não há despesas registradas</span>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                <div class="flex items-center justify-end pe-1 bg-white rounded text-sm">
                    <span class="text-gray-600">Total:</span>
                    <span class="ml-2 font-bold text-purple-900">R$ ${accountabilityData.food.amount.toFixed(2).replace('.', ',')}</span>
                </div>
            </div>
            <div class="py-2">
                <div class="mb-4">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Veículo:</span>
                </div>
        `;

        // Adicionar quilometragem
        if (accountabilityData.vehicle.km_start > 0 || accountabilityData.vehicle.km_end > 0) {
            html += `
                <div class="ml-4 mb-4 flex gap-6 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600">Km (Saída):</span>
                        <span class="font-bold text-purple-900">${accountabilityData.vehicle.km_start.toLocaleString('pt-BR')}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600">Km (Chegada):</span>
                        <span class="font-bold text-purple-900">${accountabilityData.vehicle.km_end.toLocaleString('pt-BR')}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600">Total Percorrido:</span>
                        <span class="font-bold text-purple-900">${(accountabilityData.vehicle.km_end - accountabilityData.vehicle.km_start).toLocaleString('pt-BR')} km</span>
                    </div>
                </div>
            `;
        }

        // Adicionar detalhes das despesas de veículo
        if (accountabilityData.vehicle.expenses && accountabilityData.vehicle.expenses.length > 0) {
            html += '<div class="ml-4 space-y-2 mb-4">';
            accountabilityData.vehicle.expenses.forEach(expense => {
                const attachmentCount = expense.attachments_count || 0;
                html += `
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="w-24 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-purple-900 text-sm"></i>
                            <span class="font-medium text-gray-700">${expense.date_formatted}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-car text-purple-900"></i>
                            <span class="text-gray-700">${expense.name}</span>
                            ${attachmentCount > 0 ? `
                            <button type="button" onclick="openAttachmentModalFromSummary('vehicle', ${accountabilityData.vehicle.expenses.indexOf(expense)})" class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${attachmentCount} anexo(s)">
                                <div class="relative">
                                    <i class="fas fa-paperclip text-purple-900"></i>
                                    <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${attachmentCount}</span>
                                </div>
                                <span class="text-gray-700">Anexos</span>
                            </button>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += `
                <div class="ml-4 mb-4">
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="text-gray-500">Não há despesas registradas</span>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                <div class="flex items-center justify-end pe-1 bg-white rounded text-sm">
                    <span class="text-gray-600">Total:</span>
                    <span class="ml-2 font-bold text-purple-900">R$ ${accountabilityData.vehicle.amount.toFixed(2).replace('.', ',')}</span>
                </div>
            </div>
            <div class="py-2">
                <div class="mb-4">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Hospedagem:</span>
                </div>
        `;

        // Adicionar detalhes das despesas de hospedagem
        if (accountabilityData.lodging.expenses && accountabilityData.lodging.expenses.length > 0) {
            html += '<div class="ml-4 space-y-2 mb-4">';
            accountabilityData.lodging.expenses.forEach(expense => {
                const attachmentCount = expense.attachments_count || 0;
                html += `
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="w-24 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-purple-900 text-sm"></i>
                            <span class="font-medium text-gray-700">${expense.date_formatted}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-bed text-purple-900"></i>
                            <span class="text-gray-700">${expense.name}</span>
                            ${expense.description ? `<span class="ml-1 px-2 py-0.5 bg-purple-100 text-purple-900 font-bold rounded-full text-xs">${expense.description}</span>` : ''}
                            ${attachmentCount > 0 ? `
                            <button type="button" onclick="openAttachmentModalFromSummary('lodging', ${accountabilityData.lodging.expenses.indexOf(expense)})" class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${attachmentCount} anexo(s)">
                                <div class="relative">
                                    <i class="fas fa-paperclip text-purple-900"></i>
                                    <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${attachmentCount}</span>
                                </div>
                                <span class="text-gray-700">Anexos</span>
                            </button>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += `
                <div class="ml-4 mb-4">
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="text-gray-500">Não há despesas registradas</span>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                <div class="flex items-center justify-end pe-1 bg-white rounded text-sm">
                    <span class="text-gray-600">Total:</span>
                    <span class="ml-2 font-bold text-purple-900">R$ ${accountabilityData.lodging.amount.toFixed(2).replace('.', ',')}</span>
                </div>
            </div>
            <div class="py-2">
                <div class="mb-4">
                    <span class="text-xs font-semibold text-gray-500 uppercase">Outras Despesas:</span>
                </div>
        `;

        // Adicionar detalhes das outras despesas
        if (accountabilityData.other.expenses && accountabilityData.other.expenses.length > 0) {
            html += '<div class="ml-4 space-y-2 mb-4">';
            accountabilityData.other.expenses.forEach(expense => {
                const attachmentCount = expense.attachments_count || 0;
                html += `
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="w-24 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-purple-900 text-sm"></i>
                            <span class="font-medium text-gray-700">${expense.date_formatted}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-receipt text-purple-900"></i>
                            <span class="text-gray-700">${expense.description}</span>
                            ${attachmentCount > 0 ? `
                            <button type="button" onclick="openAttachmentModalFromSummary('other', ${accountabilityData.other.expenses.indexOf(expense)})" class="flex items-center gap-1.5 ml-2 cursor-pointer hover:opacity-80 transition-opacity" title="${attachmentCount} anexo(s)">
                                <div class="relative">
                                    <i class="fas fa-paperclip text-purple-900"></i>
                                    <span class="absolute -top-1 -right-1 bg-purple-600 text-white text-[8px] rounded-full w-3.5 h-3.5 flex items-center justify-center">${attachmentCount}</span>
                                </div>
                                <span class="text-gray-700">Anexos</span>
                            </button>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-purple-900">R$ ${expense.amount.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += `
                <div class="ml-4 mb-4">
                    <div class="flex items-center gap-3 px-3 py-2 bg-white border border-gray-300 rounded text-sm">
                        <div class="flex items-center gap-2 flex-1">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="text-gray-500">Não há despesas registradas</span>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                <div class="flex items-center justify-end pe-1 bg-white rounded text-sm">
                    <span class="text-gray-600">Total:</span>
                    <span class="ml-2 font-bold text-purple-900">R$ ${accountabilityData.other.amount.toFixed(2).replace('.', ',')}</span>
                </div>
            </div>
        `;

        $('#summary-content').html(html);

        // Atualizar rodapé com totais
        const totalDespesa = total;
        const valorRepasse = {{ payout.amount }};
        const saldoFinal = valorRepasse - totalDespesa;

        $('#summary-total-despesa').html(`
            <span class="font-semibold text-sm text-gray-600 uppercase">Despesa:</span>
            <span class="font-bold text-lg text-purple-900">R$ ${totalDespesa.toFixed(2).replace('.', ',')}</span>
        `);

        $('#summary-saldo-final').html(`
            <span class="font-bold text-base text-gray-800 uppercase">Saldo Final:</span>
            <span class="font-bold text-xl ${saldoFinal < 0 ? 'text-red-900' : 'text-purple-900'}">R$ ${saldoFinal.toFixed(2).replace('.', ',')}</span>
        `);
    }

    // Atualizar JSON em tempo real
    $('.money-input, textarea').on('input', function() {
        collectCurrentStepData();
    });

    window.nextStep = function() {
        if (currentStep < totalSteps) {
            collectCurrentStepData();

            // Esconder passo atual
            $(`#wizard-step-${currentStep}`).addClass('hidden');

            // Avançar para próximo passo
            currentStep++;

            // Pular step 2 (Veículo) se o usuário não for o motorista
            if (currentStep === 2 && !IS_DRIVER) {
                currentStep = 3;
            }

            // Se for o último passo, renderizar resumo
            if (currentStep === totalSteps) {
                renderSummary();
            }

            // Mostrar próximo passo
            $(`#wizard-step-${currentStep}`).removeClass('hidden');

            // Scroll suave para o topo
            $('html, body').animate({ scrollTop: 0 }, 400);
        }
    };

    window.previousStep = function() {
        if (currentStep > 1) {
            collectCurrentStepData();

            // Esconder passo atual
            $(`#wizard-step-${currentStep}`).addClass('hidden');

            // Voltar para passo anterior
            currentStep--;

            // Pular step 2 (Veículo) se o usuário não for o motorista
            if (currentStep === 2 && !IS_DRIVER) {
                currentStep = 1;
            }

            // Mostrar passo anterior
            $(`#wizard-step-${currentStep}`).removeClass('hidden');

            // Scroll suave para o topo
            $('html, body').animate({ scrollTop: 0 }, 400);
        }
    };

    // Função para ir diretamente para um passo específico
    window.goToStep = function(targetStep) {
        // Impedir navegação se já foi enviada ou aprovada
        if (IS_LOCKED) {
            return;
        }

        // Impedir navegação para step 2 (Veículo) se o usuário não for o motorista
        if (targetStep === 2 && !IS_DRIVER) {
            return;
        }

        if (targetStep >= 1 && targetStep <= totalSteps && targetStep !== currentStep) {
            collectCurrentStepData();

            // Esconder passo atual
            $(`#wizard-step-${currentStep}`).addClass('hidden');

            // Atualizar passo atual
            currentStep = targetStep;

            // Se for o último passo, renderizar resumo
            if (currentStep === totalSteps) {
                renderSummary();
            }

            // Mostrar passo alvo
            $(`#wizard-step-${currentStep}`).removeClass('hidden');

            // Scroll suave para o topo
            $('html, body').animate({ scrollTop: 0 }, 400);
        }
    };

    // Função para salvar prestação de contas (rascunho ou enviar)
    window.saveAccountability = function(status = 'draft') {
        // Impedir salvar se já foi enviada ou aprovada
        if (IS_LOCKED) {
            showToast('Esta prestação de contas já foi enviada e não pode ser modificada', 'warning');
            return;
        }

        // Coletar dados do passo atual antes de salvar
        collectCurrentStepData();

        // Fazer requisição para salvar
        fetch('/admin/financial/{{ payout.id }}/accountability', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                statement_content: accountabilityData,
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Recarregar a página após 1 segundo
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'Erro ao salvar prestação de contas', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao salvar prestação de contas', 'error');
        });
    };

    // Permitir apenas números nos campos de quilometragem
    $('#km-departure, #km-arrival').on('input', function() {
        // Remove tudo que não seja dígito
        this.value = this.value.replace(/[^0-9]/g, '');
        // Atualizar JSON quando alterar os valores de km
        calculateVehicleTotal();
    });

    // Inicializar JSON
    updateJSON();

    // Inicializar estado do botão de adicionar alimentação
    updateAddFoodDayButton();

    // Renderizar dados salvos (se houver)
    {% if payout.existing_statement and payout.existing_statement.statement_content %}
    function renderSavedData() {

        // Renderizar dias de alimentação
        if (accountabilityData.food && accountabilityData.food.days && accountabilityData.food.days.length > 0) {
            accountabilityData.food.days.forEach((day, index) => {
                // Adicionar dia usando a função existente
                addFoodDay();

                // Configurar a data do dia
                setTimeout(() => {
                    $(`#food-day-date-${foodDayCounter}`).val(day.date);

                    // Configurar checkboxes das refeições
                    day.meals.forEach(meal => {
                        const checkbox = $(`.food-meal-checkbox[data-day-id="${foodDayCounter}"][data-meal="${meal.type}"]`);
                        // Verificar se a refeição foi marcada (se o valor for maior que 0)
                        if (meal.value > 0) {
                            checkbox.prop('checked', true);
                        } else {
                            checkbox.prop('checked', false);
                        }
                    });
                }, 50 * (index + 1));
            });
        }

        // Renderizar despesas de veículo
        if (IS_DRIVER && accountabilityData.vehicle) {
            // Configurar quilometragem
            if (accountabilityData.vehicle.km_start) {
                $('#km-departure').val(accountabilityData.vehicle.km_start);
            }
            if (accountabilityData.vehicle.km_end) {
                $('#km-arrival').val(accountabilityData.vehicle.km_end);
            }

            // Adicionar despesas de veículo
            if (accountabilityData.vehicle.expenses && accountabilityData.vehicle.expenses.length > 0) {
                accountabilityData.vehicle.expenses.forEach((expense, index) => {
                    setTimeout(() => {
                        const rowId = addVehicleExpenseRow(
                            expense.date || TRIP_START_DATE,
                            expense.type || 'fuel',
                            parseFloat(expense.amount) || 0,
                            expense.name || '',
                            true  // skipCalculate = true para não recalcular durante o carregamento
                        );

                        // Restaurar anexos desta despesa
                        if (expense.attachments && expense.attachments.length > 0) {
                            const attachmentKey = `vehicle-${rowId}`;
                            window.expenseAttachments[attachmentKey] = expense.attachments.map(att => ({
                                uuid: att.uuid,
                                name: att.filename,
                                size: att.size,
                                type: att.mime_type,
                                hash_md5: att.hash_md5,
                                hash_sha256: att.hash_sha256,
                                path: att.path,
                                download_url: att.download_url,
                                created_at: att.created_at
                            }));
                            updateAttachmentCount(rowId, 'vehicle');
                        }
                    }, 50 * (index + 1));
                });
            }
        }

        // Renderizar despesas de hospedagem
        if (accountabilityData.lodging && accountabilityData.lodging.expenses && accountabilityData.lodging.expenses.length > 0) {
            accountabilityData.lodging.expenses.forEach((expense, index) => {
                setTimeout(() => {
                    const rowId = addLodgingExpenseRow(
                        expense.date || TRIP_START_DATE,
                        parseFloat(expense.amount) || 0,
                        expense.description || '',
                        true  // skipCalculate = true para não recalcular durante o carregamento
                    );

                    // Restaurar anexos desta despesa
                    if (expense.attachments && expense.attachments.length > 0) {
                        const attachmentKey = `lodging-${rowId}`;
                        window.expenseAttachments[attachmentKey] = expense.attachments.map(att => ({
                            uuid: att.uuid,
                            name: att.filename,
                            size: att.size,
                            type: att.mime_type,
                            hash_md5: att.hash_md5,
                            hash_sha256: att.hash_sha256,
                            path: att.path,
                            download_url: att.download_url,
                            created_at: att.created_at
                        }));
                        updateAttachmentCount(rowId, 'lodging');
                    }
                }, 50 * (index + 1));
            });
        }

        // Renderizar outras despesas
        if (accountabilityData.other && accountabilityData.other.expenses && accountabilityData.other.expenses.length > 0) {
            accountabilityData.other.expenses.forEach((expense, index) => {
                setTimeout(() => {
                    const rowId = addOtherExpenseRow(
                        expense.name || expense.description || 'Despesa',
                        expense.date || TRIP_START_DATE,
                        parseFloat(expense.amount) || 0,
                        true  // skipCalculate = true para não recalcular durante o carregamento
                    );

                    // Restaurar anexos desta despesa
                    if (expense.attachments && expense.attachments.length > 0) {
                        const attachmentKey = `other-${rowId}`;
                        window.expenseAttachments[attachmentKey] = expense.attachments.map(att => ({
                            uuid: att.uuid,
                            name: att.filename,
                            size: att.size,
                            type: att.mime_type,
                            hash_md5: att.hash_md5,
                            hash_sha256: att.hash_sha256,
                            path: att.path,
                            download_url: att.download_url,
                            created_at: att.created_at
                        }));
                        updateAttachmentCount(rowId, 'other');
                    }
                }, 50 * (index + 1));
            });
        }

    }

    // ========================================
    // INICIALIZAÇÃO DA INTERFACE
    // ========================================

    // ========================================
    // EVENT HANDLERS (Delegação de Eventos)
    // ========================================

    // Event delegation para checkboxes de refeições
    $(document).on('change', '.food-meal-checkbox', function() {
        syncFoodDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Event delegation para mudança de data nos dias de alimentação
    $(document).on('change', '[id^="food-day-date-"]', function() {
        syncFoodDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Event delegation para mudança de data nas despesas de veículo
    // Usar 'blur' ao invés de 'change' para evitar interferir com a digitação
    $(document).on('blur', '[id^="vehicle-expense-date-"]', function() {
        syncVehicleDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Event delegation para mudança de quilometragem
    $(document).on('blur', '#km-departure, #km-arrival', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        syncVehicleDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Validar apenas números durante a digitação sem sincronizar
    $(document).on('input', '#km-departure, #km-arrival', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Event delegation para mudança de data nas despesas de hospedagem
    // Usar 'blur' ao invés de 'change' para evitar interferir com a digitação
    $(document).on('blur', '[id^="lodging-expense-date-"]', function() {
        syncLodgingDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Event delegation para mudança de data nas outras despesas
    // Usar 'blur' ao invés de 'change' para evitar interferir com a digitação
    $(document).on('blur', '[id^="other-expense-date-"]', function() {
        syncOtherDataFromDOM();
        updateJSON();
        renderSummary();
    });

    // Aguardar o DOM estar pronto e renderizar a interface a partir dos dados
    $(document).ready(function() {

        // Renderizar toda a interface a partir do accountabilityData
        renderFromData();

    });
    {% endif %}

    // Controle do dropdown de salvar
    const $saveButton = $('#saveButton');
    const $saveMenu = $('#saveMenu');
    const $saveContainer = $('#saveDropdown');
    let isSaveFixed = false;

    function openSaveDropdown() {
        // Mover para o body com position fixed para evitar problemas de z-index
        const rect = $saveButton[0].getBoundingClientRect();

        $saveMenu.removeClass('hidden');
        $saveMenu.css({
            position: 'fixed',
            zIndex: 9999,
            top: (rect.bottom + 8) + 'px',
            left: (rect.right - $saveMenu.outerWidth()) + 'px'
        });

        $('body').append($saveMenu);
        isSaveFixed = true;
    }

    function closeSaveDropdown() {
        $saveMenu.addClass('hidden');
        $saveMenu.css({
            position: '',
            zIndex: '',
            top: '',
            left: ''
        });

        // Retornar para o container original
        $saveContainer.append($saveMenu);
        isSaveFixed = false;
    }

    // Toggle dropdown
    $saveButton.on('click', function(e) {
        e.stopPropagation();

        if ($saveMenu.hasClass('hidden')) {
            openSaveDropdown();
        } else {
            closeSaveDropdown();
        }
    });

    // Fechar dropdown ao clicar fora
    $(document).on('click', function(e) {
        if (!$saveMenu.is(e.target) && $saveMenu.has(e.target).length === 0 &&
            !$saveButton.is(e.target) && !$saveMenu.hasClass('hidden')) {
            closeSaveDropdown();
        }
    });

    // Reposicionar ao redimensionar a janela ou scroll
    function updateSavePosition() {
        if (!$saveMenu.hasClass('hidden') && isSaveFixed) {
            const rect = $saveButton[0].getBoundingClientRect();
            $saveMenu.css({
                top: (rect.bottom + 8) + 'px',
                left: (rect.right - $saveMenu.outerWidth()) + 'px'
            });
        }
    }

    $(window).on('resize', updateSavePosition);
    $(window).on('scroll', updateSavePosition);
});
</script>
{% endblock %}
