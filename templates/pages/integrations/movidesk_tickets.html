{% extends "base.html" %}
{% from "components/breadcrumbs.html" import render as breadcrumbs %}

{% block title %}Sincronizar Tickets - Movidesk{% endblock %}

{% block breadcrumbs %}
{{ breadcrumbs([
    {'name': 'Integrações', 'url': url_for('admin.integrations_list')},
    {'name': 'Movidesk', 'url': url_for('admin.movidesk_options')},
    {'name': 'Tickets'}
]) }}
{% endblock %}

{% block content %}
<div class="py-8">
    <!-- Header -->
    <div class="mb-8 animate-fade-in">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
            <div class="flex items-center">
                <div class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg mr-4 flex-shrink-0">
                    <i class="fas fa-ticket-alt text-white text-2xl sm:text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-1">Tickets do Movidesk</h1>
                    <p class="text-sm sm:text-base text-gray-600">Sincronize e gerencie tickets</p>
                </div>
            </div>

            <!-- Botão de Sincronização -->
            <button onclick="syncTickets()" id="syncButton"
                    class="inline-flex items-center px-8 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all shadow-md hover:shadow-lg">
                <i class="fas fa-sync-alt mr-2"></i>
                Sincronizar Agora
            </button>
        </div>
    </div>

    <!-- Layout com Sidebar -->
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Conteúdo Principal -->
        <div class="flex-1 min-w-0">
            <!-- Card de Sincronização -->
            <div class="card p-6 animate-fade-in mb-6">
                <!-- Seleção de Período -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-calendar-alt text-green-600 mr-2"></i>
                        Período de Sincronização
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="startDate" class="block text-sm font-semibold text-gray-700 mb-2">Data Inicial *</label>
                            <input type="date" id="startDate" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all">
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-semibold text-gray-700 mb-2">Data Final *</label>
                            <input type="date" id="endDate" required
                                   class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all">
                        </div>
                    </div>
                    <div id="dateError" class="mt-2 text-sm text-red-600 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="dateErrorMsg"></span>
                    </div>
                </div>

                <!-- Mensagem de Progresso -->
                <div id="syncMessage"></div>

                <div class="bg-green-50 border border-green-200 rounded-xl p-6 mt-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-info-circle text-green-600 mr-2"></i>
                        Como funciona?
                    </h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                            <span>Selecione um período de até 5 dias para sincronização</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                            <span>Os tickets serão buscados diretamente da API do Movidesk</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                            <span>Tickets existentes serão atualizados com os novos dados</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-600 mr-2 mt-1"></i>
                            <span>Após a sincronização, os tickets estarão disponíveis no sistema</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Card de Sincronização Automática -->
            <div class="card p-6 animate-fade-in">
                <!-- Header -->
                <div class="flex items-center mb-4">
                    <i class="fas fa-clock text-green-600 mr-2 text-lg"></i>
                    <h3 class="text-lg font-bold text-gray-900">Sincronização Automática</h3>
                </div>

                <p class="text-sm text-gray-600 mb-4">Configure horários fixos para sincronização automática durante o dia</p>

                <!-- Lista de Horários -->
                <div id="schedules-container" class="space-y-2 mb-4">
                    <!-- Horários serão inseridos aqui -->
                </div>

                <!-- Adicionar Novo Horário -->
                <div class="flex gap-2">
                    <input type="time" id="newScheduleTime"
                           class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all">
                    <button onclick="addSchedule()"
                            class="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-all shadow-md">
                        <i class="fas fa-plus mr-2"></i>
                        Adicionar
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar de Métricas -->
        <div class="w-full lg:w-80 flex-shrink-0">
            <div class="sticky top-6 space-y-4 animate-fade-in">
                <!-- Total de Tickets -->
                <div class="card p-4">
                    <div class="text-sm text-gray-600 mb-1">Total de Tickets</div>
                    <div class="text-2xl font-bold text-green-600" id="totalTickets">{{ stats.total }}</div>
                </div>

                <!-- Novos -->
                <div class="card p-4">
                    <div class="text-sm text-gray-600 mb-1">Novos</div>
                    <div id="lastSyncInfo">
                        {% if stats.last_sync %}
                            <div class="text-2xl font-bold text-gray-900" id="syncedCount">{{ stats.last_sync.synced }}</div>
                        {% else %}
                            <div class="text-2xl font-bold text-gray-900" id="syncedCount">0</div>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="lastSyncLabel">
                        {% if stats.last_sync %}
                            {{ stats.last_sync.synced_at[:16].replace('T', ' às ') if stats.last_sync.synced_at else 'Não disponível' }}
                        {% else %}
                            Última sincronização
                        {% endif %}
                    </div>
                </div>

                <!-- Atualizados -->
                <div class="card p-4">
                    <div class="text-sm text-gray-600 mb-1">Atualizados</div>
                    {% if stats.last_sync %}
                        <div class="text-2xl font-bold text-gray-900" id="updatedCount">{{ stats.last_sync.updated }}</div>
                    {% else %}
                        <div class="text-2xl font-bold text-gray-900" id="updatedCount">0</div>
                    {% endif %}
                    <div class="text-xs text-gray-500 mt-1">Última sincronização</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Voltar -->
    <div class="mt-6 animate-fade-in">
        <a href="{{ url_for('admin.movidesk_options') }}" class="text-blue-600 hover:text-blue-700 font-semibold">
            <i class="fas fa-arrow-left mr-2"></i>
            Voltar para Movidesk
        </a>
    </div>
</div>

<script>
    // Objeto de horários configurados (key: time)
    let schedules = {};

    // Definir data padrão (hoje)
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = todayStr;

    // Data inicial (5 dias atrás)
    const fiveDaysAgo = new Date(today);
    fiveDaysAgo.setDate(today.getDate() - 5);
    const fiveDaysAgoStr = fiveDaysAgo.toISOString().split('T')[0];
    document.getElementById('startDate').value = fiveDaysAgoStr;

    // Carregar horários salvos ao iniciar
    loadSchedules();

    // Validação de período
    function validateDateRange() {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);
        const dateError = document.getElementById('dateError');
        const dateErrorMsg = document.getElementById('dateErrorMsg');

        if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
            dateErrorMsg.textContent = 'Ambas as datas são obrigatórias';
            dateError.classList.remove('hidden');
            return false;
        }

        if (startDate > endDate) {
            dateErrorMsg.textContent = 'A data inicial não pode ser maior que a data final';
            dateError.classList.remove('hidden');
            return false;
        }

        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays > 5) {
            dateErrorMsg.textContent = 'O período não pode ser maior que 5 dias';
            dateError.classList.remove('hidden');
            return false;
        }

        dateError.classList.add('hidden');
        return true;
    }

    // Adicionar listeners de validação
    document.getElementById('startDate').addEventListener('change', validateDateRange);
    document.getElementById('endDate').addEventListener('change', validateDateRange);

    // ===== FUNÇÕES DE GERENCIAMENTO DE HORÁRIOS =====

    // Carregar horários salvos do backend
    async function loadSchedules() {
        try {
            const response = await fetch('/admin/api/parameters/MOVIDESK_SYNC_SCHEDULES');
            const result = await response.json();

            if (result.success && result.value && result.value.trim() !== '') {
                schedules = JSON.parse(result.value);
            } else {
                schedules = {};
            }
            renderSchedules();
        } catch (error) {
            console.error('Erro ao carregar horários:', error);
            schedules = {};
            renderSchedules();
        }
    }

    // Renderizar lista de horários
    function renderSchedules() {
        const container = document.getElementById('schedules-container');

        const scheduleKeys = Object.keys(schedules);

        if (scheduleKeys.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-gray-500 text-sm">
                    <i class="fas fa-clock text-2xl mb-2"></i>
                    <p>Nenhum horário configurado</p>
                </div>
            `;
            return;
        }

        // Ordenar horários por valor (time)
        const sortedEntries = Object.entries(schedules).sort((a, b) => a[1].localeCompare(b[1]));

        container.innerHTML = sortedEntries.map(([key, time]) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clock text-green-600"></i>
                    <span class="font-semibold text-gray-900">${time}</span>
                </div>
                <button onclick="removeSchedule('${key}')"
                        class="text-red-600 hover:text-red-700 transition-colors">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    // Adicionar novo horário
    async function addSchedule() {
        const timeInput = document.getElementById('newScheduleTime');
        const time = timeInput.value;

        if (!time) {
            showToast('Selecione um horário', 'warning');
            return;
        }

        // Verificar duplicado
        if (Object.values(schedules).includes(time)) {
            showToast('Este horário já está configurado', 'warning');
            return;
        }

        // Adicionar com qualquer key temporária (será reindexado ao salvar)
        const tempKey = Date.now();
        schedules[tempKey] = time;
        renderSchedules();
        timeInput.value = '';

        // Salvar automaticamente (reindexará)
        await saveSchedules(`Sincronização automática adicionada para ${time}`);
    }

    // Remover horário
    async function removeSchedule(key) {
        const time = schedules[key];
        delete schedules[key];
        renderSchedules();

        // Salvar automaticamente (reindexará)
        await saveSchedules(`Horário ${time} removido com sucesso`);
    }

    // Salvar horários no backend
    async function saveSchedules(customMessage = null) {
        try {
            // Reindexar o objeto: pegar todos os valores, ordenar, e criar novo objeto com índices 0, 1, 2...
            const times = Object.values(schedules).sort();
            const reindexed = {};
            times.forEach((time, index) => {
                reindexed[index] = time;
            });

            const response = await fetch('/admin/api/parameters/MOVIDESK_SYNC_SCHEDULES/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    value: JSON.stringify(reindexed)
                })
            });

            const result = await response.json();

            if (result.success) {
                // Atualizar schedules local com o reindexado
                schedules = reindexed;
                renderSchedules();
                showToast(customMessage || 'Horários salvos automaticamente!', 'success');
            } else {
                showToast('Erro ao salvar horários', 'error');
            }
        } catch (error) {
            console.error('Erro ao salvar:', error);
            showToast('Erro ao salvar horários', 'error');
        }
    }

    async function syncTickets() {
        if (!validateDateRange()) {
            return;
        }

        const syncButton = document.getElementById('syncButton');
        const syncMessage = document.getElementById('syncMessage');
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // Desabilita botão e mostra loading
        syncButton.disabled = true;
        syncButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...';
        syncMessage.innerHTML = '<div class="text-blue-600 bg-blue-50 border border-blue-200 rounded-xl p-4"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando tickets do Movidesk...</div>';

        try {
            const response = await fetch('{{ url_for("admin.movidesk_sync_tickets") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            });

            const result = await response.json();

            if (result.success) {
                syncMessage.innerHTML = `
                    <div class="text-green-600 bg-green-50 border border-green-200 rounded-xl p-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        Sincronização concluída com sucesso!
                    </div>
                `;

                // Atualiza métricas permanentes
                document.getElementById('totalTickets').textContent = result.total;
                document.getElementById('syncedCount').textContent = result.synced;
                document.getElementById('updatedCount').textContent = result.updated;

                // Atualiza label da última sincronização
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastSyncLabel').textContent = `${dateStr} às ${timeStr}`;

            } else {
                syncMessage.innerHTML = `
                    <div class="text-red-600 bg-red-50 border border-red-200 rounded-xl p-4">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Erro: ${result.error}
                    </div>
                `;
            }

        } catch (error) {
            syncMessage.innerHTML = `
                <div class="text-red-600 bg-red-50 border border-red-200 rounded-xl p-4">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    Erro ao sincronizar: ${error.message}
                </div>
            `;
        } finally {
            // Reabilita botão
            syncButton.disabled = false;
            syncButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Sincronizar Novamente';
        }
    }
</script>
{% endblock %}
