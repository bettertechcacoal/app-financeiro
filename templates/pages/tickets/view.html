{% extends "base.html" %}
{% from "components/breadcrumbs.html" import render as breadcrumbs %}

{% block title %}Tickets - {{ client.name }}{% endblock %}

{% block breadcrumbs %}
{{ breadcrumbs([
    {'name': 'Tickets', 'url': url_for('admin.tickets_list')},
    {'name': client.name}
]) }}
{% endblock %}

{% block content %}
<div class="tw-page-transition">
    <!-- Page Header -->
    <div class="tw-page-header">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg shadow-green-500/30">
                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Tickets - {{ client.name }}</h1>
                <p class="text-gray-500">Visualize todos os tickets deste cliente</p>
            </div>
        </div>
        <div class="tw-header-actions">
            {% if organizations %}
            <button onclick="openReportModal()" class="btn bg-green-600 hover:bg-green-700 text-white">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                Emitir Relatório
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Layout com Sidebar -->
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Conteúdo Principal -->
        <div class="flex-1 min-w-0">
            {% if organizations %}
                <!-- Search and Filters -->
                <div class="tw-card-section p-4 tw-card-shadow mb-6">
                    <div class="flex items-center gap-4">
                        <div class="flex-1 relative">
                            <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" id="searchInput" placeholder="Pesquisar por organização, assunto, status..." class="tw-input-field pl-12">
                        </div>
                        <button onclick="clearSearch()" class="btn btn-secondary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Limpar
                        </button>
                    </div>
                </div>

                <!-- Lista de Tickets em Cards -->
                <div class="space-y-4">
                    {% for org in organizations %}
                        {% for ticket in org.tickets %}
                        <div class="tw-card-section tw-card-shadow ticket-row overflow-hidden hover:shadow-lg transition-shadow"
                             data-search="{{ org.business_name|lower }} {{ ticket.subject|lower if ticket.subject else '' }} {{ ticket.category|lower if ticket.category else '' }} {{ ticket.status|lower if ticket.status else '' }} {{ ticket.ownerName|lower if ticket.ownerName else '' }}">

                            <!-- Header do Card -->
                            <div class="px-5 py-3 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100 flex items-center justify-between flex-wrap gap-2">
                                <div class="flex items-center gap-3 text-sm text-gray-500">
                                    <span class="font-medium text-green-600">#{{ ticket.id }}</span>
                                    <span class="text-gray-300">•</span>
                                    <div class="flex items-center gap-1">
                                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                        </svg>
                                        <span>{{ org.business_name }}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <!-- Categoria -->
                                    {% if ticket.category %}
                                        {% if ticket.category == 'Incidente' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                                {{ ticket.category }}
                                            </span>
                                        {% elif ticket.category == 'Requisição' or ticket.category == 'Requisicao' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                                </svg>
                                                Requisição
                                            </span>
                                        {% elif ticket.category == 'Dúvida' or ticket.category == 'Duvida' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                Dúvida
                                            </span>
                                        {% elif ticket.category == 'Problema' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-orange-50 text-orange-700 border border-orange-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                {{ ticket.category }}
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                                </svg>
                                                {{ ticket.category }}
                                            </span>
                                        {% endif %}
                                    {% endif %}

                                    <!-- Status -->
                                    {% if ticket.status %}
                                        {% if ticket.status == 'Novo' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                                </svg>
                                                {{ ticket.status }}
                                            </span>
                                        {% elif ticket.status == 'EmAndamento' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                Em Andamento
                                            </span>
                                        {% elif ticket.status == 'Resolvido' or ticket.status == 'Fechado' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                                {{ ticket.status }}
                                            </span>
                                        {% elif ticket.status == 'Cancelado' %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                                {{ ticket.status }}
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                                                {{ ticket.status }}
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Corpo do Card -->
                            <div class="p-5">
                                <!-- Assunto -->
                                <div class="flex items-center gap-1.5 mb-4">
                                    <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                                    </svg>
                                    <p class="font-medium text-gray-900">{{ ticket.subject or 'Sem assunto' }}</p>
                                </div>

                                {% if ticket.serviceFull %}
                                <div class="mb-4">
                                    <span class="text-xs font-medium text-gray-400 uppercase tracking-wide block mb-1">Serviço</span>
                                    <p class="text-sm text-gray-700">{{ ticket.serviceFull }}</p>
                                </div>
                                {% endif %}

                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <div>
                                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wide block mb-1">Responsável</span>
                                        <p class="font-medium text-gray-900 text-sm">{{ ticket.ownerName or '-' }}</p>
                                    </div>
                                    <div>
                                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wide block mb-1">Aberto em</span>
                                        <div class="flex items-center gap-1.5">
                                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <p class="font-medium text-gray-900 text-sm">
                                                {% if ticket.createdDate %}
                                                    {{ ticket.createdDate[8:10] }}/{{ ticket.createdDate[5:7] }}/{{ ticket.createdDate[:4] }} {{ ticket.createdDate[11:16] }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wide block mb-1">Encerrado em</span>
                                        <div class="flex items-center gap-1.5">
                                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <p class="font-medium text-gray-900 text-sm">
                                                {% if ticket.resolvedIn %}
                                                    {{ ticket.resolvedIn[8:10] }}/{{ ticket.resolvedIn[5:7] }}/{{ ticket.resolvedIn[:4] }} {{ ticket.resolvedIn[11:16] }}
                                                {% else %}
                                                    <span class="text-gray-400">-</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wide block mb-1">Fechado em</span>
                                        <div class="flex items-center gap-1.5">
                                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <p class="font-medium text-gray-900 text-sm">
                                                {% if ticket.closedIn %}
                                                    {{ ticket.closedIn[8:10] }}/{{ ticket.closedIn[5:7] }}/{{ ticket.closedIn[:4] }} {{ ticket.closedIn[11:16] }}
                                                {% else %}
                                                    <span class="text-gray-400">-</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}

                    <!-- Footer Stats -->
                    <div class="tw-card-section tw-card-shadow mt-4 px-5 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                                </svg>
                                Total: <span class="font-semibold text-gray-900" id="totalCount">{{ total_tickets }}</span> ticket{% if total_tickets != 1 %}s{% endif %}
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Mostrando: <span class="font-semibold text-gray-900" id="visibleCount">{{ total_tickets }}</span> registro{% if total_tickets != 1 %}s{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="tw-card-section p-12 tw-card-shadow text-center">
                    <div class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Nenhuma organização vinculada</h3>
                    <p class="text-gray-500 mb-6">Este cliente não possui organizações vinculadas</p>
                    <a href="{{ url_for('admin.integrations_list') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                        Vincular Organização
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar de Métricas -->
        <div class="w-full lg:w-80 flex-shrink-0">
            <div class="sticky top-6 space-y-4">
                <!-- Total de Tickets -->
                <div class="tw-card-section tw-card-shadow p-5">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total de Tickets</p>
                            <p class="text-2xl font-bold text-green-600">{{ total_tickets }}</p>
                        </div>
                    </div>
                </div>

                <!-- Total de Organizações -->
                <div class="tw-card-section tw-card-shadow p-5">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Organizações Vinculadas</p>
                            <p class="text-2xl font-bold text-blue-600">{{ organizations|length }}</p>
                        </div>
                    </div>
                </div>

                <!-- Info do Cliente -->
                <div class="tw-card-section tw-card-shadow p-5">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">CNPJ do Cliente</p>
                            <p class="text-lg font-bold text-gray-900 font-mono">{{ client.document }}</p>
                        </div>
                    </div>
                </div>

                <!-- Organizações com Tickets -->
                {% if organizations %}
                <div class="tw-card-section tw-card-shadow p-5">
                    <div class="flex items-center gap-3 mb-5">
                        <div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <h3 class="text-base font-semibold text-gray-900">Organizações</h3>
                    </div>
                    <div class="space-y-3">
                        {% for org in organizations %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                            <div class="flex-1 min-w-0 pr-4">
                                <p class="text-sm text-gray-900 truncate font-medium">{{ org.business_name }}</p>
                            </div>
                            <div class="flex flex-col items-end flex-shrink-0">
                                <span class="text-xl font-bold text-green-600 leading-none">{{ org.tickets_count }}</span>
                                <span class="text-xs text-gray-500">ticket{% if org.tickets_count != 1 %}s{% endif %}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Botão Voltar -->
    <div class="mt-6">
        <a href="{{ url_for('admin.tickets_list') }}" class="inline-flex items-center gap-2 text-green-600 hover:text-green-700 font-medium transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Voltar para Lista de Clientes
        </a>
    </div>
</div>

<!-- Modal de Seleção de Relatório -->
<div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-fade-in">
        <!-- Header do Modal -->
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">
                <i class="fas fa-file-pdf text-green-600 mr-2"></i>
                Emitir Relatório de Serviço
            </h3>
            <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Corpo do Modal -->
        <form id="reportForm" method="GET" action="{{ url_for('admin.tickets_report_pdf', client_id=client.id) }}" target="_blank">
            <div class="px-6 py-6 space-y-6">
                <!-- Informações do Cliente -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="text-xs text-gray-500 mb-1">Cliente</div>
                    <div class="font-bold text-gray-900">{{ client.name }}</div>
                    <div class="text-xs text-gray-600 mt-1">CNPJ: {{ client.document }}</div>
                </div>

                <!-- Número do Ofício -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Número do Ofício</label>
                    <div class="relative">
                        <div class="flex items-center gap-2 border border-gray-200 rounded-xl px-4 py-3 focus-within:border-green-500 focus-within:ring-2 focus-within:ring-green-200 transition-all">
                            <input type="text" id="oficioNumero" placeholder="Número" maxlength="3"
                                   class="w-16 border-0 focus:ring-0 focus:outline-none p-0">
                            <span class="text-gray-400 font-medium">/</span>
                            <input type="text" id="oficioAno" maxlength="4"
                                   class="w-16 text-center border-0 focus:ring-0 focus:outline-none p-0">
                        </div>
                        <i class="fas fa-file-alt absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Número da Nota Fiscal -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Número da Nota Fiscal</label>
                    <div class="relative">
                        <input type="text" name="invoice_number" id="invoiceNumber"
                               placeholder="Nº da Nota Fiscal"
                               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all">
                        <i class="fas fa-receipt absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Tipo de Relatório -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Relatório</label>
                    <div class="relative">
                        <select name="report_type" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all">
                            <option value="servico">Relatório de Serviço</option>
                        </select>
                    </div>
                </div>

                <!-- Seleção de Mês/Ano -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Selecione o Mês</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <select name="month" id="monthSelect" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all" required>
                                <option value="">Mês</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div>
                            <select name="year" id="yearSelect" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all" required>
                                <option value="">Ano</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Período Calculado -->
                <div id="periodInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-4 hidden">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                        <div>
                            <div class="text-xs font-semibold text-blue-900 mb-1">Período do Relatório</div>
                            <div id="periodText" class="text-xs text-blue-700"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-end gap-3 rounded-b-2xl">
                <button type="button" onclick="closeReportModal()" class="px-4 py-2 text-gray-700 hover:text-gray-900 font-semibold transition-colors">
                    Cancelar
                </button>

                <!-- Dropdown Button -->
                <div class="relative" id="pdfDropdown">
                    <button type="button" onclick="toggleDropdown()" class="inline-flex items-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-sm hover:shadow-md transition-all">
                        <i class="fas fa-file-pdf mr-2"></i>
                        Gerar PDF
                        <i class="fas fa-chevron-down ml-2 text-xs"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="dropdownMenu" class="hidden absolute bottom-full right-0 mb-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-50">
                        <button type="button" onclick="downloadPDF()" class="w-full text-left px-4 py-2.5 hover:bg-gray-50 transition-colors flex items-center text-sm text-gray-700 font-medium">
                            <i class="fas fa-download mr-3 text-green-600"></i>
                            Baixar PDF
                        </button>
                        <button type="button" onclick="viewPDF()" class="w-full text-left px-4 py-2.5 hover:bg-gray-50 transition-colors flex items-center text-sm text-gray-700 font-medium">
                            <i class="fas fa-eye mr-3 text-green-600"></i>
                            Visualizar PDF
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Função de pesquisa
    const searchInput = document.getElementById('searchInput');
    const ticketRows = document.querySelectorAll('.ticket-row');
    const visibleCountEl = document.getElementById('visibleCount');
    const totalCountEl = document.getElementById('totalCount');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            let visibleCount = 0;

            ticketRows.forEach(row => {
                const searchData = row.getAttribute('data-search');

                if (searchData.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (visibleCountEl) {
                visibleCountEl.textContent = visibleCount;
            }
        });
    }

    function clearSearch() {
        if (searchInput) {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
            searchInput.focus();
        }
    }

    // ===== Funções do Modal de Relatório =====

    // Dados do cliente para cálculo de período
    const clientData = {
        billingCycleType: '{{ client.billing_cycle_type }}',
        billingDay: {{ client.billing_day or 'null' }},
        billingCycle: {{ client.billing_cycle or 'null' }},
        fixedStartDay: {{ client.fixed_start_day or 'null' }}
    };

    // Popular anos (últimos 5 anos + ano atual, sem anos futuros)
    function populateYears() {
        const yearSelect = document.getElementById('yearSelect');
        const currentYear = new Date().getFullYear();

        for (let year = currentYear - 5; year <= currentYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) {
                option.selected = true;
            }
            yearSelect.appendChild(option);
        }

        // Atualizar disponibilidade dos meses após popular anos
        updateMonthsAvailability();
    }

    // Atualizar disponibilidade dos meses (desabilitar mês atual e seguintes)
    function updateMonthsAvailability() {
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const selectedYear = parseInt(yearSelect.value);
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        // Obter todos os options de mês (exceto o primeiro que é placeholder)
        const monthOptions = monthSelect.querySelectorAll('option');

        monthOptions.forEach((option, index) => {
            if (index === 0) return; // Pular o placeholder "Mês"

            const monthValue = parseInt(option.value);

            // Se o ano selecionado for o ano atual, desabilitar mês atual e seguintes
            if (selectedYear === currentYear && monthValue >= currentMonth) {
                option.disabled = true;
                option.style.color = '#9ca3af';
                option.style.fontStyle = 'italic';
            } else {
                option.disabled = false;
                option.style.color = '';
                option.style.fontStyle = '';
            }
        });

        // Se o mês selecionado está desabilitado, limpar seleção
        const selectedMonth = parseInt(monthSelect.value);
        if (selectedYear === currentYear && selectedMonth >= currentMonth) {
            monthSelect.value = '';
            document.getElementById('periodInfo').classList.add('hidden');
        }
    }

    // Selecionar mês anterior ao atual
    function selectPreviousMonth() {
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        const selectedYear = parseInt(yearSelect.value);

        // Se o ano selecionado é o atual, selecionar o mês anterior
        if (selectedYear === currentYear) {
            const previousMonth = currentMonth - 1;
            if (previousMonth > 0) {
                monthSelect.value = previousMonth;
            } else {
                // Se estamos em janeiro, não selecionar nada
                monthSelect.value = '';
            }
        } else {
            // Se não é o ano atual, selecionar dezembro
            monthSelect.value = 12;
        }

        calculatePeriod();
    }

    // Calcular período baseado no ciclo de cobrança
    function calculatePeriod() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);

        if (!month || !year) {
            document.getElementById('periodInfo').classList.add('hidden');
            return;
        }

        let startDate, endDate;

        if (clientData.billingCycleType === 'mensal') {
            // Ciclo Mensal: sempre do dia 1 até o último dia do mês
            startDate = new Date(year, month - 1, 1);
            endDate = new Date(year, month, 0); // Último dia do mês

        } else if (clientData.billingCycleType === 'fixo') {
            // Ciclo Fixo: do dia fixo até o mesmo dia do mês seguinte
            const startDay = clientData.fixedStartDay || 1;

            startDate = new Date(year, month - 1, startDay);
            endDate = new Date(year, month, startDay);

            // Se o dia não existir no próximo mês (ex: 31 em fevereiro), usar último dia
            if (endDate.getDate() !== startDay) {
                endDate = new Date(year, month, 0); // Último dia do mês seguinte
            }

        } else {
            // Se não houver ciclo definido, usar o mês completo
            startDate = new Date(year, month - 1, 1);
            endDate = new Date(year, month, 0); // Último dia do mês
        }

        // Formatar datas
        const formatDate = (date) => {
            const day = String(date.getDate()).padStart(2, '0');
            const mon = String(date.getMonth() + 1).padStart(2, '0');
            const yr = date.getFullYear();
            return `${day}/${mon}/${yr}`;
        };

        const periodText = `${formatDate(startDate)} até ${formatDate(endDate)}`;
        document.getElementById('periodText').textContent = periodText;
        document.getElementById('periodInfo').classList.remove('hidden');
    }

    // Máscaras para número do ofício
    $('#oficioNumero').mask('000');
    $('#oficioAno').mask('0000');

    // Preencher ano automaticamente com ano atual
    const currentYear = new Date().getFullYear();
    $('#oficioAno').val(currentYear);

    // Formatar número com zeros à esquerda ao sair do campo
    $('#oficioNumero').on('blur', function() {
        const val = $(this).val().replace(/\D/g, ''); // Remove não-dígitos
        if (val.length > 0) {
            $(this).val(val.padStart(3, '0')); // Preenche com zeros à esquerda
        }
    });

    // Auto-foco: quando digitar 3 números, pular para o campo ano
    $('#oficioNumero').on('input', function() {
        const val = $(this).val().replace(/\D/g, '');
        if (val.length === 3) {
            // Formatar antes de pular
            $(this).val(val.padStart(3, '0'));
            $('#oficioAno').focus().select();
        }
    });

    // Abrir modal
    function openReportModal() {
        document.getElementById('reportModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Garantir que o ano está preenchido
        if (!$('#oficioAno').val()) {
            $('#oficioAno').val(currentYear);
        }
    }

    // Fechar modal
    function closeReportModal() {
        document.getElementById('reportModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Event listeners
    document.getElementById('monthSelect').addEventListener('change', calculatePeriod);
    document.getElementById('yearSelect').addEventListener('change', function() {
        updateMonthsAvailability();
        calculatePeriod();
    });

    // Fechar modal ao clicar fora
    document.getElementById('reportModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReportModal();
        }
    });

    // ===== Funções do Dropdown PDF =====

    // Toggle dropdown
    function toggleDropdown() {
        const dropdown = document.getElementById('dropdownMenu');
        dropdown.classList.toggle('hidden');
    }

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('pdfDropdown');
        const dropdownMenu = document.getElementById('dropdownMenu');

        if (dropdown && !dropdown.contains(e.target)) {
            dropdownMenu.classList.add('hidden');
        }
    });

    // Função para baixar PDF
    function downloadPDF() {
        const form = document.getElementById('reportForm');
        const month = document.getElementById('monthSelect').value;
        const year = document.getElementById('yearSelect').value;
        const oficioNumero = document.getElementById('oficioNumero').value;
        const oficioAno = document.getElementById('oficioAno').value;
        const invoiceNumber = document.getElementById('invoiceNumber').value;

        if (!month || !year) {
            alert('Por favor, selecione o mês e o ano.');
            return;
        }

        // Criar URL com parâmetros
        let url = form.action + '?month=' + month + '&year=' + year + '&download=1';

        // Combinar número e ano do ofício
        if (oficioNumero && oficioAno) {
            const oficioNumber = oficioNumero + '/' + oficioAno;
            url += '&oficio_number=' + encodeURIComponent(oficioNumber);
        }

        if (invoiceNumber) {
            url += '&invoice_number=' + encodeURIComponent(invoiceNumber);
        }

        // Abrir em nova aba para download
        window.open(url, '_blank');

        // Fechar dropdown e modal
        document.getElementById('dropdownMenu').classList.add('hidden');
        closeReportModal();
    }

    // Função para visualizar PDF
    function viewPDF() {
        const form = document.getElementById('reportForm');
        const month = document.getElementById('monthSelect').value;
        const year = document.getElementById('yearSelect').value;
        const oficioNumero = document.getElementById('oficioNumero').value;
        const oficioAno = document.getElementById('oficioAno').value;
        const invoiceNumber = document.getElementById('invoiceNumber').value;

        if (!month || !year) {
            alert('Por favor, selecione o mês e o ano.');
            return;
        }

        // Criar URL com parâmetros (sem forçar download)
        let url = form.action + '?month=' + month + '&year=' + year;

        // Combinar número e ano do ofício
        if (oficioNumero && oficioAno) {
            const oficioNumber = oficioNumero + '/' + oficioAno;
            url += '&oficio_number=' + encodeURIComponent(oficioNumber);
        }

        if (invoiceNumber) {
            url += '&invoice_number=' + encodeURIComponent(invoiceNumber);
        }

        // Abrir em nova aba para visualização
        window.open(url, '_blank');

        // Fechar dropdown e modal
        document.getElementById('dropdownMenu').classList.add('hidden');
        closeReportModal();
    }

    // Inicializar
    populateYears();
    selectPreviousMonth();
</script>
{% endblock %}
