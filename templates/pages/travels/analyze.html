{% extends "base.html" %}
{% from "components/breadcrumbs.html" import render as breadcrumbs %}

{% block title %}Análise de Viagem{% endblock %}

{% block breadcrumbs %}
{{ breadcrumbs([
    {'name': 'Viagens', 'url': url_for('admin.travels_list')},
    {'name': 'Análise de Viagem'}
]) }}
{% endblock %}

{% block head %}
<style>
    /* Estilo para campos editáveis */
    .editable-field {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .editable-field .edit-btn {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .editable-field:hover .edit-btn {
        opacity: 1;
    }

    .editable-field.editing .field-value {
        display: none;
    }

    .editable-field.editing .field-input {
        display: block;
    }

    .editable-field .field-input {
        display: none;
    }

    /* Seção colapsável */
    .section-content {
        max-height: 2000px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .section-content.collapsed {
        max-height: 0;
    }

    /* Status badge animado */
    .status-badge {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-6">
    <!-- Header com Status -->
    <div class="mb-6 animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center">
                <div class="w-14 h-14 bg-gradient-to-br from-purple-900 to-purple-800 rounded-2xl flex items-center justify-center shadow-lg mr-4">
                    <i class="fas fa-plane-departure text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Viagem #{{ travel.id }}</h1>
                    <p class="text-gray-600">
                        {{ travel.driver_user.name if travel.driver_user else 'N/A' }} -
                        {{ travel.city.name if travel.city else 'N/A' }}{% if travel.city and travel.city.state %}/{{ travel.city.state.uf }}{% endif %}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <!-- Status Badge -->
                {% if travel.status == 'pending' %}
                <span id="status-badge" class="status-badge inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-2"></i>
                    Aguardando Análise
                </span>
                {% elif travel.status == 'approved' %}
                <span id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-2"></i>
                    Aprovada
                </span>
                {% elif travel.status == 'in_progress' %}
                <span id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-plane mr-2"></i>
                    Em Andamento
                </span>
                {% elif travel.status == 'completed' %}
                <span id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-flag-checkered mr-2"></i>
                    Concluída
                </span>
                {% elif travel.status == 'cancelled' %}
                <span id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-2"></i>
                    Cancelada
                </span>
                {% endif %}
                <!-- Ações Rápidas -->
                {% if travel.status == 'pending' %}
                <button id="btn-reject-travel" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-xl font-semibold hover:bg-red-50 transition-all inline-flex items-center">
                    <i class="fas fa-times mr-2"></i>
                    Rejeitar
                </button>
                <button id="btn-approve-travel" class="px-4 py-2 bg-purple-900 text-white rounded-xl font-semibold hover:bg-purple-800 transition-all inline-flex items-center shadow-lg">
                    <i class="fas fa-check mr-2"></i>
                    Aprovar
                </button>
                {% elif travel.status == 'approved' %}
                <button id="btn-cancel-travel" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-xl font-semibold hover:bg-red-50 transition-all inline-flex items-center">
                    <i class="fas fa-ban mr-2"></i>
                    Cancelar Viagem
                </button>
                {% elif travel.status == 'in_progress' %}
                <button id="btn-cancel-travel" class="px-4 py-2 bg-white border border-red-300 text-red-600 rounded-xl font-semibold hover:bg-red-50 transition-all inline-flex items-center">
                    <i class="fas fa-ban mr-2"></i>
                    Cancelar Viagem
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Form hidden para submissão -->
    <form id="analyze-form" method="POST" action="{{ url_for('admin.travels_analyze_process', travel_id=travel.id) }}">
        <input type="hidden" name="action" id="action-field" value="">
        <input type="hidden" name="vehicle_id" id="vehicle_id_field" value="">
        <div id="financial-hidden-fields"></div>
    </form>

    <!-- Grid Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Coluna Esquerda - Informações -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Card: Informações da Viagem -->
            <div class="card animate-fade-in">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-info-circle text-gray-600"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Informações da Viagem</h2>
                    </div>
                    <button class="btn-toggle-section text-gray-400 hover:text-gray-600" data-section="info-section">
                        <i class="fas fa-chevron-up" id="info-section-icon"></i>
                    </button>
                </div>
                <div id="info-section" class="section-content">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Solicitante -->
                            <div class="md:col-span-2">
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Solicitante</label>
                                <div class="mt-1 flex items-center">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-purple-900"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900">{{ travel.driver_user.name if travel.driver_user else 'N/A' }}</p>
                                        <p class="text-xs text-gray-500">{{ travel.driver_user.email if travel.driver_user else '' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Destino -->
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Destino</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-purple-900"></i>
                                    <span class="text-sm font-medium text-gray-900">
                                        {{ travel.city.name if travel.city else 'N/A' }}
                                        {% if travel.city and travel.city.state %} - {{ travel.city.state.uf }}{% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- Duração -->
                            {% if travel.days and travel.days > 0 %}
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Duração</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <i class="fas fa-clock text-purple-900"></i>
                                    <span class="text-sm font-medium text-gray-900">{{ travel.days }} {{ 'dia' if travel.days == 1 else 'dias' }}</span>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Data de Saída -->
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Data de Saída</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <i class="fas fa-calendar-day text-purple-900"></i>
                                    <span class="text-sm font-medium text-gray-900">
                                        {% if travel.departure_date %}
                                            {{ travel.departure_date[8:10] }}/{{ travel.departure_date[5:7] }}/{{ travel.departure_date[:4] }} às {{ travel.departure_date[11:16] }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- Data de Retorno -->
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Data de Retorno</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <i class="fas fa-calendar-check text-purple-900"></i>
                                    <span class="text-sm font-medium text-gray-900">
                                        {% if travel.return_date %}
                                            {{ travel.return_date[8:10] }}/{{ travel.return_date[5:7] }}/{{ travel.return_date[:4] }} às {{ travel.return_date[11:16] }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- Motivo -->
                            <div class="md:col-span-2">
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Motivo da Viagem</label>
                                <div class="mt-1 flex items-center gap-2">
                                    <i class="fas fa-clipboard-list text-purple-900"></i>
                                    <span class="text-sm font-medium text-gray-900">{{ travel.purpose }}</span>
                                </div>
                            </div>

                            <!-- Observações -->
                            {% if travel.notes %}
                            <div class="md:col-span-2">
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Observações do Solicitante</label>
                                <div class="mt-1 flex items-start gap-2">
                                    <i class="fas fa-comment-dots text-purple-900 mt-0.5"></i>
                                    <span class="text-sm font-medium text-gray-700">{{ travel.notes }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Veículo (condicional) -->
            {% if travel.needs_vehicle %}
            <div class="card animate-fade-in" style="animation-delay: 0.1s">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-car text-gray-600"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Veículo</h2>
                            <p class="text-xs text-gray-500">Necessita de veículo: <span class="font-semibold text-green-600">Sim</span></p>
                        </div>
                    </div>
                    <button class="btn-toggle-section text-gray-400 hover:text-gray-600" data-section="vehicle-section">
                        <i class="fas fa-chevron-up" id="vehicle-section-icon"></i>
                    </button>
                </div>
                <div id="vehicle-section" class="section-content">
                    <div class="p-6">
                        {% if travel.vehicle %}
                        <!-- Veículo Já Cadastrado -->
                        <div id="selected-vehicle-display" class="flex items-center gap-4 py-4 px-5 border border-purple-200 rounded-lg bg-purple-50/50">
                            <svg class="w-14 h-14 text-purple-900 flex-shrink-0" viewBox="0 0 640 640" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M199.2 181.4L173.1 256L466.9 256L440.8 181.4C436.3 168.6 424.2 160 410.6 160L229.4 160C215.8 160 203.7 168.6 199.2 181.4zM103.6 260.8L138.8 160.3C152.3 121.8 188.6 96 229.4 96L410.6 96C451.4 96 487.7 121.8 501.2 160.3L536.4 260.8C559.6 270.4 576 293.3 576 320L576 512C576 529.7 561.7 544 544 544L512 544C494.3 544 480 529.7 480 512L480 480L160 480L160 512C160 529.7 145.7 544 128 544L96 544C78.3 544 64 529.7 64 512L64 320C64 293.3 80.4 270.4 103.6 260.8zM192 368C192 350.3 177.7 336 160 336C142.3 336 128 350.3 128 368C128 385.7 142.3 400 160 400C177.7 400 192 385.7 192 368zM480 400C497.7 400 512 385.7 512 368C512 350.3 497.7 336 480 336C462.3 336 448 350.3 448 368C448 385.7 462.3 400 480 400z"/>
                            </svg>
                            <div class="flex-1">
                                <h2 id="selected-vehicle-name" class="text-sm font-bold text-gray-800 uppercase">{{ travel.vehicle.brand }} {{ travel.vehicle.model }}</h2>
                                <p id="selected-vehicle-info" class="text-gray-500 text-xs">Placa: {{ travel.vehicle.plate }} | Ano: {{ travel.vehicle.year }}</p>
                            </div>
                            <button type="button" class="btn-open-vehicle-modal px-4 py-2 bg-purple-900 text-white rounded-lg text-sm font-semibold hover:bg-purple-800 transition-all inline-flex items-center flex-shrink-0">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Alterar
                            </button>
                        </div>
                        {% else %}
                        <!-- Nenhum Veículo Selecionado -->
                        <div id="no-vehicle-display" class="flex items-center gap-4 py-4 px-5 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50/50">
                            <svg class="w-14 h-14 text-gray-300 flex-shrink-0" viewBox="0 0 640 640" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M199.2 181.4L173.1 256L466.9 256L440.8 181.4C436.3 168.6 424.2 160 410.6 160L229.4 160C215.8 160 203.7 168.6 199.2 181.4zM103.6 260.8L138.8 160.3C152.3 121.8 188.6 96 229.4 96L410.6 96C451.4 96 487.7 121.8 501.2 160.3L536.4 260.8C559.6 270.4 576 293.3 576 320L576 512C576 529.7 561.7 544 544 544L512 544C494.3 544 480 529.7 480 512L480 480L160 480L160 512C160 529.7 145.7 544 128 544L96 544C78.3 544 64 529.7 64 512L64 320C64 293.3 80.4 270.4 103.6 260.8zM192 368C192 350.3 177.7 336 160 336C142.3 336 128 350.3 128 368C128 385.7 142.3 400 160 400C177.7 400 192 385.7 192 368zM480 400C497.7 400 512 385.7 512 368C512 350.3 497.7 336 480 336C462.3 336 448 350.3 448 368C448 385.7 462.3 400 480 400z"/>
                            </svg>
                            <div class="flex-1">
                                <h2 class="text-sm font-bold text-gray-800 uppercase">Nenhum veículo atribuído</h2>
                                <p class="text-gray-500 text-xs">Esta viagem requer a alocação de um veículo da frota.</p>
                            </div>
                            <button type="button" class="btn-open-vehicle-modal px-4 py-2 bg-purple-900 text-white rounded-lg text-sm font-semibold hover:bg-purple-800 transition-all inline-flex items-center flex-shrink-0">
                                <i class="fas fa-plus mr-2"></i>
                                Atribuir
                            </button>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card: Repasses Financeiros -->
            <div class="card animate-fade-in" style="animation-delay: 0.2s">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-dollar-sign text-gray-600"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Repasses Financeiros</h2>
                            <p class="text-xs text-gray-500">Defina os valores para cada participante</p>
                        </div>
                    </div>
                    <button class="btn-toggle-section text-gray-400 hover:text-gray-600" data-section="financial-section">
                        <i class="fas fa-chevron-up" id="financial-section-icon"></i>
                    </button>
                </div>
                <div id="financial-section" class="section-content">
                    <div class="p-6">
                        <!-- Accordion de Participantes -->
                        <div class="space-y-3" id="participants-accordion">
                            {% for member in members %}
                            <div class="border border-gray-200 rounded-lg overflow-hidden participant-accordion" data-user-id="{{ member.id }}">
                                <!-- Header compacto -->
                                <div class="bg-white px-4 py-2.5 flex items-center justify-between">
                                    <!-- Info do participante -->
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-purple-700 text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">{{ member.name }}</p>
                                            <p class="text-xs text-gray-400">{% if member.id == travel.driver_user_id %}Solicitante{% else %}Passageiro{% endif %}</p>
                                        </div>
                                    </div>

                                    <!-- Ações e Total -->
                                    <div class="flex items-center gap-3">
                                        <!-- Contador/Lista -->
                                        <button type="button" class="btn-toggle-accordion flex items-center gap-1 bg-purple-50 hover:bg-purple-100 rounded-lg p-2 border border-purple-200 transition-all" data-user-id="{{ member.id }}" title="Ver histórico de lançamentos">
                                            <svg class="w-3.5 h-3.5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                                <path d="M3 3v5h5"></path>
                                                <path d="M12 7v5l4 2"></path>
                                            </svg>
                                            <span class="text-sm font-bold text-purple-700 participant-count" data-user-id="{{ member.id }}">{{ member.payouts|length if member.payouts else 0 }}</span>
                                            <i class="fas fa-chevron-down text-[10px] text-purple-400 transition-transform accordion-icon" data-user-id="{{ member.id }}"></i>
                                        </button>
                                        <!-- Total + Botão Adicionar -->
                                        <div class="flex items-center gap-1 bg-green-50 rounded-lg pl-3 pr-1 py-1 border border-green-200">
                                            <span class="text-xs text-green-600">Total</span>
                                            <span class="text-sm font-bold text-green-700 participant-total" data-user-id="{{ member.id }}">R$ {{ '{:,.2f}'.format(member.amount).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                                            <button type="button" class="btn-toggle-input w-7 h-7 bg-green-500 hover:bg-green-600 text-white rounded-md flex items-center justify-center transition-all ml-2" data-user-id="{{ member.id }}" title="Adicionar valor">
                                                <i class="fas fa-plus text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Área de Input (oculta por padrão) -->
                                <div class="input-area hidden" data-user-id="{{ member.id }}">
                                    <div class="px-4 py-2.5 bg-green-50 border-t border-green-100 flex items-center gap-2">
                                        <input type="date" class="payout-date-input px-2 py-1.5 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 bg-white" data-user-id="{{ member.id }}">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs">R$</span>
                                            <input type="text" class="payout-value-input pl-7 pr-2 py-1.5 border border-gray-300 rounded text-xs font-semibold focus:ring-1 focus:ring-green-500 focus:border-green-500 w-24 bg-white" placeholder="0,00" data-user-id="{{ member.id }}">
                                        </div>
                                        <input type="text" class="payout-obs-input flex-1 px-2 py-1.5 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-green-500 focus:border-green-500 bg-white" placeholder="Observação (opcional)" data-user-id="{{ member.id }}">
                                        <button type="button" class="btn-add-payout px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium transition-all" data-user-id="{{ member.id }}">
                                            Adicionar
                                        </button>
                                        <button type="button" class="btn-cancel-input w-7 h-7 bg-white hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded flex items-center justify-center transition-all border border-gray-200" data-user-id="{{ member.id }}">
                                            <i class="fas fa-times text-xs"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Lista de Lançamentos (accordion) -->
                                <div class="accordion-content hidden" data-user-id="{{ member.id }}">
                                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                                <thead>
                                                    <tr class="bg-gray-100 border-b border-gray-200">
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Registrado em</th>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Data Repasse</th>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Por</th>
                                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Valor</th>
                                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Observação</th>
                                                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase w-16"></th>
                                                    </tr>
                                                </thead>
                                                <tbody class="payouts-table divide-y divide-gray-100" data-user-id="{{ member.id }}">
                                                    {% if member.payouts %}
                                                    {% for payout in member.payouts %}
                                                    <tr class="hover:bg-gray-50 transition-colors" data-payout-id="{{ payout.id }}">
                                                        <td class="px-3 py-3">
                                                            <span class="text-xs text-gray-600">{{ payout.created_at.strftime('%d/%m/%Y %H:%M') if payout.created_at else '-' }}</span>
                                                        </td>
                                                        <td class="px-3 py-3">
                                                            <span class="text-sm font-medium text-gray-900">{{ payout.payout_date.strftime('%d/%m/%Y') if payout.payout_date else '-' }}</span>
                                                        </td>
                                                        <td class="px-3 py-3">
                                                            <span class="text-sm text-gray-700">{{ payout.created_by_user.name if payout.created_by_user else '-' }}</span>
                                                        </td>
                                                        <td class="px-3 py-3 text-right">
                                                            <span class="text-sm font-bold text-green-600">R$ {{ '{:,.2f}'.format(payout.amount).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                                                        </td>
                                                        <td class="px-3 py-3">
                                                            <span class="text-xs text-gray-500 italic">{{ payout.observation if payout.observation else '-' }}</span>
                                                        </td>
                                                        <td class="px-3 py-3 text-center">
                                                            <button type="button" class="btn-delete-payout inline-flex items-center justify-center gap-1.5 px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 border border-red-200 rounded-md transition-all text-xs font-medium whitespace-nowrap" data-user-id="{{ member.id }}" data-payout-id="{{ payout.id }}">
                                                                <i class="fas fa-trash text-[10px]"></i>
                                                                Excluir
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="6" class="px-3 py-6 text-center text-gray-400 text-sm">
                                                            <i class="fas fa-inbox text-2xl mb-2 block"></i>
                                                            <p>Nenhum lançamento registrado</p>
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Total -->
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-700">Total de Repasses:</span>
                                <span id="total-payouts" class="text-lg font-bold text-purple-900">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Observações Administrativas -->
            <div class="card animate-fade-in" style="animation-delay: 0.3s">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-comment-dots text-gray-600"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Observações Administrativas</h2>
                    </div>
                </div>
                <div class="p-6">
                    <textarea name="admin_notes" id="admin_notes" rows="4"
                              placeholder="Adicione observações sobre a análise desta viagem..."
                              class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-sm"></textarea>
                    <p class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-lock mr-1"></i>
                        Estas observações são internas e não serão visíveis para o solicitante
                    </p>
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Resumo e Ações -->
        <div class="space-y-6">
            <!-- Card: Resumo -->
            <div class="card animate-fade-in" style="animation-delay: 0.15s">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-clipboard-list text-gray-600"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Resumo</h2>
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    <!-- Solicitante -->
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Solicitante</span>
                        <p class="text-sm font-semibold text-gray-900 mt-1">{{ travel.driver_user.name if travel.driver_user else 'N/A' }}</p>
                    </div>

                    <!-- Destino -->
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Destino</span>
                        <p class="text-sm font-semibold text-gray-900 mt-1">
                            <i class="fas fa-map-marker-alt text-purple-600 mr-1"></i>
                            {{ travel.city.name if travel.city else 'N/A' }}{% if travel.city and travel.city.state %} - {{ travel.city.state.uf }}{% endif %}
                        </p>
                    </div>

                    <!-- Período -->
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Período</span>
                        <p class="text-sm font-semibold text-gray-900 mt-1">
                            {% if travel.departure_date and travel.return_date %}
                                {{ travel.departure_date[8:10] }}/{{ travel.departure_date[5:7] }}/{{ travel.departure_date[:4] }} - {{ travel.return_date[8:10] }}/{{ travel.return_date[5:7] }}/{{ travel.return_date[:4] }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                        {% if travel.days %}
                        <p class="text-xs text-gray-500">{{ travel.days }} {{ 'dia' if travel.days == 1 else 'dias' }} de viagem</p>
                        {% endif %}
                    </div>

                    <!-- Veículo -->
                    {% if travel.needs_vehicle %}
                    <div>
                        <span class="text-xs font-semibold text-gray-500 uppercase">Veículo</span>
                        {% if travel.vehicle %}
                        <p id="summary-vehicle" class="text-sm font-semibold text-purple-700 mt-1">
                            <i class="fas fa-check-circle text-green-600 mr-1"></i>
                            {{ travel.vehicle.brand }} {{ travel.vehicle.model }} ({{ travel.vehicle.plate }})
                        </p>
                        {% else %}
                        <p id="summary-vehicle" class="text-sm font-semibold text-gray-500 mt-1">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Nenhum selecionado
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Total Repasses -->
                    <div class="pt-4 border-t border-gray-200">
                        <span class="text-xs font-semibold text-gray-500 uppercase">Total de Repasses</span>
                        <p id="summary-total" class="text-xl font-bold text-green-600 mt-1">R$ 0,00</p>
                    </div>

                </div>
            </div>

            <!-- Card: Histórico -->
            <div class="card animate-fade-in" style="animation-delay: 0.25s">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-history text-gray-600"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Histórico</h2>
                    </div>
                </div>
                <div class="p-4">
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-plus text-blue-600 text-xs"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Viagem criada</p>
                                <p class="text-xs text-gray-500">
                                    {% if travel.created_at %}
                                        {{ travel.created_at[8:10] }}/{{ travel.created_at[5:7] }}/{{ travel.created_at[:4] }}
                                    {% endif %}
                                    por {{ travel.driver_user.name if travel.driver_user else 'N/A' }}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-clock text-yellow-600 text-xs"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Aguardando análise</p>
                                <p class="text-xs text-gray-500">Pendente de aprovação</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmação de Aprovação -->
<div id="modal-approve" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-check-circle text-purple-900 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Confirmar Aprovação</h3>
                </div>
            </div>
            <p class="text-gray-700 mb-4 leading-relaxed">
                Confirma a aprovação desta viagem? O solicitante será notificado automaticamente.
            </p>
            <div id="modal-approve-warning" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5 mr-3"></i>
                    <div>
                        <p class="text-sm font-semibold text-yellow-800 mb-1">Atenção</p>
                        <p class="text-sm text-yellow-700">Há participantes sem valor de repasse informado.</p>
                    </div>
                </div>
            </div>
            {% if travel.needs_vehicle %}
            <div id="modal-vehicle-warning" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-car text-red-600 mt-0.5 mr-3"></i>
                    <div>
                        <p class="text-sm font-semibold text-red-800 mb-1">Veículo Obrigatório</p>
                        <p class="text-sm text-red-700">Selecione um veículo antes de aprovar a viagem.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="flex justify-end gap-3">
                <button class="btn-close-modal px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all">
                    Cancelar
                </button>
                <button id="btn-confirm-approve" class="px-5 py-2.5 bg-purple-900 hover:bg-purple-800 text-white rounded-lg font-semibold transition-all">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmação de Rejeição -->
<div id="modal-reject" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Confirmar Rejeição</h3>
                </div>
            </div>
            <p class="text-gray-700 mb-6 leading-relaxed">
                Tem certeza que deseja rejeitar esta viagem? O solicitante será notificado.
            </p>
            <div class="flex justify-end gap-3">
                <button class="btn-close-modal px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all">
                    Cancelar
                </button>
                <button id="btn-confirm-reject" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all">
                    Rejeitar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Popover de Confirmação de Exclusão -->
<div id="delete-popover" class="hidden fixed z-50">
    <div class="bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-64 relative">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-500 text-sm"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">Excluir lançamento?</p>
                <p class="text-xs text-gray-500 mt-1">Esta ação não pode ser desfeita.</p>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-4">
            <button type="button" id="btn-cancel-delete-popover" class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-gray-800 bg-gray-100 hover:bg-gray-200 rounded-md transition-all">
                Cancelar
            </button>
            <button type="button" id="btn-confirm-delete-payout" class="px-3 py-1.5 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-all">
                Excluir
            </button>
        </div>
        <!-- Seta apontando para baixo -->
        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-r border-b border-gray-200 rotate-45"></div>
    </div>
</div>

<!-- Modal: Seleção de Veículo -->
<div id="modal-vehicle" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full animate-fade-in max-h-[90vh] flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-car text-purple-900 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Selecionar Veículo</h3>
                        <p class="text-sm text-gray-500">Escolha um veículo disponível para esta viagem</p>
                    </div>
                </div>
                <button type="button" class="btn-close-modal text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <!-- Busca -->
            <div class="mt-4">
                <div class="relative">
                    <input type="text" id="vehicle-search" placeholder="Buscar por marca, modelo ou placa..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div id="vehicles-list" class="space-y-2">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-purple-400 mb-3"></i>
                    <p class="text-gray-600 font-medium">Carregando veículos disponíveis...</p>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
            <div class="flex justify-between items-center">
                <span id="vehicle-count" class="text-sm text-gray-500">Carregando...</span>
                <button type="button" class="btn-close-modal px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // =====================================================
    // CONFIGURAÇÕES E VARIÁVEIS
    // =====================================================
    var travelId = {{ travel.id }};
    var needsVehicle = {{ 'true' if travel.needs_vehicle else 'false' }};
    var travelDepartureDate = '{{ travel.departure_date if travel.departure_date else "" }}';
    var travelReturnDate = '{{ travel.return_date if travel.return_date else "" }}';
    var currentUserName = '{{ session.user_name if session.user_name else "" }}';
    {% if travel.vehicle %}
    var selectedVehicleId = {{ travel.vehicle.id }};
    var selectedVehicleInfo = '{{ travel.vehicle.brand }} {{ travel.vehicle.model }} ({{ travel.vehicle.plate }})';
    {% else %}
    var selectedVehicleId = null;
    var selectedVehicleInfo = null;
    {% endif %}
    var allVehicles = [];
    var deleteUserId = null;
    var deletePayoutId = null;

    // =====================================================
    // FUNÇÕES UTILITÁRIAS
    // =====================================================
    function parseMoneyValue(str) {
        if (!str) return 0;
        return parseFloat(str.replace('R$', '').replace(/\s/g, '').replace(/\./g, '').replace(',', '.')) || 0;
    }

    function formatMoney(value) {
        return 'R$ ' + value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function updateTotals() {
        var total = 0;
        $('.participant-total').each(function() {
            total += parseMoneyValue($(this).text());
        });
        var formatted = formatMoney(total);
        $('#total-payouts').text(formatted);
        $('#summary-total').text(formatted);
    }

    function openModal(id) {
        $('#' + id).removeClass('hidden');
    }

    function closeModal(id) {
        $('#' + id).addClass('hidden');
    }

    function toggleInputArea(userId) {
        var inputArea = $('.input-area[data-user-id="' + userId + '"]');
        inputArea.toggleClass('hidden');
        if (!inputArea.hasClass('hidden')) {
            var today = new Date().toISOString().split('T')[0];
            $('.payout-date-input[data-user-id="' + userId + '"]').val(today);
            $('.payout-value-input[data-user-id="' + userId + '"]').val('').focus();
            $('.payout-obs-input[data-user-id="' + userId + '"]').val('');
        }
    }

    function addPayoutInline(userId) {
        var date = $('.payout-date-input[data-user-id="' + userId + '"]').val();
        var valueStr = $('.payout-value-input[data-user-id="' + userId + '"]').val();
        var obs = $('.payout-obs-input[data-user-id="' + userId + '"]').val();

        if (!date) {
            showToast('Informe a data do repasse', 'error');
            return;
        }
        if (!valueStr || parseMoneyValue(valueStr) <= 0) {
            showToast('Informe um valor válido', 'error');
            return;
        }

        var value = parseMoneyValue(valueStr);
        var formattedValue = formatMoney(value);
        var dateParts = date.split('-');
        var formattedDate = dateParts[2] + '/' + dateParts[1] + '/' + dateParts[0];
        var now = new Date();
        var registeredAt = String(now.getDate()).padStart(2, '0') + '/' + String(now.getMonth() + 1).padStart(2, '0') + '/' + now.getFullYear() + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
        var tempId = Date.now();

        var newRow = '<tr class="hover:bg-gray-50 transition-colors" data-payout-id="' + tempId + '">' +
            '<td class="px-3 py-3"><span class="text-xs text-gray-600">' + registeredAt + '</span></td>' +
            '<td class="px-3 py-3"><span class="text-sm font-medium text-gray-900">' + formattedDate + '</span></td>' +
            '<td class="px-3 py-3"><span class="text-sm text-gray-700">' + (currentUserName || '-') + '</span></td>' +
            '<td class="px-3 py-3 text-right"><span class="text-sm font-bold text-green-600">' + formattedValue + '</span></td>' +
            '<td class="px-3 py-3"><span class="text-xs text-gray-500 italic">' + (obs || '-') + '</span></td>' +
            '<td class="px-3 py-3 text-center">' +
                '<button type="button" class="btn-delete-payout inline-flex items-center justify-center gap-1.5 px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 border border-red-200 rounded-md transition-all text-xs font-medium whitespace-nowrap" data-user-id="' + userId + '" data-payout-id="' + tempId + '">' +
                    '<i class="fas fa-trash text-[10px]"></i> Excluir' +
                '</button>' +
            '</td>' +
        '</tr>';

        var tbody = $('.payouts-table[data-user-id="' + userId + '"]');
        tbody.find('td[colspan="6"]').closest('tr').remove();
        tbody.prepend(newRow);

        var countEl = $('.participant-count[data-user-id="' + userId + '"]');
        countEl.text((parseInt(countEl.text()) || 0) + 1);

        var totalEl = $('.participant-total[data-user-id="' + userId + '"]');
        totalEl.text(formatMoney(parseMoneyValue(totalEl.text()) + value));

        updateTotals();
        toggleInputArea(userId);
    }

    function closeDeletePopover() {
        $('#delete-popover').addClass('hidden');
        deleteUserId = null;
        deletePayoutId = null;
    }

    function loadVehicles() {
        var url = '{{ url_for("admin.get_available_vehicles_api") }}' +
            '?departure_date=' + encodeURIComponent(travelDepartureDate) +
            '&return_date=' + encodeURIComponent(travelReturnDate) +
            '&travel_id=' + travelId;

        $.get(url, function(response) {
            if (response.success && response.vehicles && response.vehicles.length > 0) {
                allVehicles = response.vehicles;
                renderVehicles(allVehicles);
                $('#vehicle-count').text(allVehicles.length + ' veículo(s) disponível(is)');
            } else {
                $('#vehicles-list').html('<div class="text-center py-8"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fas fa-car text-gray-400 text-xl"></i></div><p class="text-gray-600 font-medium">Nenhum veículo disponível</p></div>');
                $('#vehicle-count').text('0 veículos');
            }
        }).fail(function() {
            $('#vehicles-list').html('<div class="text-center py-8"><i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-3"></i><p class="text-red-600 font-medium">Erro ao carregar veículos</p></div>');
        });
    }

    function renderVehicles(vehicles) {
        var container = $('#vehicles-list');
        if (vehicles.length === 0) {
            container.html('<div class="text-center py-8"><i class="fas fa-search text-gray-300 text-2xl mb-2"></i><p class="text-gray-500">Nenhum veículo encontrado</p></div>');
            return;
        }

        var html = '';
        vehicles.forEach(function(vehicle) {
            var isReserved = vehicle.reserved === true;
            var isSelected = selectedVehicleId === vehicle.id;
            var cardClass = 'vehicle-option p-4 border-2 rounded-xl transition-all ';
            if (isReserved) {
                cardClass += 'border-gray-200 bg-gray-50 cursor-not-allowed opacity-60';
            } else if (isSelected) {
                cardClass += 'border-purple-500 bg-purple-50 cursor-pointer';
            } else {
                cardClass += 'border-gray-200 hover:border-purple-300 hover:bg-purple-50 cursor-pointer';
            }

            html += '<div class="' + cardClass + '" data-vehicle-id="' + vehicle.id + '" data-brand="' + vehicle.brand + '" data-model="' + vehicle.model + '" data-plate="' + vehicle.plate + '" data-year="' + vehicle.year + '" data-reserved="' + isReserved + '">' +
                '<div class="flex items-center justify-between">' +
                    '<div class="flex items-center">' +
                        '<div class="w-12 h-12 ' + (isSelected ? 'bg-purple-100' : 'bg-gray-100') + ' rounded-lg flex items-center justify-center mr-4">' +
                            '<i class="fas fa-car ' + (isSelected ? 'text-purple-900' : 'text-gray-600') + '"></i>' +
                        '</div>' +
                        '<div>' +
                            '<p class="text-sm font-bold ' + (isReserved ? 'text-gray-400' : 'text-gray-900') + '">' + vehicle.brand + ' ' + vehicle.model + '</p>' +
                            '<p class="text-xs ' + (isReserved ? 'text-gray-400' : 'text-gray-500') + '">Placa: ' + vehicle.plate + ' | Ano: ' + vehicle.year + '</p>' +
                            (isReserved ? '<p class="text-xs text-red-500 mt-1"><i class="fas fa-lock mr-1"></i>Reservado</p>' : '') +
                        '</div>' +
                    '</div>' +
                    (isSelected ? '<i class="fas fa-check-circle text-purple-900 text-xl"></i>' : '') +
                '</div>' +
            '</div>';
        });
        container.html(html);
    }

    function selectVehicle(id, name, plate, year) {
        selectedVehicleId = id;
        selectedVehicleInfo = name + ' (' + plate + ')';
        renderVehicles(allVehicles);
        $('#no-vehicle-display').addClass('hidden');

        if ($('#selected-vehicle-display').length === 0) {
            var vehicleHtml = '<div id="selected-vehicle-display" class="flex items-center gap-4 py-4 px-5 border border-purple-200 rounded-lg bg-purple-50/50">' +
                '<svg class="w-14 h-14 text-purple-900 flex-shrink-0" viewBox="0 0 640 640" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M199.2 181.4L173.1 256L466.9 256L440.8 181.4C436.3 168.6 424.2 160 410.6 160L229.4 160C215.8 160 203.7 168.6 199.2 181.4zM103.6 260.8L138.8 160.3C152.3 121.8 188.6 96 229.4 96L410.6 96C451.4 96 487.7 121.8 501.2 160.3L536.4 260.8C559.6 270.4 576 293.3 576 320L576 512C576 529.7 561.7 544 544 544L512 544C494.3 544 480 529.7 480 512L480 480L160 480L160 512C160 529.7 145.7 544 128 544L96 544C78.3 544 64 529.7 64 512L64 320C64 293.3 80.4 270.4 103.6 260.8zM192 368C192 350.3 177.7 336 160 336C142.3 336 128 350.3 128 368C128 385.7 142.3 400 160 400C177.7 400 192 385.7 192 368zM480 400C497.7 400 512 385.7 512 368C512 350.3 497.7 336 480 336C462.3 336 448 350.3 448 368C448 385.7 462.3 400 480 400z"/></svg>' +
                '<div class="flex-1">' +
                    '<h2 id="selected-vehicle-name" class="text-sm font-bold text-gray-800 uppercase">' + name + '</h2>' +
                    '<p id="selected-vehicle-info" class="text-gray-500 text-xs">Placa: ' + plate + ' | Ano: ' + year + '</p>' +
                '</div>' +
                '<button type="button" class="btn-open-vehicle-modal px-4 py-2 bg-purple-900 text-white rounded-lg text-sm font-semibold hover:bg-purple-800 transition-all inline-flex items-center flex-shrink-0"><i class="fas fa-exchange-alt mr-2"></i>Alterar</button>' +
            '</div>';
            $('#no-vehicle-display').after(vehicleHtml);
        } else {
            $('#selected-vehicle-display').removeClass('hidden');
            $('#selected-vehicle-name').text(name);
            $('#selected-vehicle-info').text('Placa: ' + plate + ' | Ano: ' + year);
        }

        $('#modal-vehicle').addClass('hidden');
        $('#summary-vehicle').html('<i class="fas fa-check-circle text-green-600 mr-1"></i>' + selectedVehicleInfo).removeClass('text-gray-500').addClass('text-purple-700');
        $('#vehicle_id_field').val(id);
    }

    function collectFinancialData() {
        $('#financial-hidden-fields').empty();
        $('.financial-input').each(function() {
            var name = $(this).attr('name');
            var rawValue = $(this).val();
            var backendValue = rawValue.replace(/\./g, '').replace(',', '.');
            $('#financial-hidden-fields').append('<input type="hidden" name="' + name + '" value="' + backendValue + '">');
        });
        var notes = $('#admin_notes').val();
        $('#financial-hidden-fields').append('<input type="hidden" name="admin_notes" value="' + notes + '">');
    }

    // =====================================================
    // EVENT HANDLERS (jQuery event delegation)
    // =====================================================

    // Toggle seções (Info, Veículo, Financeiro)
    $(document).on('click', '.btn-toggle-section', function() {
        var sectionId = $(this).data('section');
        var section = $('#' + sectionId);
        var icon = $('#' + sectionId + '-icon');
        section.toggleClass('collapsed');
        icon.toggleClass('fa-chevron-up fa-chevron-down');
    });

    // Toggle accordion de participante
    $(document).on('click', '.btn-toggle-accordion', function() {
        var userId = $(this).data('user-id');
        var content = $('.accordion-content[data-user-id="' + userId + '"]');
        var icon = $('.accordion-icon[data-user-id="' + userId + '"]');
        content.toggleClass('hidden');
        icon.toggleClass('rotate-180');
    });

    // Toggle área de input (botão +)
    $(document).on('click', '.btn-toggle-input', function() {
        var userId = $(this).data('user-id');
        toggleInputArea(userId);
    });

    // Cancelar input (botão X)
    $(document).on('click', '.btn-cancel-input', function() {
        var userId = $(this).data('user-id');
        toggleInputArea(userId);
    });

    // Adicionar payout
    $(document).on('click', '.btn-add-payout', function() {
        var userId = $(this).data('user-id');
        addPayoutInline(userId);
    });

    // Enter nos inputs adiciona o payout
    $(document).on('keypress', '.payout-date-input, .payout-value-input, .payout-obs-input', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            var userId = $(this).data('user-id');
            addPayoutInline(userId);
        }
    });

    // Deletar payout - abrir popover
    $(document).on('click', '.btn-delete-payout', function() {
        deleteUserId = $(this).data('user-id');
        deletePayoutId = $(this).data('payout-id');
        var popover = $('#delete-popover');
        var button = $(this);
        var rect = button[0].getBoundingClientRect();
        var popoverWidth = 256;
        var popoverHeight = 140; // Altura aproximada do popover

        // Centralizar horizontalmente em relação ao botão
        var left = rect.left + (rect.width / 2) - (popoverWidth / 2);

        // Posicionar acima do botão com espaço para a seta
        var top = rect.top - popoverHeight - 10;

        // Ajustar se sair da tela horizontalmente
        if (left < 10) left = 10;
        if (left + popoverWidth > window.innerWidth - 10) left = window.innerWidth - popoverWidth - 10;

        // Se não couber acima, mostrar abaixo (inverter seta seria necessário)
        if (top < 10) top = rect.bottom + 10;

        popover.css({ left: left + 'px', top: top + 'px' });
        popover.removeClass('hidden');
    });

    // Cancelar exclusão no popover
    $(document).on('click', '#btn-cancel-delete-popover', function() {
        closeDeletePopover();
    });

    // Confirmar exclusão no popover
    $(document).on('click', '#btn-confirm-delete-payout', function() {
        if (deleteUserId && deletePayoutId) {
            $('tr[data-payout-id="' + deletePayoutId + '"]').remove();
            var countEl = $('.participant-count[data-user-id="' + deleteUserId + '"]');
            countEl.text(Math.max(0, (parseInt(countEl.text()) || 0) - 1));

            var total = 0;
            $('.payouts-table[data-user-id="' + deleteUserId + '"] tr').each(function() {
                $(this).find('.text-green-600').each(function() {
                    var valueText = $(this).text();
                    if (valueText && valueText.includes('R$')) {
                        total += parseMoneyValue(valueText);
                    }
                });
            });
            $('.participant-total[data-user-id="' + deleteUserId + '"]').text(formatMoney(total));
            updateTotals();
            closeDeletePopover();
        }
    });

    // Fechar popover ao clicar fora
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#delete-popover').length && !$(e.target).closest('.btn-delete-payout').length) {
            closeDeletePopover();
        }
    });

    // Abrir modal de veículos
    $(document).on('click', '.btn-open-vehicle-modal', function(e) {
        e.preventDefault();
        $('#modal-vehicle').removeClass('hidden');
        loadVehicles();
    });

    // Fechar modais
    $(document).on('click', '.btn-close-modal', function() {
        $(this).closest('.fixed').addClass('hidden');
    });

    // Selecionar veículo (event delegation)
    $(document).on('click', '.vehicle-option', function() {
        var isReserved = $(this).data('reserved') === true || $(this).data('reserved') === 'true';
        if (isReserved) return;
        var id = $(this).data('vehicle-id');
        var brand = $(this).data('brand');
        var model = $(this).data('model');
        var plate = $(this).data('plate');
        var year = $(this).data('year');
        selectVehicle(id, brand + ' ' + model, plate, year);
    });

    // Busca de veículos
    $(document).on('keyup', '#vehicle-search', function() {
        var search = $(this).val().toLowerCase();
        var filtered = allVehicles.filter(function(v) {
            var text = (v.brand + ' ' + v.model + ' ' + v.plate).toLowerCase();
            return text.includes(search);
        });
        renderVehicles(filtered);
    });

    // Aprovar viagem
    $(document).on('click', '#btn-approve-travel', function() {
        if (needsVehicle && !selectedVehicleId) {
            $('#modal-vehicle-warning').removeClass('hidden');
            $('#btn-confirm-approve').prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
        } else {
            $('#modal-vehicle-warning').addClass('hidden');
            $('#btn-confirm-approve').prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
        }

        var hasZeroValues = false;
        $('.financial-input').each(function() {
            if (parseMoneyValue($(this).val()) === 0) {
                hasZeroValues = true;
            }
        });

        if (hasZeroValues) {
            $('#modal-approve-warning').removeClass('hidden');
        } else {
            $('#modal-approve-warning').addClass('hidden');
        }
        openModal('modal-approve');
    });

    // Confirmar aprovação
    $(document).on('click', '#btn-confirm-approve', function() {
        if (needsVehicle && !selectedVehicleId) {
            showToast('Selecione um veículo antes de aprovar', 'error');
            return;
        }
        collectFinancialData();
        $('#action-field').val('approve');
        $('#analyze-form').submit();
    });

    // Rejeitar viagem
    $(document).on('click', '#btn-reject-travel', function() {
        openModal('modal-reject');
    });

    // Confirmar rejeição
    $(document).on('click', '#btn-confirm-reject', function() {
        $('#action-field').val('reject');
        $('#analyze-form').submit();
    });

    // Cancelar viagem
    $(document).on('click', '#btn-cancel-travel', function() {
        if (confirm('Tem certeza que deseja cancelar esta viagem? Esta ação não pode ser desfeita.')) {
            window.location.href = '{{ url_for("admin.travels_cancel", travel_id=travel.id) }}';
        }
    });

    // =====================================================
    // INICIALIZAÇÃO
    // =====================================================
    $('.financial-input').mask('#.##0,00', { reverse: true, placeholder: '0,00' });
    $('.financial-input').on('keyup change', function() { updateTotals(); });
    updateTotals();

    if (needsVehicle && selectedVehicleId) {
        $('#vehicle_id_field').val(selectedVehicleId);
        $('#summary-vehicle').html('<i class="fas fa-check-circle text-green-600 mr-1"></i>' + selectedVehicleInfo).removeClass('text-gray-500').addClass('text-purple-700');
    }
});
</script>
{% endblock %}
